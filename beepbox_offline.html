<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>BeepBox</title>
	<meta name="description" content="BeepBox is an online tool for sketching and sharing chiptune melodies." />
	<meta name="keywords" content="chiptune, music, melody, composition, tool, square wave, NES, NSF, BeepBox, beepbox" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="format-detection" content="telephone=no" />
	<style type="text/css">
		body {
			margin: auto;
			background: #000;
			font-family: sans-serif;
			font-size: large;
			line-height: 1.3;
			color: #fff;
		}
		h1 {
			font-size: 30px;
			text-align: center;
		}
		.centerDiv {
			margin: 0px auto;
		}
		a {
			color: #98f;
		}
		#beepboxEditorContainer {
			min-height: 645px;
		}
		
		/* wide screen */
		@media (min-width: 701px) {
			body {
				width: 700px;
			}
			.column-container {
				display: flex;
				justify-content: space-between;
			}
			/* .instructions-column {
				width: 375px;
			}
			.twitter-column {
				width: 300px;
			} */
		}
		
		/* narrow screen */
		@media (max-width: 700px) {
			body {
				width: 100vw;
			}
			.column-container {
				display: flex;
				flex-direction: column;
				align-items: center;
			}
		}
	</style>
</head>

<body>
	<div id="beepboxEditorContainer" style="width: 700px; height: 645px;"></div>
	
	<h1>
		BeepBox Offline
	</h1>
	<p id="introduction">
		BeepBox is an online (and offline!) tool for sketching and sharing chiptune melodies. 
	</p>
	<p>
		All song data is packaged into the URL at the top of your browser. 
		When you make changes to the song, the URL is updated to reflect your changes. 
		When you are satisfied with your song, just copy and paste the URL to save and share your song! 
	</p>
	
	<div class="column-container">
		<div class="instructions-column">
			<h1>
				Instructions
			</h1>
			<p>
				You can add or remove notes by clicking on the gray rows at the top. 
				BeepBox automatically plays the notes out loud for you. Try it!
			</p>
			<p>
				Notes go into patterns, and you can edit one pattern at a time.
				Those numbered boxes at the bottom of the editor are the different patterns you can edit.
				<span id="bar-editing">
					Click the other boxes to move to a different part of the song, or click the arrows on the currently selected box to swap which pattern is played during that part of the song.
				</span>
			</p>
			<p>
				There are four rows of patterns that BeepBox can play simultaneously, and each row has its own set of patterns. 
				The first three rows can play melodies and the bottom row is for drums.
			</p>
			<p>
				The purple loop underneath the numbered boxes controls which part of the song is currently repeating. 
				Move the loop to listen to a different part of the song, or drag the ends to expand the loop to include the whole song. 
			</p>
			<div id="keyboard-instructions">
				<p>
					When BeepBox has focus (click on its interface above), you can use these keyboard shortcuts: <br/>
				</p>
				<ul>
					<li>Spacebar: Pause or Resume</li>
					<li>Z: Undo</li>
					<li>Y or Shift Z: Redo</li>
					<li>C: Copy the current pattern</li>
					<li>V: Paste the current pattern</li>
					<li>[ ]: Move the playhead backward and forward</li>
					<li>Arrow Keys: Change which bar is selected</li>
					<li>1-8: Reassign a pattern to the currently selected bar</li>
				</ul>
			</div>
			<p>
				In the pattern editor, you can click and drag horizontally on a note to adjust its duration.
				You can also click above or below an existing note to enable a rapid arpeggio/trill effect, oscillating between two or more simultaneous notes. 
			</p>
			<p>
				ADVANCED: Drag vertically from an existing note to bend its pitch, or drag vertically from above or below the note to adjust its volume.
			</p>
			<p>
				BeepBox has many more features. 
				Try playing with the buttons and menus on the right side to find out what it can do!
			</p>
			<h1>
				About
			</h1>
			<p>
				BeepBox is developed by <a href="http://www.johnnesky.com">John Nesky</a>. 
			</p>
			<p>
				BeepBox does not claim ownership over songs created with it, so original songs belong to their authors. 
			</p>
			<p>
				Neither John Nesky nor BeepBox assume responsibility for any copyrighted material played on BeepBox. No songs are ever received, recorded, or distributed by BeepBox's servers. All song data is contained in the URL after the hash (#) mark, and BeepBox running inside your browser converts that data into sound waves.
			</p>
			<p>
				You can download and use <a href="https://bitbucket.org/shaktool/beepbox">the source code</a> under the MIT license.
			</p>
		</div>
	</div>

	<script type="text/javascript">

if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent) ) {
	document.getElementById("introduction").innerHTML = "BeepBox is an online tool for sketching and sharing chiptune melodies. Make sure that your volume is turned up, then press the play button!";
	document.getElementById("keyboard-instructions").style.display = "none";
	document.getElementById("bar-editing").innerHTML = "Tap the other boxes to move to a different part of the song, or tap on the currently selected box to swap which pattern is played during that part of the song.";
}

var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},beepbox;!function(t){function e(t,e){for(var n=0;n<t.length;n++)t[n]*=e}function n(t){return!(!t||t&t-1)}function i(t){if(!n(t))throw new Error("FFT array length must be a power of 2.");return Math.round(Math.log(t)/Math.log(2))}function s(t){var e=t.length,n=i(e);if(n>16)throw new Error("FFT array length must not be greater than 2^16.");for(var s=16-n,a=0;e>a;a++){var r=void 0;if(r=(43690&a)>>1|(21845&a)<<1,r=(52428&r)>>2|(13107&r)<<2,r=(61680&r)>>4|(3855&r)<<4,r=(r>>8|(255&r)<<8)>>s,r>a){var o=t[a];t[a]=t[r],t[r]=o}}}function a(t){var e=t.length,n=i(e);if(4>e)throw new Error("FFT array length must be at least 4.");for(var a=n-1;a>=2;a--)for(var r=1<<a,o=r>>1,h=r<<1,l=2*Math.PI/h,c=Math.cos(l),u=Math.sin(l),p=2*c,d=0;e>d;d+=h){var g=d,b=g+o,f=g+r,m=f+o,v=f+r,C=t[g],P=t[f];t[g]=C+P,t[b]*=2,t[f]=C-P,t[m]*=2;for(var y=c,w=-u,x=1,A=0,M=1;o>M;M++){var B=g+M,L=f-M,N=f+M,E=v-M,k=t[B],S=t[L],I=t[N],F=t[E],D=k-S,R=I+F;t[B]=k+S,t[L]=F-I,t[N]=D*y-R*w,t[E]=R*y+D*w;var U=p*y-x,T=p*w-A;x=y,A=w,y=U,w=T}}for(var M=0;e>M;M+=4){var V=M+1,Y=M+2,W=M+3,k=t[M],S=2*t[V],Z=t[Y],G=2*t[W],D=k+Z,R=k-Z;t[M]=D+S,t[V]=D-S,t[Y]=R+G,t[W]=R-G}s(t)}t.scaleElementsByFactor=e,t.inverseRealFourierTransform=a}(beepbox||(beepbox={}));var beepbox;!function(t){function e(t,e,n){return{interval:t,time:e,volume:n}}function n(t,n,i,s,a){return void 0===a&&(a=!1),{pitches:[t],pins:[e(0,0,s),e(0,i-n,a?0:s)],start:n,end:i}}var i=function(){function e(){}return e.a=function(t){for(var e=0,n=0;n<t.length;n++)e+=t[n];for(var i=e/t.length,n=0;n<t.length;n++)t[n]-=i;return new Float64Array(t)},e.getDrumWave=function(n){var i=e.c[n];if(null==i)if(i=new Float32Array(32768),e.c[n]=i,0==n)for(var s=1,a=0;32768>a;a++){i[a]=2*(1&s)-1;var r=s>>1;1==(s+r&1)&&(r+=16384),s=r}else if(1==n)for(var a=0;32768>a;a++)i[a]=2*Math.random()-1;else if(2==n)for(var s=1,a=0;32768>a;a++){i[a]=2*(1&s)-1;var r=s>>1;1==(s+r&1)&&(r+=32768),s=r}else if(3==n)for(var s=1,a=0;32768>a;a++){i[a]=2*(1&s)-1;var r=s>>1;1==(s+r&1)&&(r+=40),s=r}else{if(4!=n)throw new Error("Unrecognized drum index: "+n);for(var a=1024;2048>a;a++){var o=2,h=Math.random()*Math.PI*2;i[a]=Math.cos(h)*o,i[32768-a]=Math.sin(h)*o}for(var a=2048;16384>a;a++){var o=.25,h=Math.random()*Math.PI*2;i[a]=Math.cos(h)*o,i[32768-a]=Math.sin(h)*o}t.inverseRealFourierTransform(i),t.scaleElementsByFactor(i,1/Math.sqrt(i.length))}return i},e}();i.scaleNames=["easy :)","easy :(","island :)","island :(","blues :)","blues :(","normal :)","normal :(","dbl harmonic :)","dbl harmonic :(","enigma","expert"],i.scaleFlags=[[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1],[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0],[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1],[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1],[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1],[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!1,!0],[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0],[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],i.pianoScaleFlags=[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],i.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],i.pitchNames=["C",null,"D",null,"E","F",null,"G",null,"A",null,"B"],i.keyNames=["B","A♯","A","G♯","G","F♯","F","E","D♯","D","C♯","C"],i.keyTransposes=[23,22,21,20,19,18,17,16,15,14,13,12],i.tempoSteps=15,i.reverbRange=4,i.beatsPerBarMin=3,i.beatsPerBarMax=16,i.barCountMin=1,i.barCountMax=128,i.patternsPerChannelMin=1,i.patternsPerChannelMax=64,i.instrumentsPerChannelMin=1,i.instrumentsPerChannelMax=10,i.partNames=["÷3 (triplets)","÷4 (standard)","÷6","÷8"],i.partCounts=[3,4,6,8],i.waveNames=["triangle","square","pulse wide","pulse narrow","sawtooth","double saw","double pulse","spiky","plateau"],i.waveVolumes=[1,.5,.5,.5,.65,.5,.4,.4,.94],i.drumNames=["retro","white","clang","buzz","hollow"],i.drumVolumes=[.25,1,.4,.3,1.5],i.drumPitchRoots=[69,69,69,69,96],i.drumPitchFilterMult=[100,8,100,100,1],i.drumWaveIsSoft=[!1,!0,!1,!1,!0],i.filterNames=["sustain sharp","sustain medium","sustain soft","decay sharp","decay medium","decay soft"],i.filterBases=[2,3.5,5,1,2.5,4],i.filterDecays=[0,0,0,10,7,4],i.filterVolumes=[.4,.7,1,.5,.75,1],i.envelopeNames=["seamless","sudden","smooth","slide"],i.effectNames=["none","vibrato light","vibrato delayed","vibrato heavy","tremolo light","tremolo heavy"],i.effectVibratos=[0,.15,.3,.45,0,0],i.effectTremolos=[0,0,0,0,.25,.5],i.effectVibratoDelays=[0,0,3,0,0,0],i.chorusNames=["union","shimmer","hum","honky tonk","dissonant","fifths","octaves","bowed","custom harmony"],i.chorusIntervals=[0,.02,.05,.1,.25,3.5,6,.02,.05],i.chorusOffsets=[0,0,0,0,0,3.5,6,0,0],i.chorusVolumes=[.7,.8,1,1,.9,.9,.8,1,1],i.chorusHarmonizes=[!1,!1,!1,!1,!1,!1,!1,!1,!0],i.volumeNames=["loudest","loud","medium","quiet","quietest","mute"],i.volumeValues=[0,.5,1,1.5,2,-1],i.pitchChannelColorsDim=["#0099a1","#a1a100","#c75000","#00a100","#d020d0","#7777b0"],i.pitchChannelColorsBright=["#25f3ff","#ffff25","#ff9752","#50ff50","#ff90ff","#a0a0ff"],i.pitchNoteColorsDim=["#00bdc7","#c7c700","#ff771c","#00c700","#e040e0","#8888d0"],i.pitchNoteColorsBright=["#92f9ff","#ffff92","#ffcdab","#a0ffa0","#ffc0ff","#d0d0ff"],i.drumChannelColorsDim=["#6f6f6f","#996633"],i.drumChannelColorsBright=["#aaaaaa","#ddaa77"],i.drumNoteColorsDim=["#aaaaaa","#cc9966"],i.drumNoteColorsBright=["#eeeeee","#f0d0bb"],i.midiPitchChannelNames=["cyan channel","yellow channel","orange channel","green channel","purple channel","blue channel"],i.midiDrumChannelNames=["gray channel","brown channel"],i.midiSustainInstruments=[71,80,70,68,81,81,81,81,74],i.midiDecayInstruments=[46,46,6,24,25,25,106,106,33],i.drumInterval=6,i.drumCount=12,i.pitchCount=37,i.maxPitch=84,i.pitchChannelCountMin=1,i.pitchChannelCountMax=6,i.drumChannelCountMin=0,i.drumChannelCountMax=2,i.waves=[i.a([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-0.2,-5/15,-7/15,-0.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-0.6,-7/15,-5/15,-0.2,-1/15]),i.a([1,-1]),i.a([1,-1,-1,-1]),i.a([1,-1,-1,-1,-1,-1,-1,-1]),i.a([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31]),i.a([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2]),i.a([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1]),i.a([1,-1,1,-1,1,0]),i.a([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2])],i.c=[null,null,null,null,null],t.Config=i;var s=function(){function t(t,e,n,i){this.e=[],this.f=0;for(var s=n;i>s;s++){var a=t[e.charCodeAt(s)];this.e.push(a>>5&1),this.e.push(a>>4&1),this.e.push(a>>3&1),this.e.push(a>>2&1),this.e.push(a>>1&1),this.e.push(1&a)}}return t.prototype.read=function(t){for(var e=0;t>0;)e<<=1,e+=this.e[this.f++],t--;return e},t.prototype.readLongTail=function(t,e){for(var n=t,i=e;this.e[this.f++];)n+=1<<i,i++;for(;i>0;)i--,this.e[this.f++]&&(n+=1<<i);return n},t.prototype.readPartDuration=function(){return this.readLongTail(1,2)},t.prototype.readPinCount=function(){return this.readLongTail(1,0)},t.prototype.readPitchInterval=function(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)},t}(),a=function(){function t(){this.e=[]}return t.prototype.write=function(t,e){for(t--;t>=0;)this.e.push(e>>>t&1),t--},t.prototype.writeLongTail=function(t,e,n){if(t>n)throw new Error("value out of bounds");n-=t;for(var i=e;n>=1<<i;)this.e.push(1),n-=1<<i,i++;for(this.e.push(0);i>0;)i--,this.e.push(n>>>i&1)},t.prototype.writePartDuration=function(t){this.writeLongTail(1,2,t)},t.prototype.writePinCount=function(t){this.writeLongTail(1,0,t)},t.prototype.writePitchInterval=function(t){0>t?(this.write(1,1),this.writeLongTail(1,3,-t)):(this.write(1,0),this.writeLongTail(1,3,t))},t.prototype.concat=function(t){this.e=this.e.concat(t.e)},t.prototype.encodeBase64=function(t,e){for(var n=0;n<this.e.length;n+=6){var i=this.e[n]<<5|this.e[n+1]<<4|this.e[n+2]<<3|this.e[n+3]<<2|this.e[n+4]<<1|this.e[n+5];e.push(t[i])}return e},t.prototype.lengthBase64=function(){return Math.ceil(this.e.length/6)},t}();t.makeNotePin=e,t.makeNote=n;var r=function(){function t(){this.notes=[],this.instrument=0}return t.prototype.cloneNotes=function(){for(var t=[],i=0,s=this.notes;i<s.length;i++){var a=s[i],r=n(-1,a.start,a.end,3);r.pitches=a.pitches.concat(),r.pins=[];for(var o=0,h=a.pins;o<h.length;o++){var l=h[o];r.pins.push(e(l.interval,l.time,l.volume))}t.push(r)}return t},t.prototype.reset=function(){this.notes.length=0,this.instrument=0},t}();t.Pattern=r;var o=function(){function t(){this.wave=1,this.filter=0,this.envelope=1,this.effect=0,this.chorus=0,this.volume=0}return t.prototype.reset=function(){this.wave=1,this.filter=0,this.envelope=1,this.effect=0,this.chorus=0,this.volume=0},t}();t.Instrument=o;var h=function(){function t(){this.octave=0,this.instruments=[],this.patterns=[],this.bars=[]}return t}();t.Channel=h;var l=function(){function t(t){this.channels=[],void 0!=t?this.fromBase64String(t):this.initToDefault()}return t.prototype.getChannelCount=function(){return this.pitchChannelCount+this.drumChannelCount},t.prototype.getChannelIsDrum=function(t){return t>=this.pitchChannelCount},t.prototype.getChannelColorDim=function(t){return t<this.pitchChannelCount?i.pitchChannelColorsDim[t]:i.drumChannelColorsDim[t-this.pitchChannelCount]},t.prototype.getChannelColorBright=function(t){return t<this.pitchChannelCount?i.pitchChannelColorsBright[t]:i.drumChannelColorsBright[t-this.pitchChannelCount]},t.prototype.getNoteColorDim=function(t){return t<this.pitchChannelCount?i.pitchNoteColorsDim[t]:i.drumNoteColorsDim[t-this.pitchChannelCount]},t.prototype.getNoteColorBright=function(t){return t<this.pitchChannelCount?i.pitchNoteColorsBright[t]:i.drumNoteColorsBright[t-this.pitchChannelCount]},t.prototype.initToDefault=function(){this.scale=0,this.key=i.keyNames.length-1,this.loopStart=0,this.loopLength=4,this.tempo=7,this.reverb=0,this.beatsPerBar=8,this.barCount=16,this.patternsPerChannel=8,this.partsPerBeat=4,this.instrumentsPerChannel=1,this.pitchChannelCount=3,this.drumChannelCount=1;for(var t=0;t<this.getChannelCount();t++){this.channels.length<=t&&(this.channels[t]=new h);var e=this.channels[t];e.octave=3-t;for(var n=0;n<this.patternsPerChannel;n++)e.patterns.length<=n?e.patterns[n]=new r:e.patterns[n].reset();e.patterns.length=this.patternsPerChannel;for(var s=0;s<this.instrumentsPerChannel;s++)e.instruments.length<=s?e.instruments[s]=new o:e.instruments[s].reset();e.instruments.length=this.instrumentsPerChannel;for(var a=0;a<this.barCount;a++)e.bars[a]=1;e.bars.length=this.barCount}this.channels.length=this.getChannelCount()},t.prototype.toBase64String=function(){var e,n=[],s=t.g;n.push(s[t.h]),n.push(110,s[this.pitchChannelCount],s[this.drumChannelCount]),n.push(115,s[this.scale]),n.push(107,s[this.key]),n.push(108,s[this.loopStart>>6],s[63&this.loopStart]),n.push(101,s[this.loopLength-1>>6],s[this.loopLength-1&63]),n.push(116,s[this.tempo]),n.push(109,s[this.reverb]),n.push(97,s[this.beatsPerBar-1]),n.push(103,s[this.barCount-1>>6],s[this.barCount-1&63]),n.push(106,s[this.patternsPerChannel-1]),n.push(105,s[this.instrumentsPerChannel-1]),n.push(114,s[i.partCounts.indexOf(this.partsPerBeat)]),n.push(119);for(var r=0;r<this.getChannelCount();r++)for(var o=0;o<this.instrumentsPerChannel;o++)n.push(s[this.channels[r].instruments[o].wave]);n.push(102);for(var r=0;r<this.getChannelCount();r++)for(var o=0;o<this.instrumentsPerChannel;o++)n.push(s[this.channels[r].instruments[o].filter]);n.push(100);for(var r=0;r<this.getChannelCount();r++)for(var o=0;o<this.instrumentsPerChannel;o++)n.push(s[this.channels[r].instruments[o].envelope]);n.push(99);for(var r=0;r<this.getChannelCount();r++)for(var o=0;o<this.instrumentsPerChannel;o++)n.push(s[this.channels[r].instruments[o].effect]);n.push(104);for(var r=0;r<this.getChannelCount();r++)for(var o=0;o<this.instrumentsPerChannel;o++)n.push(s[this.channels[r].instruments[o].chorus]);n.push(118);for(var r=0;r<this.getChannelCount();r++)for(var o=0;o<this.instrumentsPerChannel;o++)n.push(s[this.channels[r].instruments[o].volume]);n.push(111);for(var r=0;r<this.getChannelCount();r++)n.push(s[this.channels[r].octave]);n.push(98),e=new a;for(var h=0;1<<h<this.patternsPerChannel+1;)h++;for(var r=0;r<this.getChannelCount();r++)for(var o=0;o<this.barCount;o++)e.write(h,this.channels[r].bars[o]);e.encodeBase64(s,n),n.push(112),e=new a;for(var l=0;1<<l<this.instrumentsPerChannel;)l++;for(var r=0;r<this.getChannelCount();r++){for(var c=this.getChannelIsDrum(r),u=c?0:12*this.channels[r].octave,p=(c?4:12)+u,d=c?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],g=[],o=0;o<d.length;o++)d[o]+=u;for(var b=0,f=this.channels[r].patterns;b<f.length;b++){var m=f[b];if(e.write(l,m.instrument),m.notes.length>0){e.write(1,1);for(var v=0,C=0,P=m.notes;C<P.length;C++){var y=P[C];y.start>v&&(e.write(2,0),e.writePartDuration(y.start-v));for(var w=new a,o=1;o<y.pitches.length;o++)w.write(1,1);y.pitches.length<4&&w.write(1,0),w.writePinCount(y.pins.length-1),w.write(2,y.pins[0].volume);for(var x=0,A=y.pitches[0],M=A,B=[],o=1;o<y.pins.length;o++){var L=y.pins[o],N=A+L.interval;M!=N?(w.write(1,1),B.push(N),M=N):w.write(1,0),w.writePartDuration(L.time-x),x=L.time,w.write(2,L.volume)}var E=String.fromCharCode.apply(null,w.encodeBase64(s,[])),k=g.indexOf(E);-1==k?(e.write(2,1),e.concat(w)):(e.write(1,1),e.writeLongTail(0,0,k),g.splice(k,1)),g.unshift(E),g.length>10&&g.pop();for(var S=y.pitches.concat(B),o=0;o<S.length;o++){var I=S[o],F=d.indexOf(I);if(-1==F){var D=0,R=p;if(I>R)for(;R!=I;)R++,-1==d.indexOf(R)&&D++;else for(;R!=I;)R--,-1==d.indexOf(R)&&D--;e.write(1,0),e.writePitchInterval(D)}else e.write(1,1),e.write(3,F),d.splice(F,1);d.unshift(I),d.length>8&&d.pop(),p=o==y.pitches.length-1?y.pitches[0]:I}v=y.end}v<this.beatsPerBar*this.partsPerBeat&&(e.write(2,0),e.writePartDuration(this.beatsPerBar*this.partsPerBeat-v))}else e.write(1,0)}}for(var U=e.lengthBase64(),T=[];U>0;)T.unshift(s[63&U]),U>>=6;return n.push(s[T.length]),Array.prototype.push.apply(n,T),e.encodeBase64(s,n),String.fromCharCode.apply(null,n)},t.prototype.fromBase64String=function(a){if(null==a)return void this.initToDefault();for(var l=0;a.charCodeAt(l)<=32;)l++;if(35==a.charCodeAt(l)&&l++,123==a.charCodeAt(l))return void this.fromJsonObject(JSON.parse(0==l?a:a.substring(l)));this.initToDefault();var c=t.i[a.charCodeAt(l++)];if(!(-1==c||c>t.h||c<t.j)){var u=3>c,p=4>c,d=5>c,g=t.i;if(u){for(var b=0,f=this.channels;b<f.length;b++){var m=f[b];m.instruments[0].envelope=0}this.channels[3].instruments[0].wave=0}for(;l<a.length;){var v=a.charCodeAt(l++),m=void 0;if(110==v){this.pitchChannelCount=g[a.charCodeAt(l++)],this.drumChannelCount=g[a.charCodeAt(l++)],this.pitchChannelCount=t.k(i.pitchChannelCountMin,i.pitchChannelCountMax+1,this.pitchChannelCount),this.drumChannelCount=t.k(i.drumChannelCountMin,i.drumChannelCountMax+1,this.drumChannelCount);for(var C=this.channels.length;C<this.getChannelCount();C++)this.channels[C]=new h;this.channels.length=this.getChannelCount()}else if(115==v)this.scale=g[a.charCodeAt(l++)],u&&10==this.scale&&(this.scale=11);else if(107==v)this.key=g[a.charCodeAt(l++)];else if(108==v)d?this.loopStart=g[a.charCodeAt(l++)]:this.loopStart=(g[a.charCodeAt(l++)]<<6)+g[a.charCodeAt(l++)];else if(101==v)d?this.loopLength=g[a.charCodeAt(l++)]:this.loopLength=(g[a.charCodeAt(l++)]<<6)+g[a.charCodeAt(l++)]+1;else if(116==v)p?this.tempo=[1,4,7,10][g[a.charCodeAt(l++)]]:this.tempo=g[a.charCodeAt(l++)],this.tempo=t.k(0,i.tempoSteps,this.tempo);else if(109==v)this.reverb=g[a.charCodeAt(l++)],this.reverb=t.k(0,i.reverbRange,this.reverb);else if(97==v)u?this.beatsPerBar=[6,7,8,9,10][g[a.charCodeAt(l++)]]:this.beatsPerBar=g[a.charCodeAt(l++)]+1,this.beatsPerBar=Math.max(i.beatsPerBarMin,Math.min(i.beatsPerBarMax,this.beatsPerBar));else if(103==v){this.barCount=(g[a.charCodeAt(l++)]<<6)+g[a.charCodeAt(l++)]+1,this.barCount=Math.max(i.barCountMin,Math.min(i.barCountMax,this.barCount));for(var P=0;P<this.getChannelCount();P++){for(var y=this.channels[P].bars.length;y<this.barCount;y++)this.channels[P].bars[y]=1;this.channels[P].bars.length=this.barCount}}else if(106==v){this.patternsPerChannel=g[a.charCodeAt(l++)]+1,this.patternsPerChannel=Math.max(i.patternsPerChannelMin,Math.min(i.patternsPerChannelMax,this.patternsPerChannel));for(var w=0;w<this.getChannelCount();w++){for(var x=this.channels[w].patterns.length;x<this.patternsPerChannel;x++)this.channels[w].patterns[x]=new r;this.channels[w].patterns.length=this.patternsPerChannel}}else if(105==v){this.instrumentsPerChannel=g[a.charCodeAt(l++)]+1,this.instrumentsPerChannel=Math.max(i.instrumentsPerChannelMin,Math.min(i.instrumentsPerChannelMax,this.instrumentsPerChannel));for(var A=0;A<this.getChannelCount();A++){for(var M=this.channels[A].instruments.length;M<this.instrumentsPerChannel;M++)this.channels[A].instruments[M]=new o;this.channels[A].instruments.length=this.instrumentsPerChannel}}else if(114==v)this.partsPerBeat=i.partCounts[g[a.charCodeAt(l++)]];else if(119==v)if(u)m=g[a.charCodeAt(l++)],this.channels[m].instruments[0].wave=t.k(0,i.waveNames.length,g[a.charCodeAt(l++)]);else for(m=0;m<this.getChannelCount();m++)for(var B=m>=this.pitchChannelCount,L=0;L<this.instrumentsPerChannel;L++)this.channels[m].instruments[L].wave=t.k(0,B?i.drumNames.length:i.waveNames.length,g[a.charCodeAt(l++)]);else if(102==v)if(u)m=g[a.charCodeAt(l++)],this.channels[m].instruments[0].filter=[0,2,3,5][t.k(0,i.filterNames.length,g[a.charCodeAt(l++)])];else for(m=0;m<this.getChannelCount();m++)for(var L=0;L<this.instrumentsPerChannel;L++)this.channels[m].instruments[L].filter=t.k(0,i.filterNames.length,g[a.charCodeAt(l++)]);else if(100==v)if(u)m=g[a.charCodeAt(l++)],this.channels[m].instruments[0].envelope=t.k(0,i.envelopeNames.length,g[a.charCodeAt(l++)]);else for(m=0;m<this.getChannelCount();m++)for(var L=0;L<this.instrumentsPerChannel;L++)this.channels[m].instruments[L].envelope=t.k(0,i.envelopeNames.length,g[a.charCodeAt(l++)]);else if(99==v)if(u){m=g[a.charCodeAt(l++)];var N=t.k(0,i.effectNames.length,g[a.charCodeAt(l++)]);1==N?N=3:3==N&&(N=5),this.channels[m].instruments[0].effect=N}else for(m=0;m<this.getChannelCount();m++)for(var L=0;L<this.instrumentsPerChannel;L++)this.channels[m].instruments[L].effect=t.k(0,i.effectNames.length,g[a.charCodeAt(l++)]);else if(104==v)if(u)m=g[a.charCodeAt(l++)],this.channels[m].instruments[0].chorus=t.k(0,i.chorusNames.length,g[a.charCodeAt(l++)]);else for(m=0;m<this.getChannelCount();m++)for(var L=0;L<this.instrumentsPerChannel;L++)this.channels[m].instruments[L].chorus=t.k(0,i.chorusNames.length,g[a.charCodeAt(l++)]);else if(118==v)if(u)m=g[a.charCodeAt(l++)],this.channels[m].instruments[0].volume=t.k(0,i.volumeNames.length,g[a.charCodeAt(l++)]);else for(m=0;m<this.getChannelCount();m++)for(var L=0;L<this.instrumentsPerChannel;L++)this.channels[m].instruments[L].volume=t.k(0,i.volumeNames.length,g[a.charCodeAt(l++)]);else if(111==v)if(u)m=g[a.charCodeAt(l++)],this.channels[m].octave=t.k(0,5,g[a.charCodeAt(l++)]);else for(m=0;m<this.getChannelCount();m++)this.channels[m].octave=t.k(0,5,g[a.charCodeAt(l++)]);else if(98==v){var E=void 0;if(u){m=g[a.charCodeAt(l++)];var k=g[a.charCodeAt(l++)];E=Math.ceil(.5*k);for(var S=new s(g,a,l,l+E),L=0;k>L;L++)this.channels[m].bars[L]=S.read(3)+1}else if(d){for(var I=0;1<<I<this.patternsPerChannel;)I++;E=Math.ceil(this.getChannelCount()*this.barCount*I/6);var S=new s(g,a,l,l+E);for(m=0;m<this.getChannelCount();m++)for(var L=0;L<this.barCount;L++)this.channels[m].bars[L]=S.read(I)+1}else{for(var I=0;1<<I<this.patternsPerChannel+1;)I++;E=Math.ceil(this.getChannelCount()*this.barCount*I/6);var S=new s(g,a,l,l+E);for(m=0;m<this.getChannelCount();m++)for(var L=0;L<this.barCount;L++)this.channels[m].bars[L]=S.read(I)}l+=E}else if(112==v){var F=0;if(u)m=g[a.charCodeAt(l++)],l++,F=g[a.charCodeAt(l++)],F<<=6,F+=g[a.charCodeAt(l++)];else{m=0;for(var D=g[a.charCodeAt(l++)];D>0;)F<<=6,F+=g[a.charCodeAt(l++)],D--}var S=new s(g,a,l,l+F);l+=F;for(var R=0;1<<R<this.instrumentsPerChannel;)R++;for(;;){for(var U=this.getChannelIsDrum(m),T=U?0:12*this.channels[m].octave,V=null,Y=null,W=(U?4:12)+T,Z=U?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],G=[],L=0;L<Z.length;L++)Z[L]+=T;for(var L=0;L<this.patternsPerChannel;L++){var z=this.channels[m].patterns[L];if(z.instrument=S.read(R),u||0!=S.read(1))for(var O=0,j=z.notes;O<this.beatsPerBar*this.partsPerBeat;){var J=1==S.read(1),X=!1,Q=0;if(J?Q=S.readLongTail(0,0):X=1==S.read(1),J||X){var H=void 0,q=void 0,_=void 0;if(J)H=G[Q],G.splice(Q,1);else{for(H={},H.pitchCount=1;H.pitchCount<4&&1==S.read(1);)H.pitchCount++;H.pinCount=S.readPinCount(),H.initialVolume=S.read(2),H.pins=[],H.length=0,H.bendCount=0;for(var K=0;K<H.pinCount;K++)q={},q.pitchBend=1==S.read(1),q.pitchBend&&H.bendCount++,H.length+=S.readPartDuration(),q.time=H.length,q.volume=S.read(2),H.pins.push(q)}G.unshift(H),G.length>10&&G.pop(),V=n(0,O,O+H.length,H.initialVolume),V.pitches=[],V.pins.length=1;for(var $=[],K=0;K<H.pitchCount+H.bendCount;K++){var tt=1==S.read(1);if(tt){var et=S.read(3);_=Z[et],Z.splice(et,1)}else{var nt=S.readPitchInterval();_=W;for(var it=nt;it>0;){for(_++;-1!=Z.indexOf(_);)_++;it--}for(;0>it;){for(_--;-1!=Z.indexOf(_);)_--;it++}}Z.unshift(_),Z.length>8&&Z.pop(),K<H.pitchCount?V.pitches.push(_):$.push(_),W=K==H.pitchCount-1?V.pitches[0]:_}$.unshift(V.pitches[0]);for(var st=0,at=H.pins;st<at.length;st++){var rt=at[st];rt.pitchBend&&$.shift(),Y=e($[0]-V.pitches[0],rt.time,rt.volume),V.pins.push(Y)}O=V.end,j.push(V)}else{var ot=S.readPartDuration();O+=ot}}}if(u)break;if(m++,m>=this.getChannelCount())break}}}}},t.prototype.toJsonObject=function(e,n,s){void 0===e&&(e=!0),void 0===n&&(n=1),void 0===s&&(s=!0);for(var a=[],r=0;r<this.getChannelCount();r++){for(var o=[],h=this.getChannelIsDrum(r),l=0;l<this.instrumentsPerChannel;l++){var c=this.channels[r].instruments[l];h?o.push({volume:20*(5-c.volume),wave:i.drumNames[c.wave],envelope:i.envelopeNames[c.envelope]}):o.push({volume:20*(5-c.volume),wave:i.waveNames[c.wave],envelope:i.envelopeNames[c.envelope],filter:i.filterNames[c.filter],chorus:i.chorusNames[c.chorus],effect:i.effectNames[c.effect]})}for(var u=[],p=0,d=this.channels[r].patterns;p<d.length;p++){for(var g=d[p],b=[],f=0,m=g.notes;f<m.length;f++){for(var v=m[f],C=[],P=0,y=v.pins;P<y.length;P++){var w=y[P];C.push({tick:w.time+v.start,pitchBend:w.interval,volume:Math.round(100*w.volume/3)})}b.push({pitches:v.pitches,points:C})}u.push({instrument:g.instrument+1,notes:b})}var x=[];if(e)for(var l=0;l<this.loopStart;l++)x.push(this.channels[r].bars[l]);for(var A=0;n>A;A++)for(var l=this.loopStart;l<this.loopStart+this.loopLength;l++)x.push(this.channels[r].bars[l]);if(s)for(var l=this.loopStart+this.loopLength;l<this.barCount;l++)x.push(this.channels[r].bars[l]);a.push({octaveScrollBar:this.channels[r].octave,instruments:o,patterns:u,sequence:x,type:h?"drum":"pitch"})}return{format:t.l,version:t.h,scale:i.scaleNames[this.scale],key:i.keyNames[this.key],introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beatsPerBar,ticksPerBeat:this.partsPerBeat,beatsPerMinute:this.getBeatsPerMinute(),reverb:this.reverb,channels:a}},t.prototype.fromJsonObject=function(s){if(this.initToDefault(),s){var a=s.version;if(5===a){if(this.scale=11,void 0!=s.scale){var l={"romani :)":8,"romani :(":9},c=void 0!=l[s.scale]?l[s.scale]:i.scaleNames.indexOf(s.scale);-1!=c&&(this.scale=c)}if(void 0!=s.key)if("number"==typeof s.key)this.key=i.keyNames.length-1-(s.key+1200>>>0)%i.keyNames.length;else if("string"==typeof s.key){var u=s.key,p=u.charAt(0).toUpperCase(),d=u.charAt(1).toLowerCase(),g={C:11,D:9,E:7,F:6,G:4,A:2,B:0},b={"#":-1,"♯":-1,b:1,"♭":1},f=g[p],m=b[d];void 0!=f&&(void 0!=m&&(f+=m),0>f&&(f+=12),f%=12,this.key=f)}if(void 0!=s.beatsPerMinute){var v=0|s.beatsPerMinute;this.tempo=Math.round(4+9*Math.log(v/120)/Math.LN2),this.tempo=t.k(0,i.tempoSteps,this.tempo)}void 0!=s.reverb&&(this.reverb=t.k(0,i.reverbRange,0|s.reverb)),void 0!=s.beatsPerBar&&(this.beatsPerBar=Math.max(i.beatsPerBarMin,Math.min(i.beatsPerBarMax,0|s.beatsPerBar))),void 0!=s.ticksPerBeat&&(this.partsPerBeat=0|s.ticksPerBeat,-1==i.partCounts.indexOf(this.partsPerBeat)&&(this.partsPerBeat=i.partCounts[i.partCounts.length-1]));var C=1,P=1,y=1;if(s.channels)for(var w=0,x=s.channels;w<x.length;w++){var A=x[w];A.instruments&&(C=Math.max(C,0|A.instruments.length)),A.patterns&&(P=Math.max(P,0|A.patterns.length)),A.sequence&&(y=Math.max(y,0|A.sequence.length))}this.instrumentsPerChannel=C,this.patternsPerChannel=P,this.barCount=y,void 0!=s.introBars&&(this.loopStart=t.k(0,this.barCount,0|s.introBars)),void 0!=s.loopBars&&(this.loopLength=t.k(1,this.barCount-this.loopStart+1,0|s.loopBars));var M=0,B=0;if(s.channels)for(var L=0;L<s.channels.length;L++){var A=s.channels[L];this.channels.length<=L&&(this.channels[L]=new h),void 0!=A.octaveScrollBar&&(this.channels[L].octave=t.k(0,5,0|A.octaveScrollBar));for(var N=this.channels[L].instruments.length;N<this.instrumentsPerChannel;N++)this.channels[L].instruments[N]=new o;this.channels[L].instruments.length=this.instrumentsPerChannel;for(var N=this.channels[L].patterns.length;N<this.patternsPerChannel;N++)this.channels[L].patterns[N]=new r;this.channels[L].patterns.length=this.patternsPerChannel;for(var N=0;N<this.barCount;N++)this.channels[L].bars[N]=1;this.channels[L].bars.length=this.barCount;var E=!1;E=A.type?"drum"==A.type:L>=3,E?B++:M++;for(var N=0;N<this.instrumentsPerChannel;N++){var k=this.channels[L].instruments[N],S=void 0;A.instruments&&(S=A.instruments[N]),void 0==S&&(S={}),void 0!=S.volume?k.volume=t.k(0,i.volumeNames.length,Math.round(5-(0|S.volume)/20)):k.volume=0;var I={binary:0};k.envelope=void 0!=I[S.envelope]?I[S.envelope]:i.envelopeNames.indexOf(S.envelope),-1==k.envelope&&(k.envelope=1),E?(k.wave=i.drumNames.indexOf(S.wave),-1==k.wave&&(k.wave=1)):(k.wave=i.waveNames.indexOf(S.wave),-1==k.wave&&(k.wave=1),k.filter=i.filterNames.indexOf(S.filter),-1==k.filter&&(k.filter=0),k.chorus=i.chorusNames.indexOf(S.chorus),-1==k.chorus&&(k.chorus=0),k.effect=i.effectNames.indexOf(S.effect),-1==k.effect&&(k.effect=0))}for(var N=0;N<this.patternsPerChannel;N++){var F=this.channels[L].patterns[N],D=void 0;if(A.patterns&&(D=A.patterns[N]),void 0!=D&&(F.instrument=t.k(0,this.instrumentsPerChannel,(0|D.instrument)-1),D.notes&&D.notes.length>0))for(var R=Math.min(this.beatsPerBar*this.partsPerBeat,D.notes.length>>>0),U=0,T=0;T<D.notes.length&&!(T>=R);T++){var V=D.notes[T];if(V&&V.pitches&&V.pitches.length>=1&&V.points&&V.points.length>=2){var Y=n(0,0,0,0);Y.pitches=[],Y.pins=[];for(var W=0;W<V.pitches.length;W++){var Z=0|V.pitches[W];if(-1==Y.pitches.indexOf(Z)&&(Y.pitches.push(Z),Y.pitches.length>=4))break}if(!(Y.pitches.length<1)){for(var G=U,z=0,W=0;W<V.points.length;W++){var O=V.points[W];if(void 0!=O&&void 0!=O.tick){var j=void 0==O.pitchBend?0:0|O.pitchBend,J=0|O.tick,X=void 0==O.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|O.volume)/100)));if(!(J>this.beatsPerBar*this.partsPerBeat)){if(0==Y.pins.length){if(G>J)continue;Y.start=J,z=j}else if(G>=J)continue;G=J,Y.pins.push(e(j-z,J-Y.start,X))}}}if(!(Y.pins.length<2)){Y.end=Y.pins[Y.pins.length-1].time+Y.start;for(var Q=E?i.drumCount-1:i.maxPitch,H=Q,q=0,W=0;W<Y.pitches.length;W++)Y.pitches[W]+=z,(Y.pitches[W]<0||Y.pitches[W]>Q)&&(Y.pitches.splice(W,1),W--),Y.pitches[W]<H&&(H=Y.pitches[W]),Y.pitches[W]>q&&(q=Y.pitches[W]);if(!(Y.pitches.length<1)){for(var W=0;W<Y.pins.length;W++){var _=Y.pins[W];_.interval+H<0&&(_.interval=-H),_.interval+q>Q&&(_.interval=Q-q),W>=2&&_.interval==Y.pins[W-1].interval&&_.interval==Y.pins[W-2].interval&&_.volume==Y.pins[W-1].volume&&_.volume==Y.pins[W-2].volume&&(Y.pins.splice(W-1,1),W--)}F.notes.push(Y),U=Y.end}}}}}}for(var N=0;N<this.barCount;N++)this.channels[L].bars[N]=A.sequence?Math.min(this.patternsPerChannel,A.sequence[N]>>>0):0}this.pitchChannelCount=M,this.drumChannelCount=B,this.channels.length=this.getChannelCount()}}},t.k=function(t,e,n){return e-=1,e>=n?n>=t?n:t:e},t.prototype.getPattern=function(t,e){var n=this.channels[t].bars[e];return 0==n?null:this.channels[t].patterns[n-1]},t.prototype.getPatternInstrument=function(t,e){var n=this.getPattern(t,e);return null==n?0:n.instrument},t.prototype.getBeatsPerMinute=function(){return Math.round(120*Math.pow(2,(-4+this.tempo)/9))},t}();l.l="BeepBox",l.j=2,l.h=5,l.i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0],l.g=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],t.Song=l;var c=function(){function t(t){void 0===t&&(t=null);var e=this;this.samplesPerSecond=44100,this.effectDuration=.14,this.effectAngle=2*Math.PI/(this.effectDuration*this.samplesPerSecond),this.effectYMult=2*Math.cos(this.effectAngle),this.limitDecay=1/(2*this.samplesPerSecond),this.song=null,this.pianoPressed=!1,this.pianoPitch=0,this.pianoChannel=0,this.enableIntro=!0,this.enableOutro=!1,this.loopCount=-1,this.volume=1,this.playheadInternal=0,this.bar=0,this.beat=0,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=0,this.paused=!0,this.channelPhaseA=[0,0,0,0],this.channelPhaseB=[0,0,0,0],this.channelSample=[0,0,0,0],this.drumPhase=0,this.drumSample=0,this.stillGoing=!1,this.effectPhase=0,this.limit=0,this.delayLine=new Float32Array(16384),this.delayPos=0,this.delayFeedback0=0,this.delayFeedback1=0,this.delayFeedback2=0,this.delayFeedback3=0,this.audioProcessCallback=function(t){var n=t.outputBuffer,i=n.getChannelData(0);e.synthesize(i,n.length)},null!=t&&this.setSong(t)}return t.ensureGeneratedSynthesizerAndDrumWavesExist=function(e){if(null!=e){for(var n=0;n<e.instrumentsPerChannel;n++)for(var s=e.pitchChannelCount;s<e.pitchChannelCount+e.drumChannelCount;s++)i.getDrumWave(e.channels[s].instruments[n].wave);t.getGeneratedSynthesizer(e.pitchChannelCount,e.drumChannelCount)}},Object.defineProperty(t.prototype,"playing",{get:function(){return!this.paused},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"playhead",{get:function(){return this.playheadInternal},set:function(t){if(null!=this.song){this.playheadInternal=Math.max(0,Math.min(this.song.barCount,t));var e=this.playheadInternal;this.bar=Math.floor(e),e=this.song.beatsPerBar*(e-this.bar),this.beat=Math.floor(e),e=this.song.partsPerBeat*(e-this.beat),this.part=Math.floor(e),e=4*(e-this.part),this.arpeggio=Math.floor(e);var n=this.getSamplesPerArpeggio();e=n*(e-this.arpeggio),this.arpeggioSampleCountdown=Math.floor(n-e),this.bar<this.song.loopStart&&(this.enableIntro=!0),this.bar>this.song.loopStart+this.song.loopLength&&(this.enableOutro=!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalSamples",{get:function(){if(null==this.song)return 0;var t=4*this.getSamplesPerArpeggio()*this.song.partsPerBeat*this.song.beatsPerBar,e=this.loopCount;0>e&&(e=1);var n=this.song.loopLength*e;return this.enableIntro&&(n+=this.song.loopStart),this.enableOutro&&(n+=this.song.barCount-(this.song.loopStart+this.song.loopLength)),n*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalSeconds",{get:function(){return this.totalSamples/this.samplesPerSecond},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalBars",{get:function(){return null==this.song?0:this.song.barCount},enumerable:!0,configurable:!0}),t.prototype.setSong=function(t){
"string"==typeof t?this.song=new l(t):t instanceof l&&(this.song=t)},t.prototype.play=function(){if(this.paused){this.paused=!1,t.ensureGeneratedSynthesizerAndDrumWavesExist(this.song);var e=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;this.audioCtx=this.audioCtx||new e,this.scriptNode=this.audioCtx.createScriptProcessor?this.audioCtx.createScriptProcessor(2048,0,1):this.audioCtx.createJavaScriptNode(2048,0,1),this.scriptNode.onaudioprocess=this.audioProcessCallback,this.scriptNode.channelCountMode="explicit",this.scriptNode.channelInterpretation="speakers",this.scriptNode.connect(this.audioCtx.destination),this.samplesPerSecond=this.audioCtx.sampleRate,this.effectAngle=2*Math.PI/(this.effectDuration*this.samplesPerSecond),this.effectYMult=2*Math.cos(this.effectAngle),this.limitDecay=1/(2*this.samplesPerSecond)}},t.prototype.pause=function(){this.paused||(this.paused=!0,this.scriptNode.disconnect(this.audioCtx.destination),this.audioCtx.close&&(this.audioCtx.close(),this.audioCtx=null),this.scriptNode=null)},t.prototype.snapToStart=function(){this.bar=0,this.enableIntro=!0,this.snapToBar()},t.prototype.snapToBar=function(t){void 0!==t&&(this.bar=t),this.playheadInternal=this.bar,this.beat=0,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=0,this.effectPhase=0,this.channelSample[0]=0,this.channelSample[1]=0,this.channelSample[2]=0,this.drumSample=0,this.delayPos=0,this.delayFeedback0=0,this.delayFeedback1=0,this.delayFeedback2=0,this.delayFeedback3=0;for(var e=0;e<this.delayLine.length;e++)this.delayLine[e]=0},t.prototype.nextBar=function(){if(this.song){var t=this.bar;this.bar++,this.enableOutro?this.bar>=this.song.barCount&&(this.bar=this.enableIntro?0:this.song.loopStart):(this.bar>=this.song.loopStart+this.song.loopLength||this.bar>=this.song.barCount)&&(this.bar=this.song.loopStart),this.playheadInternal+=this.bar-t}},t.prototype.prevBar=function(){if(this.song){var t=this.bar;this.bar--,this.bar<0&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.bar>=this.song.barCount&&(this.bar=this.song.barCount-1),this.bar<this.song.loopStart&&(this.enableIntro=!0),!this.enableOutro&&this.bar>=this.song.loopStart+this.song.loopLength&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.playheadInternal+=this.bar-t}},t.prototype.synthesize=function(e,n){if(null!=this.song){var i=this.song.getChannelCount();if(this.channelPhaseA.length!=i){for(var s=0;i>s;s++)this.channelPhaseA[s]=0;this.channelPhaseA.length=i}if(this.channelPhaseB.length!=i){for(var s=0;i>s;s++)this.channelPhaseB[s]=0;this.channelPhaseB.length=i}if(this.channelSample.length!=i){for(var s=0;i>s;s++)this.channelSample[s]=0;this.channelSample.length=i}var a=t.getGeneratedSynthesizer(this.song.pitchChannelCount,this.song.drumChannelCount);a(this,this.song,e,n)}else for(var s=0;n>s;s++)e[s]=0},t.computeChannelInstrument=function(t,e,n,s,a,r,o,h){var l=e.getPattern(n,t.bar),c=null==l?0:e.channels[n].instruments[l.instrument].envelope,u=h?i.drumPitchRoots[e.channels[n].instruments[null==l?0:l.instrument].wave]:i.keyTransposes[e.key],p=h?i.drumInterval:1,d=null,g=null,b=null;if(null!=l)for(var f=0;f<l.notes.length;f++)if(l.notes[f].end<=s)g=l.notes[f];else if(l.notes[f].start<=s&&l.notes[f].end>s)d=l.notes[f];else if(l.notes[f].start>s){b=l.notes[f];break}null!=d&&null!=g&&g.end!=d.start&&(g=null),null!=d&&null!=b&&b.start!=d.end&&(b=null);var m,v,C,P=1,y=0,w=1,x=1,A=1,M=!1;if(t.pianoPressed&&n==t.pianoChannel){var B=t.frequencyFromPitch(u+t.pianoPitch*p),L=l?l.instrument:0,N=void 0;h?i.drumWaveIsSoft[e.channels[n].instruments[L].wave]?(w=Math.min(1,B*a*i.drumPitchFilterMult[e.channels[n].instruments[l.instrument].wave]),N=24):N=60:N=48,m=B*a,v=Math.pow(2,-t.pianoPitch*p/N),C=Math.pow(2,i.effectVibratos[e.channels[n].instruments[L].effect]/12)-1}else if(null==d)m=0,P=0,v=0,C=0,M=!0;else{var E=i.chorusHarmonizes[e.channels[n].instruments[l.instrument].chorus],k=d.pitches[0];if(E){var S=0;2==d.pitches.length?S=d.pitches[1]-d.pitches[0]:3==d.pitches.length?S=d.pitches[(t.arpeggio>>1)+1]-d.pitches[0]:4==d.pitches.length&&(S=d.pitches[(3==t.arpeggio?1:t.arpeggio)+1]-d.pitches[0]),A=Math.pow(2,S/12)}else 2==d.pitches.length?k=d.pitches[t.arpeggio>>1]:3==d.pitches.length?k=d.pitches[3==t.arpeggio?1:t.arpeggio]:4==d.pitches.length&&(k=d.pitches[t.arpeggio]);var I=void 0;for(I=1;I<d.pins.length-1&&!(d.pins[I].time+d.start>s);I++);var F=d.pins[I-1],D=d.pins[I],R=4*d.start,U=4*d.end,T=4*(d.start+F.time),V=4*(d.start+D.time),Y=4*s+t.arpeggio,W=4*s+t.arpeggio+1,Z=(Y-T)/(V-T),G=(W-T)/(V-T),z=F.volume*(1-Z)+D.volume*Z,O=F.volume*(1-G)+D.volume*G,j=F.interval*(1-Z)+D.interval*Z,J=F.interval*(1-G)+D.interval*G,X=F.time*(1-Z)+D.time*Z,Q=F.time*(1-G)+D.time*G,H=!1;Y==R&&(0==c?H=!0:2==c?z=0:3==c&&(null==g?z=0:0==g.pins[g.pins.length-1].volume||0==d.pins[0].volume?z=0:(j=.5*(g.pitches[0]+g.pins[g.pins.length-1].interval-k),X=.5*g.pins[g.pins.length-1].time,H=!0))),W==U&&(1==c||2==c?O=0:3==c&&(null==b?O=0:0==d.pins[d.pins.length-1].volume||0==b.pins[0].volume?O=0:(J=.5*(b.pitches[0]+d.pins[d.pins.length-1].interval-k),Q*=.5)));var q=1-(t.arpeggioSampleCountdown+o)/r,_=1-t.arpeggioSampleCountdown/r,K=j*(1-q)+J*q,$=j*(1-_)+J*_,tt=X*(1-q)+Q*q,et=X*(1-_)+Q*_,nt=t.frequencyFromPitch(u+(k+K)*p),it=t.frequencyFromPitch(u+(k+$)*p),st=void 0;h?i.drumWaveIsSoft[e.channels[n].instruments[l.instrument].wave]?(w=Math.min(1,nt*a*i.drumPitchFilterMult[e.channels[n].instruments[l.instrument].wave]),st=24):st=60:st=48;var at=Math.pow(2,-(k+K)*p/st),rt=Math.pow(2,-(k+$)*p/st);at*=t.volumeConversion(z*(1-q)+O*q),rt*=t.volumeConversion(z*(1-_)+O*_);var ot=it/nt;m=nt*a,P=Math.pow(ot,1/o),v=at,y=(rt-at)/o;var ht=(Y+q-R)*r/t.samplesPerSecond;if(0!=ht||H||(M=!0),!h){var lt=i.filterDecays[e.channels[n].instruments[l.instrument].filter];w=Math.pow(2,-lt*tt*4*r/t.samplesPerSecond);var ct=Math.pow(2,-lt*et*4*r/t.samplesPerSecond);x=Math.pow(ct/w,1/o)}var ut=i.effectVibratoDelays[e.channels[n].instruments[l.instrument].effect];C=s-d.start<ut?0:Math.pow(2,i.effectVibratos[e.channels[n].instruments[l.instrument].effect]/12)-1}return{phaseDelta:m,phaseDeltaScale:P,noteVolume:v,volumeDelta:y,filter:w,filterScale:x,vibratoScale:C,harmonyMult:A,resetPhases:M}},t.getGeneratedSynthesizer=function(e,n){if(void 0==t.generatedSynthesizers[e]&&(t.generatedSynthesizers[e]=[]),void 0==t.generatedSynthesizers[e][n]){for(var i=[],s=0,a=t.synthSourceTemplate;s<a.length;s++){var r=a[s];if(-1!=r.indexOf("#"))if(-1!=r.indexOf("// PITCH"))for(var o=0;e>o;o++)i.push(r.replace(/#/g,o+""));else if(-1!=r.indexOf("// DRUM"))for(var o=e;e+n>o;o++)i.push(r.replace(/#/g,o+""));else{if(-1==r.indexOf("// ALL"))throw new Error("Missing channel type annotation for line: "+r);for(var o=0;e+n>o;o++)i.push(r.replace(/#/g,o+""))}else i.push(r)}t.generatedSynthesizers[e][n]=new Function("synth","song","data","totalSamples",i.join("\n"))}return t.generatedSynthesizers[e][n]},t.prototype.frequencyFromPitch=function(t){return 440*Math.pow(2,(t-69)/12)},t.prototype.volumeConversion=function(t){return Math.pow(t/3,1.5)},t.prototype.getSamplesPerArpeggio=function(){if(null==this.song)return 0;var t=this.song.getBeatsPerMinute(),e=t/60,n=e*this.song.partsPerBeat,i=4*n;return Math.floor(this.samplesPerSecond/i)},t}();c.generatedSynthesizers=[],c.synthSourceTemplate="\n			\n			var bufferIndex = 0;\n			\n			var sampleTime = 1.0 / synth.samplesPerSecond;\n			var samplesPerArpeggio = synth.getSamplesPerArpeggio();\n			var effectYMult = synth.effectYMult;\n			var limitDecay = synth.limitDecay;\n			var volume = synth.volume;\n			var delayLine = synth.delayLine;\n			var reverb = Math.pow(song.reverb / beepbox.Config.reverbRange, 0.667) * 0.425;\n			var ended = false;\n			\n			// Check the bounds of the playhead:\n			if (synth.arpeggioSampleCountdown == 0 || synth.arpeggioSampleCountdown > samplesPerArpeggio) {\n				synth.arpeggioSampleCountdown = samplesPerArpeggio;\n			}\n			if (synth.part >= song.partsPerBeat) {\n				synth.beat++;\n				synth.part = 0;\n				synth.arpeggio = 0;\n				synth.arpeggioSampleCountdown = samplesPerArpeggio;\n			}\n			if (synth.beat >= song.beatsPerBar) {\n				synth.bar++;\n				synth.beat = 0;\n				synth.part = 0;\n				synth.arpeggio = 0;\n				synth.arpeggioSampleCountdown = samplesPerArpeggio;\n				\n				if (synth.loopCount == -1) {\n					if (synth.bar < song.loopStart && !synth.enableIntro) synth.bar = song.loopStart;\n					if (synth.bar >= song.loopStart + song.loopLength && !synth.enableOutro) synth.bar = song.loopStart;\n				}\n			}\n			if (synth.bar >= song.barCount) {\n				if (synth.enableOutro) {\n					synth.bar = 0;\n					synth.enableIntro = true;\n					ended = true;\n					synth.pause();\n				} else {\n					synth.bar = song.loopStart;\n				}\n 			}\n			if (synth.bar >= song.loopStart) {\n				synth.enableIntro = false;\n			}\n			\n 			while (totalSamples > 0) {\n				if (ended) {\n					while (totalSamples-- > 0) {\n						data[bufferIndex] = 0.0;\n						bufferIndex++;\n					}\n					break;\n				}\n				\n				// Initialize instruments based on current pattern.\n				var instrumentChannel# = song.getPatternInstrument(#, synth.bar); // ALL\n				var maxChannel#Volume = 0.27 * (song.channels[#].instruments[instrumentChannel#].volume == 5 ? 0.0 : Math.pow(2, -beepbox.Config.volumeValues[song.channels[#].instruments[instrumentChannel#].volume])) * beepbox.Config.waveVolumes[song.channels[#].instruments[instrumentChannel#].wave] * beepbox.Config.filterVolumes[song.channels[#].instruments[instrumentChannel#].filter] * beepbox.Config.chorusVolumes[song.channels[#].instruments[instrumentChannel#].chorus] * 0.5; // PITCH\n				var maxChannel#Volume = 0.19 * (song.channels[#].instruments[instrumentChannel#].volume == 5 ? 0.0 : Math.pow(2, -beepbox.Config.volumeValues[song.channels[#].instruments[instrumentChannel#].volume])) * beepbox.Config.drumVolumes[song.channels[#].instruments[instrumentChannel#].wave]; // DRUM\n				var channel#Wave = beepbox.Config.waves[song.channels[#].instruments[instrumentChannel#].wave]; // PITCH\n				var channel#Wave = beepbox.Config.getDrumWave(song.channels[#].instruments[instrumentChannel#].wave); // DRUM\n				var channel#WaveLength = channel#Wave.length; // PITCH\n				var channel#FilterBase = Math.pow(2, -beepbox.Config.filterBases[song.channels[#].instruments[instrumentChannel#].filter]); // PITCH\n				var channel#TremoloScale = beepbox.Config.effectTremolos[song.channels[#].instruments[instrumentChannel#].effect]; // PITCH\n				\n				// Reuse initialized instruments until getting to the end of the sample period or the end of the current bar.\n				while (totalSamples > 0) {\n					var samples;\n					if (synth.arpeggioSampleCountdown <= totalSamples) {\n						samples = synth.arpeggioSampleCountdown;\n					} else {\n						samples = totalSamples;\n					}\n					totalSamples -= samples;\n					synth.arpeggioSampleCountdown -= samples;\n					\n					var time = synth.part + synth.beat * song.partsPerBeat;\n				\n					var channel#ChorusA = Math.pow(2.0, (beepbox.Config.chorusOffsets[song.channels[#].instruments[instrumentChannel#].chorus] + beepbox.Config.chorusIntervals[song.channels[#].instruments[instrumentChannel#].chorus]) / 12.0); // PITCH\n					var channel#ChorusB = Math.pow(2.0, (beepbox.Config.chorusOffsets[song.channels[#].instruments[instrumentChannel#].chorus] - beepbox.Config.chorusIntervals[song.channels[#].instruments[instrumentChannel#].chorus]) / 12.0); // PITCH\n					var channel#ChorusSign = (song.channels[#].instruments[instrumentChannel#].chorus == 7) ? -1.0 : 1.0; // PITCH\n					if (song.channels[#].instruments[instrumentChannel#].chorus == 0) synth.channelPhaseB[#] = synth.channelPhaseA[#]; // PITCH\n					\n					var channel#PhaseDelta = 0; // ALL\n					var channel#PhaseDeltaScale = 0; // ALL\n					var channel#Volume = 0; // ALL\n					var channel#VolumeDelta = 0; // ALL\n					var channel#Filter = 0; // ALL\n					var channel#FilterScale = 0; // PITCH\n					var channel#VibratoScale = 0; // PITCH\n					\n					var instrument# = beepbox.Synth.computeChannelInstrument(synth, song, #, time, sampleTime, samplesPerArpeggio, samples, false); // PITCH\n					var instrument# = beepbox.Synth.computeChannelInstrument(synth, song, #, time, sampleTime, samplesPerArpeggio, samples, true); // DRUM\n					\n					channel#PhaseDelta = instrument#.phaseDelta; // PITCH\n					channel#PhaseDelta = instrument#.phaseDelta / 32768.0; // DRUM\n					channel#PhaseDeltaScale = instrument#.phaseDeltaScale; // ALL\n					channel#Volume = instrument#.noteVolume * maxChannel#Volume; // ALL\n					channel#VolumeDelta = instrument#.volumeDelta * maxChannel#Volume; // ALL\n					channel#Filter = instrument#.filter * channel#FilterBase; // PITCH\n					channel#Filter = instrument#.filter; // DRUM\n					channel#FilterScale = instrument#.filterScale; // PITCH\n					channel#VibratoScale = instrument#.vibratoScale; // PITCH\n					channel#ChorusB *= instrument#.harmonyMult; // PITCH\n					if (instrument#.resetPhases) { synth.channelSample[#] = 0.0; synth.channelPhaseA[#] = 0.0; synth.channelPhaseB[#] = 0.0; } // PITCH\n					\n					var effectY     = Math.sin(synth.effectPhase);\n					var prevEffectY = Math.sin(synth.effectPhase - synth.effectAngle);\n					\n					var channel#PlayheadA = +synth.channelPhaseA[#]; // PITCH\n					var channel#PlayheadB = +synth.channelPhaseB[#]; // PITCH\n					var channel#Playhead  = +synth.channelPhaseA[#]; // DRUM\n					\n					var channel#Sample = +synth.channelSample[#]; // ALL\n					\n					var delayPos = 0|synth.delayPos;\n					var delayFeedback0 = +synth.delayFeedback0;\n					var delayFeedback1 = +synth.delayFeedback1;\n					var delayFeedback2 = +synth.delayFeedback2;\n					var delayFeedback3 = +synth.delayFeedback3;\n					var limit = +synth.limit;\n					\n					while (samples) {\n						var channel#Vibrato = 1.0 + channel#VibratoScale * effectY; // PITCH\n						var channel#Tremolo = 1.0 + channel#TremoloScale * (effectY - 1.0); // PITCH\n						var temp = effectY;\n						effectY = effectYMult * effectY - prevEffectY;\n						prevEffectY = temp;\n						\n						channel#Sample += ((channel#Wave[0|(channel#PlayheadA * channel#WaveLength)] + channel#Wave[0|(channel#PlayheadB * channel#WaveLength)] * channel#ChorusSign) * channel#Volume * channel#Tremolo - channel#Sample) * channel#Filter; // PITCH\n						channel#Sample += (channel#Wave[0|(channel#Playhead * 32768.0)] * channel#Volume - channel#Sample) * channel#Filter; // DRUM\n						channel#Volume += channel#VolumeDelta; // ALL\n						channel#PlayheadA += channel#PhaseDelta * channel#Vibrato * channel#ChorusA; // PITCH\n						channel#PlayheadB += channel#PhaseDelta * channel#Vibrato * channel#ChorusB; // PITCH\n						channel#Playhead += channel#PhaseDelta; // DRUM\n						channel#PhaseDelta *= channel#PhaseDeltaScale; // ALL\n						channel#Filter *= channel#FilterScale; // PITCH\n						channel#PlayheadA -= 0|channel#PlayheadA; // PITCH\n						channel#PlayheadB -= 0|channel#PlayheadB; // PITCH\n						channel#Playhead -= 0|channel#Playhead; // DRUM\n						\n						// Reverb, implemented using a feedback delay network with a Hadamard matrix and lowpass filters.\n						// good ratios:    0.555235 + 0.618033 + 0.818 +   1.0 = 2.991268\n						// Delay lengths:  3041     + 3385     + 4481  +  5477 = 16384 = 2^14\n						// Buffer offsets: 3041    -> 6426   -> 10907 -> 16384\n						var delayPos1 = (delayPos +  3041) & 0x3FFF;\n						var delayPos2 = (delayPos +  6426) & 0x3FFF;\n						var delayPos3 = (delayPos + 10907) & 0x3FFF;\n						var delaySample0 = delayLine[delayPos]\n							+ channel#Sample // PITCH\n						;\n						var delaySample1 = delayLine[delayPos1];\n						var delaySample2 = delayLine[delayPos2];\n						var delaySample3 = delayLine[delayPos3];\n						var delayTemp0 = -delaySample0 + delaySample1;\n						var delayTemp1 = -delaySample0 - delaySample1;\n						var delayTemp2 = -delaySample2 + delaySample3;\n						var delayTemp3 = -delaySample2 - delaySample3;\n						delayFeedback0 += ((delayTemp0 + delayTemp2) * reverb - delayFeedback0) * 0.5;\n						delayFeedback1 += ((delayTemp1 + delayTemp3) * reverb - delayFeedback1) * 0.5;\n						delayFeedback2 += ((delayTemp0 - delayTemp2) * reverb - delayFeedback2) * 0.5;\n						delayFeedback3 += ((delayTemp1 - delayTemp3) * reverb - delayFeedback3) * 0.5;\n						delayLine[delayPos1] = delayFeedback0;\n						delayLine[delayPos2] = delayFeedback1;\n						delayLine[delayPos3] = delayFeedback2;\n						delayLine[delayPos ] = delayFeedback3;\n						delayPos = (delayPos + 1) & 0x3FFF;\n						\n						var sample = delaySample0 + delaySample1 + delaySample2 + delaySample3\n							+ channel#Sample // DRUM\n						;\n						\n						var abs = sample < 0.0 ? -sample : sample;\n						limit -= limitDecay;\n						if (limit < abs) limit = abs;\n						sample /= limit * 0.75 + 0.25;\n						sample *= volume;\n						data[bufferIndex] = sample;\n						bufferIndex = bufferIndex + 1;\n						samples--;\n					}\n					\n					synth.channelPhaseA[#] = channel#PlayheadA; // PITCH\n					synth.channelPhaseB[#] = channel#PlayheadB; // PITCH\n					synth.channelPhaseA[#] = channel#Playhead; // DRUM\n					synth.channelSample[#] = channel#Sample; // ALL\n					\n					synth.delayPos = delayPos;\n					synth.delayFeedback0 = delayFeedback0;\n					synth.delayFeedback1 = delayFeedback1;\n					synth.delayFeedback2 = delayFeedback2;\n					synth.delayFeedback3 = delayFeedback3;\n					synth.limit = limit;\n					\n					if (effectYMult * effectY - prevEffectY > prevEffectY) {\n						synth.effectPhase = Math.asin(effectY);\n					} else {\n						synth.effectPhase = Math.PI - Math.asin(effectY);\n					}\n					\n					if (synth.arpeggioSampleCountdown == 0) {\n						synth.arpeggio++;\n						synth.arpeggioSampleCountdown = samplesPerArpeggio;\n						if (synth.arpeggio == 4) {\n							synth.arpeggio = 0;\n							synth.part++;\n							if (synth.part == song.partsPerBeat) {\n								synth.part = 0;\n								synth.beat++;\n								if (synth.beat == song.beatsPerBar) {\n									synth.beat = 0;\n									synth.effectPhase = 0.0;\n									synth.bar++;\n									if (synth.bar < song.loopStart) {\n										if (!synth.enableIntro) synth.bar = song.loopStart;\n									} else {\n										synth.enableIntro = false;\n									}\n									if (synth.bar >= song.loopStart + song.loopLength) {\n										if (synth.loopCount > 0) synth.loopCount--;\n										if (synth.loopCount > 0 || !synth.enableOutro) {\n											synth.bar = song.loopStart;\n										}\n									}\n									if (synth.bar >= song.barCount) {\n										synth.bar = 0;\n										synth.enableIntro = true;\n										ended = true;\n										synth.pause();\n									}\n									\n									// The bar changed, may need to reinitialize instruments.\n									break;\n								}\n							}\n						}\n					}\n				}\n			}\n			\n			synth.playheadInternal = (((synth.arpeggio + 1.0 - synth.arpeggioSampleCountdown / samplesPerArpeggio) / 4.0 + synth.part) / song.partsPerBeat + synth.beat) / song.beatsPerBar + synth.bar;\n		".split("\n"),t.Synth=c}(beepbox||(beepbox={}));var beepbox;!function(t){var e=function(){function t(){this.m=[],this.n=!1}return t.prototype.watch=function(t){-1==this.m.indexOf(t)&&this.m.push(t)},t.prototype.unwatch=function(t){var e=this.m.indexOf(t);-1!=e&&this.m.splice(e,1)},t.prototype.changed=function(){this.n=!0},t.prototype.notifyWatchers=function(){if(this.n){this.n=!1;for(var t=0,e=this.m.concat();t<e.length;t++){var n=e[t];n()}}},t}();t.ChangeNotifier=e}(beepbox||(beepbox={}));var beepbox;!function(t){var e=function(){function e(e){var n=this;this.history=this,this.notifier=new t.ChangeNotifier,this.channel=0,this.bar=0,this.volume=75,this.trackVisibleBars=16,this.barScrollPos=0,this.prompt=null,this.o=null,this.p=0,this.q=0,this.r=0,this.s=!1,this.t=!1,this.u=function(){var e=window.history.state;e&&e.sequenceNumber==n.p||(null==e?(n.p++,e={canUndo:!0,sequenceNumber:n.p,bar:n.bar,channel:n.channel,prompt:n.prompt},new t.ChangeSong(n,location.hash),window.history.replaceState(e,"","#"+n.song.toBase64String())):(e.sequenceNumber==n.p-1?(n.bar=n.q,n.channel=n.r):e.sequenceNumber!=n.p&&(n.bar=e.bar,n.channel=e.channel),n.p=e.sequenceNumber,n.prompt=e.prompt,new t.ChangeSong(n,location.hash)),n.q=e.bar,n.r=e.channel,n.forgetLastChange(),n.notifier.notifyWatchers())},this.v=function(){n.notifier.notifyWatchers()},this.w=function(){n.t=!1;var t,e="#"+n.song.toBase64String();n.s?(n.p++,t={canUndo:!0,sequenceNumber:n.p,bar:n.bar,channel:n.channel,prompt:n.prompt},window.history.pushState(t,"",e)):(t={canUndo:!0,sequenceNumber:n.p,bar:n.bar,channel:n.channel,prompt:n.prompt},window.history.replaceState(t,"",e)),n.q=t.bar,n.r=t.channel,n.s=!1},this.song=new t.Song(e),this.synth=new t.Synth(this.song),this.autoPlay="false"!=localStorage.getItem("autoPlay"),this.autoFollow="true"==localStorage.getItem("autoFollow"),this.showFifth="true"==localStorage.getItem("showFifth"),this.showLetters="true"==localStorage.getItem("showLetters"),this.showChannels="true"==localStorage.getItem("showChannels"),this.showScrollBar="true"==localStorage.getItem("showScrollBar"),null!=localStorage.getItem("volume")&&(this.volume=Number(localStorage.getItem("volume"))),this.synth.volume=this.z();var i=window.history.state;null==i&&(i={canUndo:!1,sequenceNumber:0,bar:0,channel:0,prompt:this.prompt},window.history.replaceState(i,"","#"+this.song.toBase64String())),window.addEventListener("hashchange",this.u),window.addEventListener("popstate",this.u),this.bar=i.bar,this.channel=i.channel,this.q=i.bar,this.r=i.channel,this.barScrollPos=Math.max(0,this.bar-(this.trackVisibleBars-6));for(var s=0,a=["input","change","click","keyup","keydown","mousedown","mousemove","mouseup","touchstart","touchmove","touchend","touchcancel"];s<a.length;s++){var r=a[s];window.addEventListener(r,this.v)}}return e.prototype.record=function(t,e){void 0===e&&(e=!1),t.isNoop()?(this.o=null,e&&window.history.back()):(this.o=t,this.s=this.s||!e,this.t||(window.requestAnimationFrame(this.w),this.t=!0))},e.prototype.openPrompt=function(t){this.prompt=t;var e="#"+this.song.toBase64String();this.p++;var n={canUndo:!0,sequenceNumber:this.p,bar:this.bar,channel:this.channel,prompt:this.prompt};window.history.pushState(n,"",e)},e.prototype.undo=function(){var t=window.history.state;t.canUndo&&window.history.back()},e.prototype.redo=function(){window.history.forward()},e.prototype.setProspectiveChange=function(t){this.o=t},e.prototype.forgetLastChange=function(){this.o=null},e.prototype.lastChangeWas=function(t){return null!=t&&t==this.o},e.prototype.savePreferences=function(){localStorage.setItem("autoPlay",this.autoPlay?"true":"false"),localStorage.setItem("autoFollow",this.autoFollow?"true":"false"),localStorage.setItem("showFifth",this.showFifth?"true":"false"),localStorage.setItem("showLetters",this.showLetters?"true":"false"),localStorage.setItem("showChannels",this.showChannels?"true":"false"),localStorage.setItem("showScrollBar",this.showScrollBar?"true":"false"),localStorage.setItem("volume",String(this.volume))},e.prototype.setVolume=function(t){this.volume=t,this.savePreferences(),this.synth.volume=this.z()},e.prototype.z=function(){return Math.min(1,Math.pow(this.volume/50,.5))*Math.pow(2,(this.volume-75)/25)},e.prototype.getCurrentPattern=function(){return this.song.getPattern(this.channel,this.bar)},e.prototype.getCurrentInstrument=function(){var t=this.getCurrentPattern();return null==t?0:t.instrument},e}();e.h=2,t.SongDocument=e}(beepbox||(beepbox={}));var beepbox;!function(t){function e(t,e,n){var s=document.createElementNS(i,t);if(e)for(var a=0,r=Object.keys(e);a<r.length;a++){var o=r[a];s.setAttribute(o,e[o])}if(n)for(var h=0,l=n;h<l.length;h++){var c=l[h];s.appendChild(c)}return s}var n;!function(t){function e(t,e,n){var i=document.createElement(t);if(e)for(var s=0,a=Object.keys(e);s<a.length;s++){var r=a[s];"style"==r?i.setAttribute(r,e[r]):i[r]=e[r]}if(n)for(var o=0,h=n;o<h.length;o++){var l=h[o];i.appendChild(l)}return i}function n(t,n){return e("button",t,n)}function i(t,n){return e("div",t,n)}function s(t,n){return e("span",t,n)}function a(t,n){return e("select",t,n)}function r(t,e,n,i){void 0===n&&(n=!1),void 0===i&&(i=!1);var s=document.createElement("option");return s.value=t,s.selected=n,s.disabled=i,s.appendChild(c(e)),s}function o(t){return e("canvas",t)}function h(t){return e("input",t)}function l(){return e("br")}function c(t){return document.createTextNode(t)}t.element=e,t.button=n,t.div=i,t.span=s,t.select=a,t.option=r,t.canvas=o,t.input=h,t.br=l,t.text=c}(n=t.html||(t.html={}));var i="http://www.w3.org/2000/svg";t.svgElement=e}(beepbox||(beepbox={}));var beepbox;!function(t){var e=document.createElement("style");e.type="text/css",e.appendChild(document.createTextNode('\n\n.beepboxEditor {\n	display: flex;\n	-webkit-touch-callout: none;\n	-webkit-user-select: none;\n	-khtml-user-select: none;\n	-moz-user-select: none;\n	-ms-user-select: none;\n	user-select: none;\n	position: relative;\n	touch-action: manipulation;\n	cursor: default;\n	font-size: small;\n	overflow: hidden;\n}\n\n.beepboxEditor div {\n	margin: 0;\n	padding: 0;\n}\n\n.beepboxEditor .promptContainer {\n	position: absolute;\n	top: 0;\n	left: 0;\n	width: 100%;\n	height: 100%;\n	background: rgba(0,0,0,0.5);\n	display: flex;\n	justify-content: center;\n	align-items: center;\n}\n\n.beepboxEditor .prompt {\n	margin: auto;\n	text-align: center;\n	background: #000;\n	border-radius: 15px;\n	border: 4px solid #444;\n	color: #fff;\n	padding: 20px;\n	display: flex;\n	flex-direction: column;\n}\n\n.beepboxEditor .prompt > *:not(:first-child) {\n	margin-top: 1.5em;\n}\n\n/* Use psuedo-elements to add cross-browser up & down arrows to select elements: */\n.beepboxEditor .selectContainer {\n	position: relative;\n}\n.beepboxEditor .selectContainer:not(.menu)::before {\n	content: "";\n	position: absolute;\n	right: 0.5em;\n	top: 0.4em;\n	border-bottom: 0.4em solid currentColor;\n	border-left: 0.3em solid transparent;\n	border-right: 0.3em solid transparent;\n	pointer-events: none;\n}\n.beepboxEditor .selectContainer:not(.menu)::after {\n	content: "";\n	position: absolute;\n	right: 0.5em;\n	bottom: 0.4em;\n	border-top: 0.4em solid currentColor;\n	border-left: 0.3em solid transparent;\n	border-right: 0.3em solid transparent;\n	pointer-events: none;\n}\n.beepboxEditor .selectContainer.menu::after {\n	content: "";\n	position: absolute;\n	right: 0.7em;\n	margin: auto;\n	top: 0;\n	bottom: 0;\n	height: 0;\n	border-top: 0.4em solid currentColor;\n	border-left: 0.3em solid transparent;\n	border-right: 0.3em solid transparent;\n	pointer-events: none;\n}\n.beepboxEditor select {\n	margin: 0;\n	padding: 0 0.5em;\n	display: block;\n	height: 2em;\n	border: none;\n	border-radius: 0.4em;\n	background: #444444;\n	color: inherit;\n	font-size: inherit;\n	cursor: pointer;\n\n	-webkit-appearance:none;\n	-moz-appearance: none;\n	appearance: none;\n}\n.beepboxEditor .menu select {\n	padding: 0 2em;\n}\n.beepboxEditor select:focus {\n	background: #777777;\n	outline: none;\n}\n.beepboxEditor .menu select {\n	text-align: center;\n	text-align-last: center;\n}\n\n/* This makes it look better in firefox on my computer... What about others?\n@-moz-document url-prefix() {\n	.beepboxEditor select { padding: 0 2px; }\n}\n*/\n.beepboxEditor button {\n	margin: 0;\n	position: relative;\n	height: 2em;\n	border: none;\n	border-radius: 0.4em;\n	background: #444;\n	color: inherit;\n	font-size: inherit;\n	cursor: pointer;\n}\n.beepboxEditor button:focus {\n	background: #777;\n	outline: none;\n}\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton {\n	padding-left: 2em;\n}\n.beepboxEditor button.playButton::before {\n	content: "";\n	position: absolute;\n	left: 0.7em;\n	top: 50%;\n	margin-top: -0.65em;\n	border-left: 1em solid currentColor;\n	border-top: 0.65em solid transparent;\n	border-bottom: 0.65em solid transparent;\n	pointer-events: none;\n}\n.beepboxEditor button.pauseButton::before {\n	content: "";\n	position: absolute;\n	left: 0.7em;\n	top: 50%;\n	margin-top: -0.65em;\n	width: 0.3em;\n	height: 1.3em;\n	background: currentColor;\n	pointer-events: none;\n}\n.beepboxEditor button.pauseButton::after {\n	content: "";\n	position: absolute;\n	left: 1.4em;\n	top: 50%;\n	margin-top: -0.65em;\n	width: 0.3em;\n	height: 1.3em;\n	background: currentColor;\n	pointer-events: none;\n}\n\n.beepboxEditor button.prevBarButton::before {\n	content: "";\n	position: absolute;\n	left: 50%;\n	top: 50%;\n	margin-left: -0.5em;\n	margin-top: -0.5em;\n	width: 0.2em;\n	height: 1em;\n	background: currentColor;\n	pointer-events: none;\n}\n.beepboxEditor button.prevBarButton::after {\n	content: "";\n	position: absolute;\n	left: 50%;\n	top: 50%;\n	margin-left: -0.3em;\n	margin-top: -0.5em;\n	border-right: 0.8em solid currentColor;\n	border-top: 0.5em solid transparent;\n	border-bottom: 0.5em solid transparent;\n	pointer-events: none;\n}\n\n.beepboxEditor button.nextBarButton::before {\n	content: "";\n	position: absolute;\n	left: 50%;\n	top: 50%;\n	margin-left: -0.5em;\n	margin-top: -0.5em;\n	border-left: 0.8em solid currentColor;\n	border-top: 0.5em solid transparent;\n	border-bottom: 0.5em solid transparent;\n	pointer-events: none;\n}\n.beepboxEditor button.nextBarButton::after {\n	content: "";\n	position: absolute;\n	left: 50%;\n	top: 50%;\n	margin-left: 0.3em;\n	margin-top: -0.5em;\n	width: 0.2em;\n	height: 1em;\n	background: currentColor;\n	pointer-events: none;\n}\n\n.beepboxEditor canvas {\n	overflow: hidden;\n	position: absolute;\n	display: block;\n}\n\n.beepboxEditor .trackContainer {\n	overflow-x: hidden;\n}\n\n.beepboxEditor .selectRow {\n	margin: 0;\n	height: 2.5em;\n	display: flex;\n	flex-direction: row;\n	align-items: center;\n	justify-content: space-between;\n}\n\n.beepboxEditor .selectRow > span {\n	color: #999;\n}\n\n.beepboxEditor .editor-widget-column {\n	display: flex;\n	flex-direction: column;\n}\n\n.beepboxEditor .editor-widgets {\n	display: flex;\n	flex-direction: column;\n}\n\n.beepboxEditor .editor-controls {\n	display: flex;\n	flex-direction: column;\n}\n\n.beepboxEditor .editor-menus {\n	display: flex;\n	flex-direction: column;\n}\n\n.beepboxEditor .editor-settings {\n	display: flex;\n	flex-direction: column;\n	flex-grow: 1;\n	justify-content: space-between;\n}\n\n.beepboxEditor .editor-song-settings {\n	display: flex;\n	flex-direction: column;\n}\n\n.beepboxEditor .editor-instrument-settings {\n	display: flex;\n	flex-direction: column;\n}\n\n.beepboxEditor .editor-right-side-top > *, .beepboxEditor .editor-right-side-bottom > * {\n	flex-shrink: 0;\n}\n\n.beepboxEditor input[type=text], .beepboxEditor input[type=number] {\n	font-size: inherit;\n	background: transparent;\n	border: 1px solid #777;\n	color: white;\n}\n\n.beepboxEditor input[type=checkbox] {\n  transform: scale(1.5);\n}\n\n.beepboxEditor input[type=range] {\n	-webkit-appearance: none;\n	color: inherit;\n	width: 100%;\n	height: 2em;\n	font-size: inherit;\n	margin: 0;\n	cursor: pointer;\n	background-color: black;\n	touch-action: pan-y;\n}\n.beepboxEditor input[type=range]:focus {\n	outline: none;\n}\n.beepboxEditor input[type=range]::-webkit-slider-runnable-track {\n	width: 100%;\n	height: 0.5em;\n	cursor: pointer;\n	background: #444;\n}\n.beepboxEditor input[type=range]::-webkit-slider-thumb {\n	height: 2em;\n	width: 0.5em;\n	border-radius: 0.25em;\n	background: currentColor;\n	cursor: pointer;\n	-webkit-appearance: none;\n	margin-top: -0.75em;\n}\n.beepboxEditor input[type=range]:focus::-webkit-slider-runnable-track {\n	background: #777;\n}\n.beepboxEditor input[type=range]::-moz-range-track {\n	width: 100%;\n	height: 0.5em;\n	cursor: pointer;\n	background: #444;\n}\n.beepboxEditor input[type=range]:focus::-moz-range-track {\n	background: #777;\n}\n.beepboxEditor input[type=range]::-moz-range-thumb {\n	height: 2em;\n	width: 0.5em;\n	border-radius: 0.25em;\n	border: none;\n	background: currentColor;\n	cursor: pointer;\n}\n.beepboxEditor input[type=range]::-ms-track {\n	width: 100%;\n	height: 0.5em;\n	cursor: pointer;\n	background: #444;\n	border-color: transparent;\n}\n.beepboxEditor input[type=range]:focus::-ms-track {\n	background: #777;\n}\n.beepboxEditor input[type=range]::-ms-thumb {\n	height: 2em;\n	width: 0.5em;\n	border-radius: 0.25em;\n	background: currentColor;\n	cursor: pointer;\n}\n\n/* wide screen */\n@media (min-width: 701px) {\n	#beepboxEditorContainer {\n		display: table;\n	}\n	.beepboxEditor {\n		flex-direction: row;\n	}\n	.beepboxEditor:focus-within {\n		outline: 3px solid #555;\n	}\n	.beepboxEditor .trackContainer {\n		width: 512px;\n	}\n	.beepboxEditor .trackSelectBox {\n		display: none;\n	}\n	.beepboxEditor .playback-controls {\n		display: flex;\n		flex-direction: column;\n	}\n	.beepboxEditor .playback-bar-controls {\n		display: flex;\n		flex-direction: row;\n		margin: .2em 0;\n	}\n	.beepboxEditor .playback-volume-controls {\n		display: flex;\n		flex-direction: row;\n		margin: .2em 0;\n		align-items: center;\n	}\n	.beepboxEditor .pauseButton, .beepboxEditor .playButton {\n		flex-grow: 1;\n	}\n	.beepboxEditor .nextBarButton, .beepboxEditor .prevBarButton {\n		flex-grow: 1;\n		margin-left: 10px;\n	}\n	.beepboxEditor .editor-widget-column {\n		margin-left: 6px;\n		width: 14em;\n		flex-direction: column;\n	}\n	.beepboxEditor .editor-widgets {\n		flex-grow: 1;\n	}\n	.beepboxEditor .editor-settings input, .beepboxEditor .editor-settings select {\n		width: 9em;\n	}\n	.beepboxEditor .editor-menus > * {\n		flex-grow: 1;\n		margin: .2em 0;\n	}\n	.beepboxEditor .editor-menus > button {\n		padding: 0 2em;\n		white-space: nowrap;\n	}\n}\n\n/* narrow screen */\n@media (max-width: 700px) {\n	.beepboxEditor {\n		flex-direction: column;\n	}\n	.beepboxEditor:focus-within {\n		outline: none;\n	}\n	.beepboxEditor .editorBox {\n		max-height: 75vh;\n	}\n	.beepboxEditor .editor-menus {\n		flex-direction: row;\n	}\n	.beepboxEditor .editor-menus > * {\n		flex-grow: 1;\n		margin: .2em;\n	}\n	.beepboxEditor .editor-menus > button {\n		padding-left: 2em;\n		white-space: nowrap;\n	}\n	.beepboxEditor .trackContainer {\n		overflow-x: auto;\n	}\n	.beepboxEditor .barScrollBar {\n		display: none;\n	}\n	.beepboxEditor .playback-controls {\n		display: flex;\n		flex-direction: row;\n		margin: .2em 0;\n	}\n	.beepboxEditor .playback-bar-controls {\n		display: flex;\n		flex-direction: row;\n		flex-grow: 1;\n	}\n	.beepboxEditor .playback-volume-controls {\n		display: flex;\n		flex-direction: row;\n		align-items: center;\n		flex-grow: 1;\n		margin: 0 .2em;\n	}\n	.beepboxEditor .editor-widget-column {\n		flex-direction: column-reverse;\n	}\n	.beepboxEditor .editor-settings {\n		flex-direction: row;\n	}\n	.beepboxEditor .pauseButton, .beepboxEditor .playButton,\n	.beepboxEditor .nextBarButton, .beepboxEditor .prevBarButton {\n		flex-grow: 1;\n		margin: 0 .2em;\n	}\n	.beepboxEditor .editor-song-settings, .beepboxEditor .editor-instrument-settings {\n		flex-grow: 1;\n		margin: 0 .2em;\n	}\n	.beepboxEditor .editor-settings input, .beepboxEditor .editor-settings .selectContainer {\n		width: 60%;\n	}\n	.beepboxEditor .editor-settings select {\n		width: 100%;\n	}\n	.fullWidthOnly {\n		display: none;\n	}\n	p {\n		margin: 1em 0.5em;\n	}\n}\n\n')),
document.head.appendChild(e)}(beepbox||(beepbox={}));var beepbox;!function(t){var e=function(){function t(){this.H=!0}return t.prototype.I=function(){this.H=!1},t.prototype.isNoop=function(){return this.H},t}();t.Change=e;var n=function(t){function e(e){var n=t.call(this)||this;return n.J=e,n.K=!e,n}return __extends(e,t),e.prototype.undo=function(){this.J?(this.L(),this.K=!0):(this.M(),this.K=!1)},e.prototype.redo=function(){this.J?(this.M(),this.K=!1):(this.L(),this.K=!0)},e.prototype.N=function(){return this.K},e.prototype.L=function(){throw new Error("Change.doForwards(): Override me.")},e.prototype.M=function(){throw new Error("Change.doBackwards(): Override me.")},e}(e);t.UndoableChange=n;var i=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.append=function(t){t.isNoop()||this.I()},e}(e);t.ChangeGroup=i;var s=function(t){function e(e){var n=t.call(this,!1)||this;return void 0==e?n.O=[]:n.O=e.concat(),n}return __extends(e,t),e.prototype.append=function(t){t.isNoop()||(this.O[this.O.length]=t,this.I())},e.prototype.L=function(){for(var t=0;t<this.O.length;t++)this.O[t].redo()},e.prototype.M=function(){for(var t=this.O.length-1;t>=0;t--)this.O[t].undo()},e}(n);t.ChangeSequence=s}(beepbox||(beepbox={}));var beepbox;!function(t){var e=function(t){function e(e,n){var i=t.call(this,!1)||this;return i.P=e,i.Q=n,i.R=i.Q.start,i.S=i.Q.end,i.T=i.Q.start,i.U=i.Q.end,i.V=i.Q.pins,i.W=[],i.X=i.Q.pitches,i.Y=[],i}return __extends(e,t),e.prototype.Z=function(){for(var t=0;t<this.W.length-1;)this.W[t].time>=this.W[t+1].time?this.W.splice(t,1):t++;for(var t=1;t<this.W.length-1;)this.W[t-1].interval==this.W[t].interval&&this.W[t].interval==this.W[t+1].interval&&this.W[t-1].volume==this.W[t].volume&&this.W[t].volume==this.W[t+1].volume?this.W.splice(t,1):t++;for(var e=this.W[0].interval,n=this.W[0].time,t=0;t<this.X.length;t++)this.Y[t]=this.X[t]+e;for(var t=0;t<this.W.length;t++)this.W[t].interval-=e,this.W[t].time-=n;this.T=this.R+n,this.U=this.T+this.W[this.W.length-1].time,this.L(),this.I()},e.prototype.L=function(){this.Q.pins=this.W,this.Q.pitches=this.Y,this.Q.start=this.T,this.Q.end=this.U,this.P.notifier.changed()},e.prototype.M=function(){this.Q.pins=this.V,this.Q.pitches=this.X,this.Q.start=this.R,this.Q.end=this.S,this.P.notifier.changed()},e}(t.UndoableChange);t.ChangePins=e;var n=function(t){function e(e,n){var i=t.call(this)||this,s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()].envelope;return s!=n&&(i.I(),e.song.channels[e.channel].instruments[e.getCurrentInstrument()].envelope=n,e.notifier.changed()),i}return __extends(e,t),e}(t.Change);t.ChangeEnvelope=n;var i=function(t){function e(e,n,i){var s=t.call(this)||this;if(s.oldValue=n,i>e.song.patternsPerChannel)throw new Error("invalid pattern");return e.song.channels[e.channel].bars[e.bar]=i,e.notifier.changed(),n!=i&&s.I(),s}return __extends(e,t),e}(t.Change);t.ChangePattern=i;var s=function(t){function e(e,n){var i=t.call(this)||this;if(e.song.barCount!=n){for(var s=0;s<e.song.getChannelCount();s++){for(var a=e.song.barCount;n>a;a++)e.song.channels[s].bars[a]=1;e.song.channels[s].bars.length=n}var r=e.bar,o=e.barScrollPos,h=e.song.loopStart,l=e.song.loopLength;e.song.barCount>n&&(r=Math.min(r,n-1),o=Math.max(0,Math.min(n-e.trackVisibleBars,o)),l=Math.min(n,l),h=Math.min(n-l,h)),e.bar=r,e.barScrollPos=o,e.song.loopStart=h,e.song.loopLength=l,e.song.barCount=n,e.notifier.changed(),i.I()}return i}return __extends(e,t),e}(t.Change);t.ChangeBarCount=s;var a=function(e){function n(n,i,s){var a=e.call(this)||this;if(n.song.pitchChannelCount!=i||n.song.drumChannelCount!=s){for(var r=[],o=0;i>o;o++){var h=o,l=o;if(o<n.song.pitchChannelCount)r[h]=n.song.channels[l];else{r[h]=new t.Channel,r[h].octave=2;for(var c=0;c<n.song.instrumentsPerChannel;c++)r[h].instruments[c]=new t.Instrument;for(var c=0;c<n.song.patternsPerChannel;c++)r[h].patterns[c]=new t.Pattern;for(var c=0;c<n.song.barCount;c++)r[h].bars[c]=1}}for(var o=0;s>o;o++){var h=o+i,l=o+n.song.pitchChannelCount;if(o<n.song.drumChannelCount)r[h]=n.song.channels[l];else{r[h]=new t.Channel,r[h].octave=0;for(var c=0;c<n.song.instrumentsPerChannel;c++)r[h].instruments[c]=new t.Instrument;for(var c=0;c<n.song.patternsPerChannel;c++)r[h].patterns[c]=new t.Pattern;for(var c=0;c<n.song.barCount;c++)r[h].bars[c]=1}}n.song.pitchChannelCount=i,n.song.drumChannelCount=s;for(var h=0;h<n.song.getChannelCount();h++)n.song.channels[h]=r[h];n.song.channels.length=n.song.getChannelCount(),n.channel=Math.min(n.channel,i+s-1),n.notifier.changed(),a.I()}return a}return __extends(n,e),n}(t.Change);t.ChangeChannelCount=a;var r=function(e){function n(n,i){var s=e.call(this)||this;if(n.song.beatsPerBar!=i){if(n.song.beatsPerBar>i)for(var a=new t.ChangeSequence,r=0;r<n.song.getChannelCount();r++)for(var o=0;o<n.song.channels[r].patterns.length;o++)a.append(new k(n,n.song.channels[r].patterns[o],i*n.song.partsPerBeat,n.song.beatsPerBar*n.song.partsPerBeat));n.song.beatsPerBar=i,n.notifier.changed(),s.I()}return s}return __extends(n,e),n}(t.Change);t.ChangeBeatsPerBar=r;var o=function(t){function e(e,n,i){var s=t.call(this)||this,a=e.channel,r=e.bar;return e.channel=n,e.bar=i,e.barScrollPos=Math.min(e.bar,Math.max(e.bar-(e.trackVisibleBars-1),e.barScrollPos)),e.notifier.changed(),a==n&&r==i||s.I(),s}return __extends(e,t),e}(t.Change);t.ChangeChannelBar=o;var h=function(t){function e(e,n){var i=t.call(this)||this,s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()].chorus;return s!=n&&(i.I(),e.song.channels[e.channel].instruments[e.getCurrentInstrument()].chorus=n,e.notifier.changed()),i}return __extends(e,t),e}(t.Change);t.ChangeChorus=h;var l=function(t){function e(e,n){var i=t.call(this)||this,s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()].effect;return s!=n&&(e.song.channels[e.channel].instruments[e.getCurrentInstrument()].effect=n,e.notifier.changed(),i.I()),i}return __extends(e,t),e}(t.Change);t.ChangeEffect=l;var c=function(t){function e(e,n){var i=t.call(this)||this,s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()].filter;return s!=n&&(e.song.channels[e.channel].instruments[e.getCurrentInstrument()].filter=n,e.notifier.changed(),i.I()),i}return __extends(e,t),e}(t.Change);t.ChangeFilter=c;var u=function(e){function n(n,i){var s=e.call(this)||this;if(n.song.instrumentsPerChannel!=i){for(var a=0;a<n.song.getChannelCount();a++){for(var r=n.song.instrumentsPerChannel;i>r;r++)n.song.channels[a].instruments[r]=new t.Instrument;n.song.channels[a].instruments.length=i;for(var r=0;r<n.song.patternsPerChannel;r++)n.song.channels[a].patterns[r].instrument>=i&&(n.song.channels[a].patterns[r].instrument=0)}n.song.instrumentsPerChannel=i,n.notifier.changed(),s.I()}return s}return __extends(n,e),n}(t.Change);t.ChangeInstrumentsPerChannel=u;var p=function(t){function e(e,n){var i=t.call(this)||this;return e.song.key!=n&&(e.song.key=n,e.notifier.changed(),i.I()),i}return __extends(e,t),e}(t.Change);t.ChangeKey=p;var d=function(t){function e(e,n,i,s,a){var r=t.call(this)||this;return r.P=e,r.oldStart=n,r.oldLength=i,r.newStart=s,r.newLength=a,r.P.song.loopStart=r.newStart,r.P.song.loopLength=r.newLength,r.P.notifier.changed(),r.oldStart==r.newStart&&r.oldLength==r.newLength||r.I(),r}return __extends(e,t),e}(t.Change);t.ChangeLoop=d;var g=function(t){function e(e,n,i,s,a){void 0===a&&(a=!1);var r=t.call(this,a)||this;return r.P=e,r.Q=n,r.$=i,r._=s,r.I(),r.redo(),r}return __extends(e,t),e.prototype.L=function(){this.Q.pitches.splice(this._,0,this.$),this.P.notifier.changed()},e.prototype.M=function(){this.Q.pitches.splice(this._,1),this.P.notifier.changed()},e}(t.UndoableChange);t.ChangePitchAdded=g;var b=function(t){function e(e,n,i){var s=t.call(this)||this;return s.oldValue=n,e.song.channels[e.channel].octave=i,e.notifier.changed(),n!=i&&s.I(),s}return __extends(e,t),e}(t.Change);t.ChangeOctave=b;var f=function(t){function e(e,n){var i=t.call(this)||this;if(e.song.partsPerBeat!=n){for(var s=0;s<e.song.getChannelCount();s++)for(var a=0;a<e.song.channels[s].patterns.length;a++)i.append(new w(e,e.song.channels[s].patterns[a],e.song.partsPerBeat,n));e.song.partsPerBeat=n,e.notifier.changed(),i.I()}return i}return __extends(e,t),e}(t.ChangeGroup);t.ChangePartsPerBeat=f;var m=function(t){function e(e,n,i,s,a){var r=t.call(this)||this;return n.notes=i,e.song.partsPerBeat!=a&&r.append(new w(e,n,a,e.song.partsPerBeat)),e.song.beatsPerBar!=s&&r.append(new k(e,n,e.song.beatsPerBar*e.song.partsPerBeat,s*e.song.partsPerBeat)),e.notifier.changed(),r.I(),r}return __extends(e,t),e}(t.ChangeGroup);t.ChangePaste=m;var v=function(t){function e(e,n,i){var s=t.call(this)||this;return i.instrument!=n&&(i.instrument=n,e.notifier.changed(),s.I()),s}return __extends(e,t),e}(t.Change);t.ChangePatternInstrument=v;var C=function(e){function n(n,i){var s=e.call(this)||this;if(n.song.patternsPerChannel!=i){for(var a=0;a<n.song.getChannelCount();a++){for(var r=n.song.channels[a].bars,o=n.song.channels[a].patterns,h=0;h<r.length;h++)r[h]>i&&(r[h]=0);for(var h=o.length;i>h;h++)o[h]=new t.Pattern;o.length=i}n.song.patternsPerChannel=i,n.notifier.changed(),s.I()}return s}return __extends(n,e),n}(t.Change);t.ChangePatternsPerChannel=C;var P=function(e){function n(n,i,s,a){var r=e.call(this,n,i)||this;a-=r.R;for(var o=r.V[s].time,h=Math.min(o,a),l=Math.max(o,a),c=!1,u=0;u<r.V.length;u++){var p=i.pins[u],d=p.time;h>d?r.W.push(t.makeNotePin(p.interval,d,p.volume)):d>l&&(c||(r.W.push(t.makeNotePin(r.V[s].interval,a,r.V[s].volume)),c=!0),r.W.push(t.makeNotePin(p.interval,d,p.volume)))}return c||r.W.push(t.makeNotePin(r.V[s].interval,a,r.V[s].volume)),r.Z(),r}return __extends(n,e),n}(e);t.ChangePinTime=P;var y=function(e){function n(n,i,s,a,r,o){var h=e.call(this,n,i)||this;s-=h.R,a-=h.R,r-=i.pitches[o];var l,c,u,p,d=!1,g=!1,b=0,f=3,m=!0;for(a>s?(l=0,c=1,u=i.pins.length,p=function(t){h.W.push(t)}):(l=i.pins.length-1,c=-1,u=-1,p=function(t){h.W.unshift(t)});l!=u;l+=c)for(var v=i.pins[l],C=v.time;;)if(d){if(g){if(C*c==a*c)break;v.interval!=b&&(m=!1),p(t.makeNotePin(m?r:v.interval,C,v.volume));break}if(a*c>=C*c&&(b=v.interval,f=v.volume),a*c>C*c)break;p(t.makeNotePin(r,a,f)),g=!0}else{if(s*c>=C*c&&(b=v.interval,f=v.volume),s*c>C*c){p(t.makeNotePin(v.interval,C,v.volume));break}p(t.makeNotePin(b,s,f)),d=!0}return g||p(t.makeNotePin(r,a,f)),h.Z(),h}return __extends(n,e),n}(e);t.ChangePitchBend=y;var w=function(t){function e(e,n,i,s){var a,r=t.call(this)||this;if(i>s)a=function(t){return Math.ceil(t*s/i)};else{if(!(s>i))throw new Error("ChangeRhythm couldn't handle rhythm change from "+i+" to "+s+".");a=function(t){return Math.floor(t*s/i)}}for(var o=0;o<n.notes.length;){var h=n.notes[o];a(h.start)>=a(h.end)?r.append(new N(e,n,h,o,!0)):(r.append(new x(e,h,a)),o++)}return r}return __extends(e,t),e}(t.ChangeSequence);t.ChangeRhythm=w;var x=function(e){function n(n,i,s){for(var a=e.call(this,n,i)||this,r=0,o=a.V;r<o.length;r++){var h=o[r];a.W.push(t.makeNotePin(h.interval,s(h.time+a.R)-a.R,h.volume))}return a.Z(),a}return __extends(n,e),n}(e);t.ChangeRhythmNote=x;var A=function(t){function e(e,n){var i=t.call(this)||this;return e.song.scale!=n&&(e.song.scale=n,e.notifier.changed(),i.I()),i}return __extends(e,t),e}(t.Change);t.ChangeScale=A;var M=function(t){function e(e,n){var i=t.call(this)||this;return e.song.fromBase64String(n),e.channel=Math.min(e.channel,e.song.getChannelCount()-1),e.bar=Math.max(0,Math.min(e.song.barCount-1,e.bar)),e.barScrollPos=Math.max(0,Math.min(e.song.barCount-e.trackVisibleBars,e.barScrollPos)),e.barScrollPos=Math.min(e.bar,Math.max(e.bar-(e.trackVisibleBars-1),e.barScrollPos)),e.notifier.changed(),i.I(),i}return __extends(e,t),e}(t.Change);t.ChangeSong=M;var B=function(t){function e(e,n,i){var s=t.call(this)||this;return s.oldValue=n,e.song.tempo=i,e.notifier.changed(),n!=i&&s.I(),s}return __extends(e,t),e}(t.Change);t.ChangeTempo=B;var L=function(t){function e(e,n,i){var s=t.call(this)||this;return s.oldValue=n,e.song.reverb=i,e.notifier.changed(),n!=i&&s.I(),s}return __extends(e,t),e}(t.Change);t.ChangeReverb=L;var N=function(t){function e(e,n,i,s,a){void 0===a&&(a=!1);var r=t.call(this,a)||this;return r.P=e,r.aa=n,r.Q=i,r._=s,r.I(),r.redo(),r}return __extends(e,t),e.prototype.L=function(){this.aa.notes.splice(this._,0,this.Q),this.P.notifier.changed()},e.prototype.M=function(){this.aa.notes.splice(this._,1),this.P.notifier.changed()},e}(t.UndoableChange);t.ChangeNoteAdded=N;var E=function(e){function n(n,i,s,a){var r=e.call(this,n,i)||this;s-=r.R,a-=r.R;var o,h=!1,l=r.V[0].volume,c=r.V[0].interval,u=!0;for(o=0;o<r.V.length;o++){var p=r.V[o];if(p.time<s)l=p.volume,c=p.interval;else{if(!(p.time<=a))break;if(p.time>s&&!h&&r.W.push(t.makeNotePin(c,s,l)),r.W.push(t.makeNotePin(p.interval,p.time,p.volume)),h=!0,p.time==a){u=!1;break}}}return u&&r.W.push(t.makeNotePin(r.V[o].interval,a,r.V[o].volume)),r.Z(),r}return __extends(n,e),n}(e);t.ChangeNoteLength=E;var k=function(t){function e(e,n,i,s,a){for(var r=t.call(this)||this,o=0;o<n.notes.length;){var h=n.notes[o];if(h==a&&void 0!=a)o++;else if(h.end<=i)o++;else{if(h.start>=s)break;h.start<i?(r.append(new E(e,h,h.start,i)),o++):h.end>s?(r.append(new E(e,h,s,h.end)),o++):r.append(new N(e,n,h,o,!0))}}return r}return __extends(e,t),e}(t.ChangeSequence);t.ChangeNoteTruncate=k;var S=function(e){function n(n,i,s){var a=e.call(this,!1)||this;a.P=n,a.Q=i,a.V=i.pins,a.W=[],a.X=i.pitches,a.Y=[];for(var r=n.song.getChannelIsDrum(n.channel)?t.Config.drumCount-1:t.Config.maxPitch,o=0;o<a.X.length;o++){var h=a.X[o];if(s){for(var l=h+1;r>=l;l++)if(n.song.getChannelIsDrum(n.channel)||t.Config.scaleFlags[n.song.scale][l%12]){h=l;break}}else for(var l=h-1;l>=0;l--)if(n.song.getChannelIsDrum(n.channel)||t.Config.scaleFlags[n.song.scale][l%12]){h=l;break}for(var c=!1,l=0;l<a.Y.length;l++)if(a.Y[l]==h){c=!0;break}c||a.Y.push(h)}for(var u=0,p=r,o=1;o<a.Y.length;o++){var d=a.Y[0]-a.Y[o];d>u&&(u=d),p>d+r&&(p=d+r)}for(var g=0,b=a.V;g<b.length;g++){var f=b[g],m=f.interval+a.X[0];if(u>m&&(m=u),m>p&&(m=p),s){for(var o=m+1;p>=o;o++)if(n.song.getChannelIsDrum(n.channel)||t.Config.scaleFlags[n.song.scale][o%12]){m=o;break}}else for(var o=m-1;o>=u;o--)if(n.song.getChannelIsDrum(n.channel)||t.Config.scaleFlags[n.song.scale][o%12]){m=o;break}m-=a.Y[0],a.W.push(t.makeNotePin(m,f.time,f.volume))}if(0!=a.W[0].interval)throw new Error("wrong pin start interval");for(var o=1;o<a.W.length-1;)a.W[o-1].interval==a.W[o].interval&&a.W[o].interval==a.W[o+1].interval&&a.W[o-1].volume==a.W[o].volume&&a.W[o].volume==a.W[o+1].volume?a.W.splice(o,1):o++;return a.L(),a.I(),a}return __extends(n,e),n.prototype.L=function(){this.Q.pins=this.W,this.Q.pitches=this.Y,this.P.notifier.changed()},n.prototype.M=function(){this.Q.pins=this.V,this.Q.pitches=this.X,this.P.notifier.changed()},n}(t.UndoableChange);t.ChangeTransposeNote=S;var I=function(t){function e(e,n,i){for(var s=t.call(this)||this,a=0;a<n.notes.length;a++)s.append(new S(e,n.notes[a],i));return s}return __extends(e,t),e}(t.ChangeSequence);t.ChangeTranspose=I;var F=function(t){function e(e,n,i){var s=t.call(this)||this;return s.oldValue=n,e.song.channels[e.channel].instruments[e.getCurrentInstrument()].volume=i,e.notifier.changed(),n!=i&&s.I(),s}return __extends(e,t),e}(t.Change);t.ChangeVolume=F;var D=function(e){function n(n,i,s,a,r){var o=e.call(this,!1)||this;o.P=n,o.Q=i,o.V=i.pins,o.W=[];for(var h=!1,l=0,c=i.pins;l<c.length;l++){var u=c[l];u.time<s?o.W.push(u):u.time==s?(o.W.push(t.makeNotePin(r,s,a)),h=!0):(h||(o.W.push(t.makeNotePin(r,s,a)),h=!0),o.W.push(u))}for(var p=1;p<o.W.length-1;)o.W[p-1].interval==o.W[p].interval&&o.W[p].interval==o.W[p+1].interval&&o.W[p-1].volume==o.W[p].volume&&o.W[p].volume==o.W[p+1].volume?o.W.splice(p,1):p++;return o.L(),o.I(),o}return __extends(n,e),n.prototype.L=function(){this.Q.pins=this.W,this.P.notifier.changed()},n.prototype.M=function(){this.Q.pins=this.V,this.P.notifier.changed()},n}(t.UndoableChange);t.ChangeVolumeBend=D;var R=function(t){function e(e,n){var i=t.call(this)||this;return e.song.channels[e.channel].instruments[e.getCurrentInstrument()].wave!=n&&(e.song.channels[e.channel].instruments[e.getCurrentInstrument()].wave=n,e.notifier.changed(),i.I()),i}return __extends(e,t),e}(t.Change);t.ChangeWave=R}(beepbox||(beepbox={}));var beepbox;!function(t){function e(t){return t.toFixed(2).replace(/\.?0*$/,"")}function n(t){var e=t.cloneNode(!1);return t.parentNode.replaceChild(e,t),e}var i=function(){function t(){this.valid=!1,this.prevNote=null,this.curNote=null,this.nextNote=null,this.pitch=0,this.pitchIndex=-1,this.curIndex=0,this.start=0,this.end=0,this.part=0,this.notePart=0,this.nearPinIndex=0,this.pins=[]}return t}(),s=function(){function s(s){var a=this;this.P=s,this.ba=t.svgElement("pattern",{id:"patternEditorNoteBackground",x:"0",y:"0",width:"64",height:"156",patternUnits:"userSpaceOnUse"}),this.ca=t.svgElement("pattern",{id:"patternEditorDrumBackground",x:"0",y:"0",width:"64",height:"40",patternUnits:"userSpaceOnUse"}),this.da=t.svgElement("rect",{x:"0",y:"0",width:"512",height:"481","pointer-events":"none",fill:"url(#patternEditorNoteBackground)"}),this.ea=t.svgElement("svg"),this.fa=t.svgElement("rect",{id:"",x:"0",y:"0",width:"4",height:"481",fill:"white","pointer-events":"none"}),this.ga=t.svgElement("path",{fill:"none",stroke:"white","stroke-width":"2","pointer-events":"none"}),this.ha=t.svgElement("svg",{style:"background-color: #000000; touch-action: none; position: absolute;",width:"100%",height:"100%",viewBox:"0 0 512 481",preserveAspectRatio:"none"},[t.svgElement("defs",void 0,[this.ba,this.ca]),this.da,this.ea,this.ga,this.fa]),this.container=t.html.div({style:"height: 100%; overflow:hidden; position: relative; flex-grow: 1;"},[this.ha]),this.ia=13,this.ja=40,this.ka=[],this.la=t.svgElement("rect"),this.ma=[[t.makeNotePin(0,0,3),t.makeNotePin(0,2,3)],[t.makeNotePin(0,0,3),t.makeNotePin(0,2,3)],[t.makeNotePin(0,0,3),t.makeNotePin(0,2,3)],[t.makeNotePin(0,0,3),t.makeNotePin(0,2,0)]],this.na=481,this.oa=0,this.pa=0,this.qa=!1,this.ra=!1,this.sa=!1,this.ta=!1,this.ua=!1,this.va=[],this.wa=0,this.xa=0,this.ya=0,this.za=0,this.Aa=0,this.Ba=0,this.Ca=0,this.Da=!1,this.Ea=null,this.Fa=new i,this.aa=null,this.Ga=0,this.Ha=0,this.Ia=-1,this.Ja=-1,this.Ka=!1,this.La=!1,this.Ma=-1,this.Na=-1,this.Oa=-1,this.Pa=-1,this.resetCopiedPins=function(){var e=a.Qa();a.va.length=a.P.song.getChannelCount();for(var n=0;n<a.P.song.pitchChannelCount;n++)a.va[n]=[t.makeNotePin(0,0,3),t.makeNotePin(0,e,3)];for(var n=a.P.song.pitchChannelCount;n<a.P.song.getChannelCount();n++)a.va[n]=[t.makeNotePin(0,0,3),t.makeNotePin(0,e,0)]},this.Ra=function(n){var i=Math.floor(a.P.synth.playhead);if(a.P.synth.playing&&null!=a.aa&&a.P.song.getPattern(a.P.channel,Math.floor(a.P.synth.playhead))==a.aa){a.fa.setAttribute("visibility","visible");var s=a.P.synth.playhead-i;Math.abs(s-a.Ga)>.1?a.Ga=s:a.Ga+=.2*(s-a.Ga),a.fa.setAttribute("x",""+e(a.Ga*a.Sa-2))}else a.fa.setAttribute("visibility","hidden");a.P.synth.playing&&a.P.autoFollow&&a.Pa!=i&&(new t.ChangeChannelBar(a.P,a.P.channel,i),a.P.notifier.notifyWatchers()),a.Pa=i,window.requestAnimationFrame(a.Ra)},this.Ta=function(t){a.ra||(a.ra=!0,a.ua=!1)},this.Ua=function(t){a.ra&&(a.ra=!1)},this.Va=function(t){if(t.preventDefault(),null!=a.aa){var e=a.ha.getBoundingClientRect();a.oa=((t.clientX||t.pageX)-e.left)*a.Sa/(e.right-e.left),a.pa=((t.clientY||t.pageY)-e.top)*a.na/(e.bottom-e.top),isNaN(a.oa)&&(a.oa=0),isNaN(a.pa)&&(a.pa=0),a.ua=!1,a.Wa()}},this.Xa=function(t){if(t.preventDefault(),null!=a.aa){var e=a.ha.getBoundingClientRect();a.oa=(t.touches[0].clientX-e.left)*a.Sa/(e.right-e.left),a.pa=(t.touches[0].clientY-e.top)*a.na/(e.bottom-e.top),isNaN(a.oa)&&(a.oa=0),isNaN(a.pa)&&(a.pa=0),a.ua=!0,a.Wa()}},this.Ya=function(t){var e=a.ha.getBoundingClientRect();a.oa=((t.clientX||t.pageX)-e.left)*a.Sa/(e.right-e.left),a.pa=((t.clientY||t.pageY)-e.top)*a.na/(e.bottom-e.top),isNaN(a.oa)&&(a.oa=0),isNaN(a.pa)&&(a.pa=0),a.ua=!1,a.Za()},this.$a=function(t){if(a.qa){t.preventDefault();var e=a.ha.getBoundingClientRect();a.oa=(t.touches[0].clientX-e.left)*a.Sa/(e.right-e.left),a.pa=(t.touches[0].clientY-e.top)*a.na/(e.bottom-e.top),isNaN(a.oa)&&(a.oa=0),isNaN(a.pa)&&(a.pa=0),a.Za()}},this._a=function(e){if(a.Fa.valid&&null!=a.aa){var n=a.P.history.lastChangeWas(a.Ea);if(a.sa&&n)null!=a.Ea&&(a.P.history.record(a.Ea),a.Ea=null);else if(a.qa&&n)if(null==a.Fa.curNote){var i=t.makeNote(a.Fa.pitch,a.Fa.start,a.Fa.end,3,a.P.song.getChannelIsDrum(a.P.channel));i.pins=[];for(var s=0,r=a.Fa.pins;s<r.length;s++){var o=r[s];i.pins.push(t.makeNotePin(0,o.time,o.volume))}a.P.history.record(new t.ChangeNoteAdded(a.P,a.aa,i,a.Fa.curIndex))}else if(-1==a.Fa.pitchIndex){var h=new t.ChangeSequence;4==a.Fa.curNote.pitches.length&&h.append(new t.ChangePitchAdded(a.P,a.Fa.curNote,a.Fa.curNote.pitches[0],0,!0)),h.append(new t.ChangePitchAdded(a.P,a.Fa.curNote,a.Fa.pitch,a.Fa.curNote.pitches.length)),a.P.history.record(h),a.ab(a.Fa.curNote)}else 1==a.Fa.curNote.pitches.length?a.P.history.record(new t.ChangeNoteAdded(a.P,a.aa,a.Fa.curNote,a.Fa.curIndex,!0)):a.P.history.record(new t.ChangePitchAdded(a.P,a.Fa.curNote,a.Fa.pitch,a.Fa.curNote.pitches.indexOf(a.Fa.pitch),!0));a.qa=!1,a.sa=!1,a.bb(),a.cb()}},this.db=function(){a.Sa=a.P.showLetters?a.P.showScrollBar?460:480:a.P.showScrollBar?492:512,a.aa=a.P.getCurrentPattern(),a.eb=a.Sa/(a.P.song.beatsPerBar*a.P.song.partsPerBeat),a.fb=a.P.song.getChannelIsDrum(a.P.channel)?a.ja:a.ia,a.gb=a.P.song.getChannelIsDrum(a.P.channel)?t.Config.drumCount:t.Config.pitchCount,a.Ha=12*a.P.song.channels[a.P.channel].octave,a.Ma==a.P.song.partsPerBeat&&a.Na==a.P.song.pitchChannelCount&&a.Oa==a.P.song.drumChannelCount||(a.Ma=a.P.song.partsPerBeat,a.Na=a.P.song.pitchChannelCount,a.Oa=a.P.song.drumChannelCount,a.resetCopiedPins()),a.hb=a.va[a.P.channel],a.Ia!=a.Sa&&(a.Ia=a.Sa,a.ha.setAttribute("viewBox","0 0 "+a.Sa+" 481"),a.da.setAttribute("width",""+a.Sa));var e=a.Sa/a.P.song.beatsPerBar;if(a.Ja!=e){a.Ja=e,a.ba.setAttribute("width",""+e),a.ca.setAttribute("width",""+e),a.la.setAttribute("width",""+(e-2));for(var i=0;12>i;i++)a.ka[i].setAttribute("width",""+(e-2))}a.qa||a.bb(),a.ea=n(a.ea),a.cb(),a.Ka!=a.P.showFifth&&(a.Ka=a.P.showFifth,a.ka[7].setAttribute("fill",a.P.showFifth?"#446688":"#444444"));for(var i=0;12>i;i++)a.ka[i].style.visibility=t.Config.scaleFlags[a.P.song.scale][i]?"visible":"hidden";if(a.P.song.getChannelIsDrum(a.P.channel)?a.La||(a.La=!0,a.da.setAttribute("fill","url(#patternEditorDrumBackground)"),a.da.setAttribute("height",""+a.ja*t.Config.drumCount)):a.La&&(a.La=!1,a.da.setAttribute("fill","url(#patternEditorNoteBackground)"),a.da.setAttribute("height",""+a.na)),a.P.showChannels)for(var s=a.P.song.getChannelCount()-1;s>=0;s--)if(s!=a.P.channel&&a.P.song.getChannelIsDrum(s)==a.P.song.getChannelIsDrum(a.P.channel)){var r=a.P.song.getPattern(s,a.P.bar);if(null!=r)for(var o=0,h=r.notes;o<h.length;o++)for(var l=h[o],c=0,u=l.pitches;c<u.length;c++){var p=u[c],d=t.svgElement("path");d.setAttribute("fill",a.P.song.getNoteColorDim(s)),d.setAttribute("pointer-events","none"),a.ib(d,p,l.start,l.pins,.19*a.fb,!1,12*a.P.song.channels[s].octave),a.ea.appendChild(d)}}if(null!=a.aa){for(var g=0,b=a.aa.notes;g<b.length;g++)for(var l=b[g],f=0,m=l.pitches;f<m.length;f++){var p=m[f],d=t.svgElement("path");d.setAttribute("fill",a.P.song.getNoteColorDim(a.P.channel)),d.setAttribute("pointer-events","none"),a.ib(d,p,l.start,l.pins,a.fb/2+1,!1,a.Ha),a.ea.appendChild(d),d=t.svgElement("path"),d.setAttribute("fill",a.P.song.getNoteColorBright(a.P.channel)),d.setAttribute("pointer-events","none"),a.ib(d,p,l.start,l.pins,a.fb/2+1,!0,a.Ha),a.ea.appendChild(d)}a.da.style.visibility="visible"}else a.da.style.visibility="hidden"};for(var r=0;12>r;r++){var o=(12-r)%12,h=t.svgElement("rect");h.setAttribute("x","1"),h.setAttribute("y",""+(o*this.ia+1)),h.setAttribute("height",""+(this.ia-2)),h.setAttribute("fill",0==r?"#886644":"#444444"),this.ba.appendChild(h),this.ka[r]=h}this.la.setAttribute("x","1"),this.la.setAttribute("y","1"),this.la.setAttribute("height",""+(this.ja-2)),this.la.setAttribute("fill","#444444"),this.ca.appendChild(this.la),this.P.notifier.watch(this.db),this.db(),this.bb(),this.cb(),window.requestAnimationFrame(this.Ra),this.ha.addEventListener("mousedown",this.Va),document.addEventListener("mousemove",this.Ya),document.addEventListener("mouseup",this._a),this.ha.addEventListener("mouseover",this.Ta),this.ha.addEventListener("mouseout",this.Ua),this.ha.addEventListener("touchstart",this.Xa),this.ha.addEventListener("touchmove",this.$a),this.ha.addEventListener("touchend",this._a),this.ha.addEventListener("touchcancel",this._a),this.resetCopiedPins()}return s.prototype.Qa=function(){return this.P.song.partsPerBeat%3==0?this.P.song.partsPerBeat/3:this.P.song.partsPerBeat%2==0?this.P.song.partsPerBeat/2:this.P.song.partsPerBeat},s.prototype.bb=function(){if(null!=this.aa&&(this.Fa=new i,!(this.oa<0||this.oa>this.Sa||this.pa<0||this.pa>this.na))){this.Fa.part=Math.floor(Math.max(0,Math.min(this.P.song.beatsPerBar*this.P.song.partsPerBeat-1,this.oa/this.eb)));for(var e=0,n=this.aa.notes;e<n.length;e++){var s=n[e];if(s.end<=this.Fa.part)this.Fa.prevNote=s,this.Fa.curIndex++;else if(s.start<=this.Fa.part&&s.end>this.Fa.part)this.Fa.curNote=s;else if(s.start>this.Fa.part){this.Fa.nextNote=s;break}}var a=this.jb(this.pa);if(null!=this.Fa.curNote){this.Fa.start=this.Fa.curNote.start,this.Fa.end=this.Fa.curNote.end,this.Fa.pins=this.Fa.curNote.pins;for(var r=0,o=0,h=void 0,l=this.Fa.curNote.pins[0],c=1;c<this.Fa.curNote.pins.length;c++){h=l,l=this.Fa.curNote.pins[c];var u=this.eb*(this.Fa.curNote.start+h.time),p=this.eb*(this.Fa.curNote.start+l.time);if(!(this.oa>p)){if(this.oa<u)throw new Error;var d=(this.oa-u)/(p-u),g=Math.sqrt(1/Math.sqrt(4)-Math.pow(d-.5,2))-.5,b=Math.abs(l.interval-h.interval);r=h.interval*(1-d)+l.interval*d,o=g*b+1;break}}for(var f=Number.MAX_VALUE,m=-Number.MAX_VALUE,v=Number.MAX_VALUE,C=0,P=this.Fa.curNote.pins;C<P.length;C++){var y=P[C];f>y.interval&&(f=y.interval),m<y.interval&&(m=y.interval);var w=Math.abs(this.Fa.curNote.start+y.time-this.oa/this.eb);v>w&&(v=w,this.Fa.nearPinIndex=this.Fa.curNote.pins.indexOf(y))}if(a-=r,this.Fa.pitch=this.kb(a,-f,(this.P.song.getChannelIsDrum(this.P.channel)?t.Config.drumCount-1:t.Config.maxPitch)-m),3!=this.P.channel)for(var x=o,A=0;A<this.Fa.curNote.pitches.length;A++){var M=Math.abs(this.Fa.curNote.pitches[A]-a+.5);M>x||(x=M,this.Fa.pitch=this.Fa.curNote.pitches[A])}for(var A=0;A<this.Fa.curNote.pitches.length;A++)if(this.Fa.curNote.pitches[A]==this.Fa.pitch){this.Fa.pitchIndex=A;break}}else{this.Fa.pitch=this.kb(a,0,t.Config.maxPitch);var B=this.hb[this.hb.length-1].time,L=Math.floor(this.Fa.part/this.P.song.partsPerBeat),N=this.Qa(),E=this.Fa.part%this.P.song.partsPerBeat;if(1==B)this.Fa.start=this.Fa.part;else if(B>this.P.song.partsPerBeat)this.Fa.start=L*this.P.song.partsPerBeat;else if(B==this.P.song.partsPerBeat)this.Fa.start=L*this.P.song.partsPerBeat,N<this.P.song.partsPerBeat&&E>N&&(this.Fa.start+=Math.floor(E/N)*N);else{this.Fa.start=L*this.P.song.partsPerBeat;for(var k=this.P.song.partsPerBeat%B==0?B:Math.min(B,N);N>k&&this.P.song.partsPerBeat%k!=0;)k++;this.Fa.start+=Math.floor(E/k)*k}this.Fa.end=this.Fa.start+B;var S=0,I=this.P.song.beatsPerBar*this.P.song.partsPerBeat;if(null!=this.Fa.prevNote&&(S=this.Fa.prevNote.end),null!=this.Fa.nextNote&&(I=this.Fa.nextNote.start),this.Fa.start<S?(this.Fa.start=S,this.Fa.end=this.Fa.start+B,this.Fa.end>I&&(this.Fa.end=I)):this.Fa.end>I&&(this.Fa.end=I,this.Fa.start=this.Fa.end-B,this.Fa.start<S&&(this.Fa.start=S)),this.Fa.end-this.Fa.start==B)this.Fa.pins=this.hb;else{this.Fa.pins=[];for(var F=0,D=this.hb;F<D.length;F++){var R=D[F];if(!(R.time<=this.Fa.end-this.Fa.start)){this.Fa.pins.push(t.makeNotePin(0,this.Fa.end-this.Fa.start,R.volume));break}if(this.Fa.pins.push(t.makeNotePin(0,R.time,R.volume)),R.time==this.Fa.end-this.Fa.start)break}}}this.Fa.valid=!0}},s.prototype.jb=function(t){return Math.max(0,Math.min(this.gb-1,this.gb-t/this.fb))+this.Ha},s.prototype.kb=function(e,n,i){n>e&&(e=n),e>i&&(e=i);var s=t.Config.scaleFlags[this.P.song.scale];if(s[Math.floor(e)%12]||this.P.song.getChannelIsDrum(this.P.channel))return Math.floor(e);for(var a=Math.floor(e)+1,r=Math.floor(e)-1;!s[a%12];)a++;for(;!s[r%12];)r--;if(a>i)return n>r?n:r;if(n>r)return a;var o=a,h=r+1;return a%12!=0&&a%12!=7||(o-=.5),r%12!=0&&r%12!=7||(h+=.5),e-h>o-e?a:r},s.prototype.ab=function(e){this.hb=[];for(var n=0,i=e.pins;n<i.length;n++){var s=i[n];this.hb.push(t.makeNotePin(0,s.time,s.volume))}for(var a=1;a<this.hb.length-1;)this.hb[a-1].volume==this.hb[a].volume&&this.hb[a].volume==this.hb[a+1].volume?this.hb.splice(a,1):a++;this.va[this.P.channel]=this.hb},s.prototype.Wa=function(){this.qa=!0,this.wa=this.oa,this.xa=this.pa,this.ya=this.oa,this.za=this.pa,this.bb(),this.cb(),this.Ea=new t.ChangeSequence,this.P.history.setProspectiveChange(this.Ea)},s.prototype.Za=function(){var e,n;if(null!=this.aa){var i=this.P.history.lastChangeWas(this.Ea);if(this.qa&&this.Fa.valid&&i){if(!this.sa){var s=this.oa-this.wa,a=this.pa-this.xa;Math.sqrt(s*s+a*a)>5&&(this.sa=!0,this.ta=Math.abs(s)>=Math.abs(a))}if(this.sa){null!=this.Ea&&this.Ea.undo();var r=Math.floor(this.oa/this.eb),o=new t.ChangeSequence;if(this.Ea=o,this.P.history.setProspectiveChange(this.Ea),null==this.Fa.curNote){var h=void 0,l=void 0;r<this.Fa.start?(h=!0,l=this.Fa.start-r):(h=!1,l=r-this.Fa.start+1);for(var c=1,u=0;u<=this.P.song.beatsPerBar*this.P.song.partsPerBeat;u++)if(!(u>=5&&u%this.P.song.partsPerBeat!=0&&u!=3*this.P.song.partsPerBeat/2&&u!=4*this.P.song.partsPerBeat/3&&u!=5*this.P.song.partsPerBeat/3)){var p=u;if(p==l){c=p;break}if(l>p&&(c=p),p>l){l-1>c&&(c=p);break}}h?(n=this.Fa.start,e=n-c):(e=this.Fa.start,n=e+c),0>e&&(e=0),n>this.P.song.beatsPerBar*this.P.song.partsPerBeat&&(n=this.P.song.beatsPerBar*this.P.song.partsPerBeat),o.append(new t.ChangeNoteTruncate(this.P,this.aa,e,n));var d=void 0;for(d=0;d<this.aa.notes.length&&!(this.aa.notes[d].start>=n);d++);var g=t.makeNote(this.Fa.pitch,e,n,3,this.P.song.getChannelIsDrum(this.P.channel));o.append(new t.ChangeNoteAdded(this.P,this.aa,g,d)),this.ab(g),this.Aa=h?e:n,this.Ba=this.Fa.pitch,this.Ca=g.pins[h?0:1].volume,this.Da=!0}else if(this.ta){var b=Math.round((this.oa-this.wa)/this.eb),f=this.Fa.curNote.pins[this.Fa.nearPinIndex],m=this.Fa.curNote.start+f.time+b;0>m&&(m=0),m>this.P.song.beatsPerBar*this.P.song.partsPerBeat&&(m=this.P.song.beatsPerBar*this.P.song.partsPerBeat),m<=this.Fa.curNote.start&&this.Fa.nearPinIndex==this.Fa.curNote.pins.length-1||m>=this.Fa.curNote.end&&0==this.Fa.nearPinIndex?(o.append(new t.ChangeNoteAdded(this.P,this.aa,this.Fa.curNote,this.Fa.curIndex,!0)),this.Da=!1):(e=Math.min(this.Fa.curNote.start,m),n=Math.max(this.Fa.curNote.end,m),this.Aa=m,this.Ba=this.Fa.curNote.pitches[-1==this.Fa.pitchIndex?0:this.Fa.pitchIndex]+this.Fa.curNote.pins[this.Fa.nearPinIndex].interval,this.Ca=this.Fa.curNote.pins[this.Fa.nearPinIndex].volume,this.Da=!0,o.append(new t.ChangeNoteTruncate(this.P,this.aa,e,n,this.Fa.curNote)),o.append(new t.ChangePinTime(this.P,this.Fa.curNote,this.Fa.nearPinIndex,m)),this.ab(this.Fa.curNote))}else if(-1==this.Fa.pitchIndex){for(var v=Math.round(Math.max(this.Fa.curNote.start,Math.min(this.Fa.curNote.end,this.oa/this.eb)))-this.Fa.curNote.start,C=void 0,P=this.Fa.curNote.pins[0],y=0,w=0,d=1;d<this.Fa.curNote.pins.length;d++)if(C=P,P=this.Fa.curNote.pins[d],!(v>P.time)){if(v<C.time)throw new Error;var x=(v-C.time)/(P.time-C.time);y=Math.round(C.volume*(1-x)+P.volume*x+(this.xa-this.pa)/25),0>y&&(y=0),y>3&&(y=3),w=this.kb(C.interval*(1-x)+P.interval*x+this.Fa.curNote.pitches[0],0,t.Config.maxPitch)-this.Fa.curNote.pitches[0];break}this.Aa=this.Fa.curNote.start+v,this.Ba=this.Fa.curNote.pitches[-1==this.Fa.pitchIndex?0:this.Fa.pitchIndex]+w,this.Ca=y,this.Da=!0,o.append(new t.ChangeVolumeBend(this.P,this.Fa.curNote,v,y,w)),this.ab(this.Fa.curNote)}else{this.Ca=this.Fa.curNote.pins[this.Fa.nearPinIndex].volume;
var A=void 0,M=void 0;this.oa>=this.wa?(A=this.Fa.part,M=r+1):(A=this.Fa.part+1,M=r),0>M&&(M=0),M>this.P.song.beatsPerBar*this.P.song.partsPerBeat&&(M=this.P.song.beatsPerBar*this.P.song.partsPerBeat),M>this.Fa.curNote.end&&o.append(new t.ChangeNoteTruncate(this.P,this.aa,this.Fa.curNote.start,M,this.Fa.curNote)),M<this.Fa.curNote.start&&o.append(new t.ChangeNoteTruncate(this.P,this.aa,M,this.Fa.curNote.end,this.Fa.curNote));for(var B=Number.MAX_VALUE,L=-Number.MAX_VALUE,N=0,E=this.Fa.curNote.pitches;N<E.length;N++){var k=E[N];B>k&&(B=k),k>L&&(L=k)}B-=this.Fa.curNote.pitches[0],L-=this.Fa.curNote.pitches[0];var S=this.kb(this.jb(this.pa),-B,t.Config.maxPitch-L);o.append(new t.ChangePitchBend(this.P,this.Fa.curNote,A,M,S,this.Fa.pitchIndex)),this.ab(this.Fa.curNote),this.Aa=M,this.Ba=S,this.Da=!0}}this.ya=this.oa,this.za=this.pa}else this.bb(),this.cb()}},s.prototype.cb=function(){if(this.ua)if(this.qa&&this.Fa.valid&&this.sa&&this.Da&&null!=this.aa){this.ga.setAttribute("visibility","visible");var t=this.eb*this.Aa,n=this.lb(this.Ba-this.Ha),i=this.fb/2,s=80,a=60,r="";r+="M "+e(t)+" "+e(n-i*(this.Ca/3))+" ",r+="L "+e(t)+" "+e(n-i*(this.Ca/3)-a)+" ",r+="M "+e(t)+" "+e(n+i*(this.Ca/3))+" ",r+="L "+e(t)+" "+e(n+i*(this.Ca/3)+a)+" ",r+="M "+e(t)+" "+e(n-i*(this.Ca/3))+" ",r+="L "+e(t+s)+" "+e(n-i*(this.Ca/3))+" ",r+="M "+e(t)+" "+e(n+i*(this.Ca/3))+" ",r+="L "+e(t+s)+" "+e(n+i*(this.Ca/3))+" ",r+="M "+e(t)+" "+e(n-i*(this.Ca/3))+" ",r+="L "+e(t-s)+" "+e(n-i*(this.Ca/3))+" ",r+="M "+e(t)+" "+e(n+i*(this.Ca/3))+" ",r+="L "+e(t-s)+" "+e(n+i*(this.Ca/3))+" ",this.ga.setAttribute("d",r)}else this.ga.setAttribute("visibility","hidden");else this.ra&&!this.qa&&this.Fa.valid&&null!=this.aa?(this.ga.setAttribute("visibility","visible"),this.ib(this.ga,this.Fa.pitch,this.Fa.start,this.Fa.pins,this.fb/2+1,!0,this.Ha)):this.ga.setAttribute("visibility","hidden")},s.prototype.ib=function(t,n,i,s,a,r,o){for(var h=s[0],l="M "+e(this.eb*(i+h.time)+1)+" "+e(this.lb(n-o)+a*(r?h.volume/3:1))+" ",c=1;c<s.length;c++){var u=h;h=s[c];var p=this.eb*(i+u.time)+(1==c?1:0),d=this.eb*(i+h.time)-(c==s.length-1?1:0),g=this.lb(n+u.interval-o),b=this.lb(n+h.interval-o),f=r?u.volume/3:1,m=r?h.volume/3:1;l+="L "+e(p)+" "+e(g-a*f)+" ",u.interval>h.interval&&(l+="L "+e(p+1)+" "+e(g-a*f)+" "),u.interval<h.interval&&(l+="L "+e(d-1)+" "+e(b-a*m)+" "),l+="L "+e(d)+" "+e(b-a*m)+" "}for(var c=s.length-2;c>=0;c--){var u=h;h=s[c];var p=this.eb*(i+u.time)-(c==s.length-2?1:0),d=this.eb*(i+h.time)+(0==c?1:0),g=this.lb(n+u.interval-o),b=this.lb(n+h.interval-o),f=r?u.volume/3:1,m=r?h.volume/3:1;l+="L "+e(p)+" "+e(g+a*f)+" ",u.interval<h.interval&&(l+="L "+e(p-1)+" "+e(g+a*f)+" "),u.interval>h.interval&&(l+="L "+e(d+1)+" "+e(b+a*m)+" "),l+="L "+e(d)+" "+e(b+a*m)+" "}l+="z",t.setAttribute("d",l)},s.prototype.lb=function(t){return this.fb*(this.gb-t-.5)},s}();t.PatternEditor=s}(beepbox||(beepbox={}));var beepbox;!function(t){var e=function(){function e(e,n,i,s){this.mb=t.html.text("1"),this.nb=t.svgElement("text",{x:16,y:23,"font-family":"sans-serif","font-size":20,"text-anchor":"middle","font-weight":"bold",fill:"red"},[this.mb]),this.ob=t.svgElement("rect",{width:30,height:30,x:1,y:1}),this.container=t.svgElement("svg",void 0,[this.ob,this.nb]),this.pb=1,this.qb=!0,this.rb=!1,this.sb="",this.container.setAttribute("x",""+32*n),this.container.setAttribute("y",""+32*i),this.ob.setAttribute("fill","#444444"),this.nb.setAttribute("fill",s)}return e.prototype.setSquashed=function(t,e){t?(this.container.setAttribute("y",""+27*e),this.ob.setAttribute("height","25"),this.nb.setAttribute("y","21")):(this.container.setAttribute("y",""+32*e),this.ob.setAttribute("height","30"),this.nb.setAttribute("y","23"))},e.prototype.setIndex=function(t,e,n,i,s){this.pb!=t&&(this.rb||0==t==(0==this.pb)||this.ob.setAttribute("fill",0==t?"#000000":"#444444"),this.pb=t,this.mb.data=""+t),this.qb==e&&this.sb==s||(this.qb=e,n?this.nb.setAttribute("fill","#000000"):this.nb.setAttribute("fill",s)),this.rb==n&&this.sb==s||(this.rb=n,n?(this.ob.setAttribute("fill",s),this.nb.setAttribute("fill","#000000")):(this.ob.setAttribute("fill",0==this.pb?"#000000":"#444444"),this.nb.setAttribute("fill",s))),this.sb=s},e}(),n=function(){function n(e,n){var i=this;this.P=e,this.tb=n,this.ub=32,this.ha=t.svgElement("svg",{style:"background-color: #000000; position: absolute;",height:128}),this.vb=t.html.select({className:"trackSelectBox",style:"width: 32px; height: 32px; background: none; border: none; appearance: none; color: transparent; position: absolute;"}),this.container=t.html.div({style:"height: 128px; position: relative; overflow:hidden;"},[this.ha,this.vb]),this.wb=t.svgElement("g"),this.xb=t.svgElement("rect",{fill:"white",x:0,y:0,width:4,height:128}),this.yb=t.svgElement("rect",{fill:"none",stroke:"white","stroke-width":2,"pointer-events":"none",x:1,y:1,width:30,height:30}),this.zb=t.svgElement("path",{fill:"black",stroke:"black","stroke-width":1,"pointer-events":"none"}),this.Ab=t.svgElement("path",{fill:"black",stroke:"black","stroke-width":1,"pointer-events":"none"}),this.Bb=[],this.oa=0,this.pa=0,this.aa=null,this.ra=!1,this.Cb="",this.na=128,this.Db=32,this.Eb=0,this.Fb=0,this.Gb=0,this.Hb=-1,this.Ib=!1,this.Jb=null,this.Kb=function(){i.Lb(i.vb.selectedIndex)},this.Ra=function(t){var e=i.ub*i.P.synth.playhead-2;i.Hb!=e&&(i.Hb=e,i.xb.setAttribute("x",""+e)),window.requestAnimationFrame(i.Ra)},this.Ta=function(t){i.ra||(i.ra=!0)},this.Ua=function(t){i.ra&&(i.ra=!1)},this.Va=function(t){t.preventDefault();var e=i.ha.getBoundingClientRect();i.oa=(t.clientX||t.pageX)-e.left,i.pa=(t.clientY||t.pageY)-e.top;var n=Math.floor(Math.min(i.P.song.getChannelCount()-1,Math.max(0,i.pa/i.Db))),s=Math.floor(Math.min(i.P.song.barCount-1,Math.max(0,i.oa/i.ub)));if(i.P.channel==n&&i.P.bar==s){var a=i.pa%i.Db<i.Db/2,r=i.P.song.patternsPerChannel;i.Lb((i.P.song.channels[n].bars[s]+(a?1:r))%(r+1))}else i.Mb(n,s)},this.Ya=function(t){var e=i.ha.getBoundingClientRect();i.oa=(t.clientX||t.pageX)-e.left,i.pa=(t.clientY||t.pageY)-e.top,i.cb()},this.Nb=function(t){},this.ha.appendChild(this.wb),this.ha.appendChild(this.yb),this.ha.appendChild(this.zb),this.ha.appendChild(this.Ab),this.ha.appendChild(this.xb),window.requestAnimationFrame(this.Ra),this.ha.addEventListener("mousedown",this.Va),document.addEventListener("mousemove",this.Ya),document.addEventListener("mouseup",this.Nb),this.ha.addEventListener("mouseover",this.Ta),this.ha.addEventListener("mouseout",this.Ua),this.vb.addEventListener("change",this.Kb)}return n.prototype.Mb=function(e,n){new t.ChangeChannelBar(this.P,e,n),this.Cb="",this.P.history.forgetLastChange()},n.prototype.Lb=function(e){var n=this.P.song.channels[this.P.channel].bars[this.P.bar],i=this.P.history.lastChangeWas(this.Jb),s=i?this.Jb.oldValue:n;e!=n&&(this.Jb=new t.ChangePattern(this.P,s,e),this.P.history.record(this.Jb,i))},n.prototype.onKeyPressed=function(t){switch(t.keyCode){case 38:this.Mb((this.P.channel-1+this.P.song.getChannelCount())%this.P.song.getChannelCount(),this.P.bar),t.preventDefault();break;case 40:this.Mb((this.P.channel+1)%this.P.song.getChannelCount(),this.P.bar),t.preventDefault();break;case 37:this.Mb(this.P.channel,(this.P.bar+this.P.song.barCount-1)%this.P.song.barCount),t.preventDefault();break;case 39:this.Mb(this.P.channel,(this.P.bar+1)%this.P.song.barCount),t.preventDefault();break;case 48:this.Ob("0"),t.preventDefault();break;case 49:this.Ob("1"),t.preventDefault();break;case 50:this.Ob("2"),t.preventDefault();break;case 51:this.Ob("3"),t.preventDefault();break;case 52:this.Ob("4"),t.preventDefault();break;case 53:this.Ob("5"),t.preventDefault();break;case 54:this.Ob("6"),t.preventDefault();break;case 55:this.Ob("7"),t.preventDefault();break;case 56:this.Ob("8"),t.preventDefault();break;case 57:this.Ob("9"),t.preventDefault();break;default:this.Cb=""}},n.prototype.Ob=function(t){this.Cb+=t;var e=parseInt(this.Cb);return e<=this.P.song.patternsPerChannel?void this.Lb(e):(this.Cb=t,e=parseInt(this.Cb),e<=this.P.song.patternsPerChannel?void this.Lb(e):void(this.Cb=""))},n.prototype.cb=function(){var e=Math.floor(Math.min(this.P.song.getChannelCount()-1,Math.max(0,this.pa/this.Db))),n=Math.floor(Math.min(this.P.song.barCount-1,Math.max(0,this.oa/this.ub))),i=window.innerWidth>700;i||(n=this.P.bar,e=this.P.channel);var s=n==this.P.bar&&e==this.P.channel;if(this.ra&&!s?(this.yb.setAttribute("x",""+(1+this.ub*n)),this.yb.setAttribute("y",""+(1+this.Db*e)),this.yb.setAttribute("height",""+(this.Db-2)),this.yb.style.visibility="visible"):this.yb.style.visibility="hidden",!this.ra&&i||!s)this.zb.style.visibility="hidden",this.Ab.style.visibility="hidden";else{var a=this.pa%this.Db<this.Db/2,r=this.ub*(n+.8),o=this.Db*(e+.5),h=.1*this.Db,l=.4*this.Db,c=.175*this.Db;this.zb.setAttribute("fill",a&&i?"#fff":"#000"),this.Ab.setAttribute("fill",!a&&i?"#fff":"#000"),this.zb.setAttribute("d","M "+r+" "+(o-l)+" L "+(r+c)+" "+(o-h)+" L "+(r-c)+" "+(o-h)+" z"),this.Ab.setAttribute("d","M "+r+" "+(o+l)+" L "+(r+c)+" "+(o+h)+" L "+(r-c)+" "+(o+h)+" z"),this.zb.style.visibility="visible",this.Ab.style.visibility="visible"}this.vb.style.left=this.ub*this.P.bar+"px",this.vb.style.top=this.Db*this.P.channel+"px",this.vb.style.height=this.Db+"px";for(var u=this.P.song.patternsPerChannel,p=this.Gb;u>p;p++)this.vb.appendChild(t.html.option(p,p,!1,!1));for(var p=u;p<this.Gb;p++)this.vb.removeChild(this.vb.lastChild);this.Gb=u;var d=this.P.song.channels[this.P.channel].bars[this.P.bar];this.vb.selectedIndex!=d&&(this.vb.selectedIndex=d)},n.prototype.render=function(){this.aa=this.P.getCurrentPattern();var t=window.innerWidth>700,n=!t||this.P.song.getChannelCount()>4||this.P.song.barCount>this.P.trackVisibleBars&&this.P.song.getChannelCount()>3;if(this.Db=n?27:32,this.Eb!=this.P.song.getChannelCount()){for(var i=this.Eb;i<this.P.song.getChannelCount();i++){this.Bb[i]=[];for(var s=0;s<this.Fb;s++){var a=new e(i,s,i,this.P.song.getChannelColorDim(i));a.setSquashed(n,i),this.wb.appendChild(a.container),this.Bb[i][s]=a}}for(var i=this.P.song.getChannelCount();i<this.Eb;i++)for(var s=0;s<this.Fb;s++)this.wb.removeChild(this.Bb[i][s].container);this.Bb.length=this.P.song.getChannelCount()}if(this.Fb!=this.P.song.barCount){for(var i=0;i<this.P.song.getChannelCount();i++){for(var s=this.Fb;s<this.P.song.barCount;s++){var a=new e(i,s,i,this.P.song.getChannelColorDim(i));a.setSquashed(n,i),this.wb.appendChild(a.container),this.Bb[i][s]=a}for(var s=this.P.song.barCount;s<this.Fb;s++)this.wb.removeChild(this.Bb[i][s].container);this.Bb[i].length=this.P.song.barCount}this.Fb=this.P.song.barCount;var r=32*this.P.song.barCount;this.container.style.width=r+"px",this.ha.setAttribute("width",r+"")}if(this.Ib!=n)for(var i=0;i<this.P.song.getChannelCount();i++)for(var s=0;s<this.Fb;s++)this.Bb[i][s].setSquashed(n,i);this.Ib==n&&this.Eb==this.P.song.getChannelCount()||(this.Ib=n,this.Eb=this.P.song.getChannelCount(),this.na=this.P.song.getChannelCount()*this.Db,this.ha.setAttribute("height",""+this.na),this.xb.setAttribute("height",""+this.na),this.container.style.height=this.na+"px");for(var o=0;o<this.P.song.getChannelCount();o++)for(var h=0;h<this.Fb;h++){var l=this.P.song.getPattern(o,h),c=h==this.P.bar&&o==this.P.channel,u=null==l||0==l.notes.length,a=this.Bb[o][h];h<this.P.song.barCount?(a.setIndex(this.P.song.channels[o].bars[h],u,c,o,u&&!c?this.P.song.getChannelColorDim(o):this.P.song.getChannelColorBright(o)),a.container.style.visibility="visible"):a.container.style.visibility="hidden"}this.cb()},n}();t.TrackEditor=n}(beepbox||(beepbox={}));var beepbox;!function(t){var e=function(){function e(e){var n=this;this.P=e,this.ub=32,this.na=20,this.Pb=0,this.Qb=1,this.Rb=2,this.Sb=t.svgElement("path",{fill:"none",stroke:"#7744ff","stroke-width":4}),this.Tb=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.ha=t.svgElement("svg",{style:"background-color: #000000; touch-action: pan-y; position: absolute;",height:this.na},[this.Sb,this.Tb]),this.container=t.html.div({style:"height: 20px; position: relative; margin: 5px 0;"},[this.ha]),this.Ub=null,this.Fa={startBar:-1,mode:-1},this.oa=0,this.pa=0,this.Vb=0,this.Wb=0,this.Xb=!1,this.Yb=!1,this.qa=!1,this.ra=!1,this.Zb=-1,this.$b=-1,this.Fb=0,this.Ta=function(t){n.ra||(n.ra=!0,n.cb())},this.Ua=function(t){n.ra&&(n.ra=!1,n.cb())},this.Va=function(t){t.preventDefault(),n.qa=!0;var e=n.ha.getBoundingClientRect();n.oa=(t.clientX||t.pageX)-e.left,n.pa=(t.clientY||t.pageY)-e.top,n.bb(),n.cb(),n.Ya(t)},this.Xa=function(t){n.qa=!0;var e=n.ha.getBoundingClientRect();n.oa=t.touches[0].clientX-e.left,n.pa=t.touches[0].clientY-e.top,n.bb(),n.cb(),n.Vb=t.touches[0].clientX,n.Wb=t.touches[0].clientY,n.Yb=!1,n.Xb=!1},this.Ya=function(t){var e=n.ha.getBoundingClientRect();n.oa=(t.clientX||t.pageX)-e.left,n.pa=(t.clientY||t.pageY)-e.top,n.Za()},this.$a=function(t){if(n.qa){var e=n.ha.getBoundingClientRect();n.oa=t.touches[0].clientX-e.left,n.pa=t.touches[0].clientY-e.top,n.Yb||n.Xb||(Math.abs(t.touches[0].clientY-n.Wb)>10?n.Xb=!0:Math.abs(t.touches[0].clientX-n.Vb)>10&&(n.Yb=!0)),n.Yb&&(n.Za(),t.preventDefault())}},this._b=function(t){t.preventDefault(),n.Xb||(n.Za(),n.ra=!1,n._a(t),n.cb())},this._a=function(t){null!=n.Ub&&n.P.history.record(n.Ub),n.Ub=null,n.qa=!1,n.bb(),n.ac()},this.db=function(){n.ac()},this.bb(),this.ac(),this.P.notifier.watch(this.db),this.container.addEventListener("mousedown",this.Va),document.addEventListener("mousemove",this.Ya),document.addEventListener("mouseup",this._a),this.container.addEventListener("mouseover",this.Ta),this.container.addEventListener("mouseout",this.Ua),this.container.addEventListener("touchstart",this.Xa),this.container.addEventListener("touchmove",this.$a),this.container.addEventListener("touchend",this._b),this.container.addEventListener("touchcancel",this._b)}return e.prototype.bb=function(){var t=this.oa/this.ub;this.Fa.startBar=t,t>this.P.song.loopStart-.25&&t<this.P.song.loopStart+this.P.song.loopLength+.25?t-this.P.song.loopStart<.5*this.P.song.loopLength?this.Fa.mode=this.Pb:this.Fa.mode=this.Qb:this.Fa.mode=this.Rb},e.prototype.bc=function(t){var e=Math.round(t-this.P.song.loopLength/2),n=e+this.P.song.loopLength;return 0>e&&(n-=e,e=0),n>this.P.song.barCount&&(e-=n-this.P.song.barCount,n=this.P.song.barCount),{start:e,length:n-e}},e.prototype.Za=function(){if(this.qa){var e=this.P.song.loopStart,n=this.P.song.loopStart+this.P.song.loopLength;null!=this.Ub&&this.P.history.lastChangeWas(this.Ub)&&(e=this.Ub.oldStart,n=e+this.Ub.oldLength);var i=this.oa/this.ub,s=void 0,a=void 0,r=void 0;if(this.Fa.mode==this.Pb)s=e+Math.round(i-this.Fa.startBar),a=n,s==a?s=a-1:s>a&&(r=s,s=a,a=r),0>s&&(s=0),a>=this.P.song.barCount&&(a=this.P.song.barCount),this.Ub=new t.ChangeLoop(this.P,e,n-e,s,a-s);else if(this.Fa.mode==this.Qb)s=e,a=n+Math.round(i-this.Fa.startBar),a==s?a=s+1:s>a&&(r=s,s=a,a=r),0>s&&(s=0),a>=this.P.song.barCount&&(a=this.P.song.barCount),this.Ub=new t.ChangeLoop(this.P,e,n-e,s,a-s);else if(this.Fa.mode==this.Rb){var o=this.bc(i);this.Ub=new t.ChangeLoop(this.P,e,n-e,o.start,o.length)}this.P.history.setProspectiveChange(this.Ub)}else this.bb(),this.cb()},e.prototype.cb=function(){var t=this.ra&&!this.qa;if(this.Tb.style.visibility=t?"visible":"hidden",t){var e=this.na/2,n=this.P.song.loopStart*this.ub,i=(this.P.song.loopStart+this.P.song.loopLength)*this.ub;if(this.Fa.mode==this.Pb)i=this.P.song.loopStart*this.ub+2*e;else if(this.Fa.mode==this.Qb)n=(this.P.song.loopStart+this.P.song.loopLength)*this.ub-2*e;else{var s=this.bc(this.Fa.startBar);n=s.start*this.ub,i=(s.start+s.length)*this.ub}this.Tb.setAttribute("d","M "+(n+e)+" 4 "+("L "+(i-e)+" 4 ")+("A "+(e-4)+" "+(e-4)+" 0 0 1 "+(i-e)+" "+(this.na-4)+" ")+("L "+(n+e)+" "+(this.na-4)+" ")+("A "+(e-4)+" "+(e-4)+" 0 0 1 "+(n+e)+" 4 ")+"z")}},e.prototype.ac=function(){var t=this.na/2,e=this.P.song.loopStart*this.ub,n=(this.P.song.loopStart+this.P.song.loopLength)*this.ub;if(this.Fb!=this.P.song.barCount){this.Fb=this.P.song.barCount;var i=32*this.P.song.barCount;this.container.style.width=i+"px",this.ha.setAttribute("width",i+"")}this.Zb==e&&this.$b==n||(this.Zb=e,this.$b=n,this.Sb.setAttribute("d","M "+(e+t)+" 2 "+("L "+(n-t)+" 2 ")+("A "+(t-2)+" "+(t-2)+" 0 0 1 "+(n-t)+" "+(this.na-2)+" ")+("L "+(e+t)+" "+(this.na-2)+" ")+("A "+(t-2)+" "+(t-2)+" 0 0 1 "+(e+t)+" 2 ")+"z")),this.cb()},e}();t.LoopEditor=e}(beepbox||(beepbox={}));var beepbox;!function(t){var e=function(){function e(e,n){var i=this;this.P=e,this.cc=n,this.Sa=512,this.na=20,this.dc=t.svgElement("svg",{"pointer-events":"none"}),this.ec=t.svgElement("rect",{fill:"#444444",x:0,y:2,width:10,height:this.na-4}),this.fc=t.svgElement("rect",{fill:"none",stroke:"white","stroke-width":2,"pointer-events":"none",x:0,y:1,width:10,height:this.na-2}),this.gc=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.hc=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.ha=t.svgElement("svg",{style:"background-color: #000000; touch-action: pan-y; position: absolute;",width:this.Sa,height:this.na},[this.dc,this.ec,this.fc,this.gc,this.hc]),this.container=t.html.div({className:"barScrollBar",style:"width: 512px; height: 20px; overflow: hidden; position: relative;"},[this.ha]),this.oa=0,this.pa=0,this.qa=!1,this.ra=!1,this.ic=!1,this.jc=-1,this.kc=-1,this.lc=function(t){i.P.barScrollPos=i.cc.scrollLeft/32},this.Ta=function(t){i.ra||(i.ra=!0,i.cb())},this.Ua=function(t){i.ra&&(i.ra=!1,i.cb())},this.Va=function(t){t.preventDefault(),i.qa=!0;var e=i.ha.getBoundingClientRect();i.oa=(t.clientX||t.pageX)-e.left,i.pa=(t.clientY||t.pageY)-e.top,i.cb(),i.oa>=i.P.barScrollPos*i.ub&&i.oa<=(i.P.barScrollPos+i.P.trackVisibleBars)*i.ub&&(i.ic=!0,i.mc=i.oa)},this.Xa=function(t){t.preventDefault(),i.qa=!0;var e=i.ha.getBoundingClientRect();i.oa=t.touches[0].clientX-e.left,i.pa=t.touches[0].clientY-e.top,i.cb(),i.oa>=i.P.barScrollPos*i.ub&&i.oa<=(i.P.barScrollPos+i.P.trackVisibleBars)*i.ub&&(i.ic=!0,i.mc=i.oa)},this.Ya=function(t){var e=i.ha.getBoundingClientRect();i.oa=(t.clientX||t.pageX)-e.left,i.pa=(t.clientY||t.pageY)-e.top,i.Za()},this.$a=function(t){if(i.qa){t.preventDefault();var e=i.ha.getBoundingClientRect();i.oa=t.touches[0].clientX-e.left,i.pa=t.touches[0].clientY-e.top,i.Za()}},this._a=function(t){!i.ic&&i.qa&&(i.oa<(i.P.barScrollPos+8)*i.ub?(i.P.barScrollPos>0&&i.P.barScrollPos--,i.P.notifier.changed()):(i.P.barScrollPos<i.P.song.barCount-i.P.trackVisibleBars&&i.P.barScrollPos++,i.P.notifier.changed())),i.qa=!1,i.ic=!1,i.cb()};var s=.5*this.na,a=20,r=9,o=6;this.gc.setAttribute("d","M "+r+" "+s+" L "+a+" "+(s+o)+" L "+a+" "+(s-o)+" z"),this.hc.setAttribute("d","M "+(this.Sa-r)+" "+s+" L "+(this.Sa-a)+" "+(s+o)+" L "+(this.Sa-a)+" "+(s-o)+" z"),this.container.addEventListener("mousedown",this.Va),document.addEventListener("mousemove",this.Ya),document.addEventListener("mouseup",this._a),this.container.addEventListener("mouseover",this.Ta),this.container.addEventListener("mouseout",this.Ua),this.container.addEventListener("touchstart",this.Xa),this.container.addEventListener("touchmove",this.$a),this.container.addEventListener("touchend",this._a),this.container.addEventListener("touchcancel",this._a),this.cc.addEventListener("scroll",this.lc,{capture:!1,passive:!0})}return e.prototype.Za=function(){if(this.ic){for(;this.oa-this.mc<.5*-this.ub&&this.P.barScrollPos>0;)this.P.barScrollPos--,this.mc-=this.ub,this.P.notifier.changed();for(;this.oa-this.mc>.5*this.ub&&this.P.barScrollPos<this.P.song.barCount-this.P.trackVisibleBars;)this.P.barScrollPos++,this.mc+=this.ub,this.P.notifier.changed()}this.ra&&this.cb()},e.prototype.cb=function(){var t=this.ra&&!this.qa,e=!1,n=!1,i=!1;t&&(this.oa<this.P.barScrollPos*this.ub?e=!0:this.oa>(this.P.barScrollPos+this.P.trackVisibleBars)*this.ub?n=!0:i=!0),this.gc.style.visibility=e?"visible":"hidden",this.hc.style.visibility=n?"visible":"hidden",this.fc.style.visibility=i?"visible":"hidden"},e.prototype.render=function(){this.ub=(this.Sa-1)/Math.max(this.P.trackVisibleBars,this.P.song.barCount);var e=this.jc!=this.P.song.barCount;if(e){for(this.jc=this.P.song.barCount;this.dc.firstChild;)this.dc.removeChild(this.dc.firstChild);for(var n=0;n<=this.P.song.barCount;n++){var i=n%16==0?0:n%4==0?this.na/8:this.na/3;this.dc.appendChild(t.svgElement("rect",{fill:"#444444",x:n*this.ub-1,y:i,width:2,height:this.na-2*i}))}}(e||this.kc!=this.P.barScrollPos)&&(this.kc=this.P.barScrollPos,this.ec.setAttribute("x",""+this.ub*this.P.barScrollPos),this.ec.setAttribute("width",""+this.ub*this.P.trackVisibleBars),this.fc.setAttribute("x",""+this.ub*this.P.barScrollPos),this.fc.setAttribute("width",""+this.ub*this.P.trackVisibleBars)),this.cb(),this.cc.scrollLeft=32*this.P.barScrollPos},e}();t.BarScrollBar=e}(beepbox||(beepbox={}));var beepbox;!function(t){var e=function(){function e(e){var n=this;this.P=e,this.Sa=20,this.na=481,this.nc=4,this.oc=7,this.pc=(this.na-this.nc)/this.oc,this.qc=3*this.pc+this.nc,this.ec=t.svgElement("rect",{fill:"#444444",x:2,y:0,width:this.Sa-4,height:this.qc}),this.fc=t.svgElement("rect",{fill:"none",stroke:"white","stroke-width":2,"pointer-events":"none",x:1,y:0,width:this.Sa-2,height:this.qc}),this.zb=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.Ab=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.ha=t.svgElement("svg",{style:"background-color: #000000; touch-action: pan-x; position: absolute;",width:this.Sa,height:"100%",viewBox:"0 0 20 481",preserveAspectRatio:"none"}),this.container=t.html.div({id:"octaveScrollBarContainer",style:"width: 20px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0;"},[this.ha]),this.oa=0,this.pa=0,this.qa=!1,this.ra=!1,this.ic=!1,this.rc=-1,this.Ub=null,this.Ta=function(t){n.ra||(n.ra=!0,n.cb())},this.Ua=function(t){n.ra&&(n.ra=!1,n.cb())},this.Va=function(t){t.preventDefault(),n.qa=!0;var e=n.ha.getBoundingClientRect();n.oa=(t.clientX||t.pageX)-e.left,n.pa=((t.clientY||t.pageY)-e.top)*n.na/(e.bottom-e.top),isNaN(n.pa)&&(n.pa=0),n.P.song.getChannelIsDrum(n.P.channel)||(n.cb(),n.pa>=n.sc-n.qc&&n.pa<=n.sc&&(n.ic=!0,n.mc=n.pa))},this.Xa=function(t){t.preventDefault(),n.qa=!0;var e=n.ha.getBoundingClientRect();n.oa=t.touches[0].clientX-e.left,n.pa=(t.touches[0].clientY-e.top)*n.na/(e.bottom-e.top),isNaN(n.pa)&&(n.pa=0),n.P.song.getChannelIsDrum(n.P.channel)||(n.cb(),n.pa>=n.sc-n.qc&&n.pa<=n.sc&&(n.ic=!0,n.mc=n.pa))},this.Ya=function(t){var e=n.ha.getBoundingClientRect();n.oa=(t.clientX||t.pageX)-e.left,n.pa=((t.clientY||t.pageY)-e.top)*n.na/(e.bottom-e.top),isNaN(n.pa)&&(n.pa=0),n.Za()},this.$a=function(t){if(n.qa){t.preventDefault();var e=n.ha.getBoundingClientRect();n.oa=t.touches[0].clientX-e.left,n.pa=(t.touches[0].clientY-e.top)*n.na/(e.bottom-e.top),isNaN(n.pa)&&(n.pa=0),n.Za()}},this._a=function(e){if(!n.P.song.getChannelIsDrum(n.P.channel)&&!n.ic&&n.qa){var i=n.P.history.lastChangeWas(n.Ub),s=i?n.Ub.oldValue:n.P.song.channels[n.P.channel].octave,a=n.P.song.channels[n.P.channel].octave;n.pa<n.sc-.5*n.qc?4>a&&(n.Ub=new t.ChangeOctave(n.P,s,a+1),n.P.history.record(n.Ub,i)):a>0&&(n.Ub=new t.ChangeOctave(n.P,s,a-1),n.P.history.record(n.Ub,i))}n.qa=!1,n.ic=!1,n.cb()},this.db=function(){n.sc=n.na-n.pc*n.P.song.channels[n.P.channel].octave,n.ac()},this.P.notifier.watch(this.db),this.db(),this.ha.appendChild(this.ec);for(var i=0;i<=this.oc;i++)this.ha.appendChild(t.svgElement("rect",{fill:"#886644",x:0,y:i*this.pc,width:this.Sa,height:this.nc}));this.ha.appendChild(this.fc),this.ha.appendChild(this.zb),this.ha.appendChild(this.Ab);var s=.5*this.Sa,a=20,r=9,o=6;this.zb.setAttribute("d","M "+s+" "+r+" L "+(s+o)+" "+a+" L "+(s-o)+" "+a+" z"),this.Ab.setAttribute("d","M "+s+" "+(this.na-r)+" L "+(s+o)+" "+(this.na-a)+" L "+(s-o)+" "+(this.na-a)+" z"),this.container.addEventListener("mousedown",this.Va),document.addEventListener("mousemove",this.Ya),document.addEventListener("mouseup",this._a),this.container.addEventListener("mouseover",this.Ta),this.container.addEventListener("mouseout",this.Ua),this.container.addEventListener("touchstart",this.Xa),this.container.addEventListener("touchmove",this.$a),this.container.addEventListener("touchend",this._a),this.container.addEventListener("touchcancel",this._a)}return e.prototype.Za=function(){if(!this.P.song.getChannelIsDrum(this.P.channel)){if(this.ic){for(var e=this.P.song.channels[this.P.channel].octave,n=this.P.history.lastChangeWas(this.Ub),i=n?this.Ub.oldValue:e,s=e;this.pa-this.mc<.5*-this.pc&&4>s;)s++,this.mc-=this.pc;for(;this.pa-this.mc>.5*this.pc&&s>0;)s--,this.mc+=this.pc;s!=e&&(this.Ub=new t.ChangeOctave(this.P,i,s),this.P.history.record(this.Ub,n))}this.ra&&this.cb()}},e.prototype.cb=function(){var t=this.ra&&!this.qa,e=!1,n=!1,i=!1;t&&(this.pa<this.sc-this.qc?e=!0:this.pa>this.sc?n=!0:i=!0),this.zb.style.visibility=e?"inherit":"hidden",this.Ab.style.visibility=n?"inherit":"hidden",this.fc.style.visibility=i?"inherit":"hidden"},e.prototype.ac=function(){this.ha.style.visibility=this.P.song.getChannelIsDrum(this.P.channel)?"hidden":"visible",this.rc!=this.sc&&(this.rc=this.sc,this.ec.setAttribute("y",""+(this.sc-this.qc)),this.fc.setAttribute("y",""+(this.sc-this.qc))),this.cb()},e}();t.OctaveScrollBar=e}(beepbox||(beepbox={}));var beepbox;!function(t){function e(){n++,i=!0}var n=0,i=!1,s=document.createElement("img");s.onload=e,s.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NEU3RTM2RTg0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NEU3RTM2RTk0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozMzYxN0U3RDQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozMzYxN0U3RTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PomGIaQAAABgSURBVHjaYpSWlmZhYWFmZgaSTExMQAYTGGAyIICRkRFIMhANWISFhdlggAUHANrBysoKNBfuCGKMvnjx4r59+xhp5wOg6UCSBM+SB0YtGLVgCFgAzDeMeOSGgAUAAQYAGgwJrOg8pdQAAAAASUVORK5CYII=";var a=document.createElement("img");a.onload=e,a.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NEU3RTM2RUM0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NEU3RTM2RUQ0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo0RTdFMzZFQTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo0RTdFMzZFQjQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PhURscAAAAB1SURBVHja7NPBCoAgDAZgnaMX8Oj7P2KKldXPhiR4CwwCv4PInPvxoA0hMLNzDisRYUPCCiMucVallJzzJnaBih5pp2mw936puKEZ2qQ3MeUQmLiKGGNKCZ1IQr2fDnb0C8gMNgNmwA8Cnt/0Tv91vw64BRgALUuP70jrlrwAAAAASUVORK5CYII=";var r=document.createElement("img");r.onload=e,r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzM2MTdFNzc0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzM2MTdFNzg0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozMzYxN0U3NTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozMzYxN0U3NjQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgBmMXoAAACTSURBVHja7JQ7CgMhGIT3920M2Hko7+RJPYWViE0myi5sEXAhKQL7FcP8PmawkWKMjx2llNb60MNIKY0xnPPphRDbMsJ7/xw458wAodZa6PRQ5GIF0RjlYCU655xSEqWU3ntrrdb63RcgHcq2H3MX3AV/UEAhBL7DBkTEzmAFuzSY44UC/BDHtU+8z539esFLgAEAkZ4XCDjZXPEAAAAASUVORK5CYII=";var o=document.createElement("img");o.onload=e,o.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzM2MTdFN0I0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzM2MTdFN0M0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozMzYxN0U3OTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozMzYxN0U3QTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PlZjoH4AAADHSURBVHja7JTNDoMgEIRBGq21iTcfyvd/DeNvJBYBp7uFEE+99NDE70AMMDPLYZRt2z4CeZ4XRcFrRkgphRD7vnvvX8RGdF03DEPf99M0LcuitcamMcZa6wkRuNV1/SSqqroTcC/LEu5KKQ6AEhq21oRzDl5bAME8DUjd3wHjOELPyu9fgNnneV7XNQ6OyNPsTCZ+zBVwBfxBgGyaRgViuWIt+ZIPuAAaZwh00BKxaKeuSfwhUsfI55g+WOMT2DEl3jm94BBgAAtY6T6d3wTNAAAAAElFTkSuQmCC";var h=document.createElement("img");h.onload=e,h.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAArCAIAAACW3x1gAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowMTgwMTE3NDA3MjA2ODExOUJCOEEzOUJCMkI3MTdFNCIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5NzVEOTA1QzQ5MjMxMUUxOTM3RDhDNEI4QkIxQkFCNSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5NzVEOTA1QjQ5MjMxMUUxOTM3RDhDNEI4QkIxQkFCNSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjAxODAxMTc0MDcyMDY4MTE5QkI4QTM5QkIyQjcxN0U0IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjAxODAxMTc0MDcyMDY4MTE5QkI4QTM5QkIyQjcxN0U0Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+dtFK5QAACbRJREFUeNrcV0lsG9cZnnmzcJdIcRHFRZtly5IVSVYSOcriNY7jqHHTBE2bJkCRNijQQ9re2kOBAj30kByKAm1PvQVF0RYIkLRpkiZuLMqyLVm7bGvlIpKiuHOGyww52+ubIbXYCYLk2P4ccobz3nzf+9f3D4b9rwv+5cOXL5x48crDT54b8Pr6jOZWQJoxKIi13WJ+Oziz+Z/r6x9N3AvMhb42gcWkf/P1Mz/40fkWz2iuAAsFrljkOK5crVYwTNTrcaMRNDURNhtl1Slrn9x55x+zf/5ooVIVvhLBq1ce+eXPLpt6RnZ22EIBmk1Oi8VuMFoMBgNF6RUMF2tcrVqscPlSKcGV4zaC85qNd25u/PHdm/+8tf5lBBRJ/Oan49/98cVEDmcYg9PZ09LSrjcYSRzHcAAxDGBQQfMgJiuyAiFUFMSUT23mtu9YxYxVgX/6YPa3796QZGUfk9i/Mhvo3//8W99443wwKtB0T1fXqM3m0en0iJUgSIIkKYoiKBL9A4QqAEcCSFJnbnI3uboqIpHP7D7T73WYDbfW4+IexwHB22+OX3zpsfAu5nI96vUM0gY9wqN0JEJG2AAATFs7hlABrhKgk3qJQwwCgrY4/ZiuaSceO+VvslkM11Yi9xG8+dLj33/tdDgLPB1POB09JE0RAOESFEEiVOWQaIZBPxCtX2MBUKVRMAXTWZyk2RaPRp440lIV5PngboPgZE/br16/kBJwR9dTTtdxQkejBzUOoHxO4P2CCAgcV+8iDSHUWWyA0ieDa4N++1J4N8VUVMVfvTCEm/S0vc/Z1g9IoKIjU6PHkCBvyrJ63hMJffZ+tQkyDnDVPThR18beM6zvHmky0i8/OYDAwTGvfXz0WKoCXL5BFVv1p0qgmULRMJTD0HVKWdqj1EZVS2meV+MNU1zHTmZE6tLJ7qOeFvLMQ504TRkt3SarC00j1aOBrhmksUxFu4PuNxytAqHAhZj2Bw2h6Kprgym40d5m9PXqmbXTA53gzIA/V+KaXZ3aTBSCuKrpniDMOo+yv/bGr3qCyv46VE8jDVCmIBT0t7mtK1fkn+rzgpPdrWy5arS2qloCXHMWdp8flYatZGVPm7rd7nc6psUV0BgQgsnhYbnacGcr8DltXE3UGZsxFNA4JAgcUzU/RHDoWsOFh2Pp8ES0OnX9anWAtNnK1wSf00paTIZG0UAhV19+4/uAHNCqc2Hj3n2CDCxDWRvU1FCLJuB43qijahyLiFG2wEZ5wr+gLOKac7USUX/+gVlQ1pahsdZKjEFHcxwPWIZpNus5JgUhPICqY+1B4XvAQItHrUjsDR6aiRRT9gAq2USzUccyLNhNpe0WI5uOYFrEoAPDDqHvoSJMcJ8Q+7f3J6rxIGP1hbKJsN1iQOAgtJNutZu5bKjEpmU1HNXQeABcKzsNIfeKqVbv8H0OLbCgamQIuXySS6y7rOZQIgO2M2WsxrealHRsSdEiW5Kkfez6uV47Dyg0+ANzgUbqIAfXDZBZn3eSoiJUorkyoMzW9bW1Tk+LkFtNJ1YQPApESZFAAxqAQ9jEYZK6aKPItJJaPdRPdmupGlnocDWvra4hcHCi7/jdxXtihe3yWFKx2+lsUJZESVKLxAH2F1A0wNEAsrooC5Ko5ggb38wsBbps+mqZXVxZHeg7Dvq7vYlo+c78vN9t7fSARPxmMrmuCKIgSfUqRnwxeEOQZQRBRnpDWcxur6QWPm3XcT67eX5uLrHD93V5SSOsWk2ttwMLNp9rePwiyZbC0Vs8X/R5T+gNFog41F2SOEjdevRrXhVFUS2sklTjSsmt21xw7ogZ8za3XEcyvdzS3KOXeeInlx9iC3IikqkKCZ2ROjr6kKXJVCjsRqMx9CRBGpHBkWXrW1g9nRG0pNpRRGav8Gw6thy995mhuHW81eSxmK4HpiYnrzNFU9+xXp/XQLz8aIel2RqeTZZrNVHYJYDi7u7s6OqkaaJQSEajYYbJ8xwvSgJaLDI3YuW5EsNkc7lIYmchEbtJC9tHHFS/z6GUuclrE4GJwG6BBpJ1bKy3WGXJ5WDs+WfOOX0t+UgmaqieOM1uXP2Xb/iUv+Nhv7+DYYRstlIoZLYj259rvMg2D+mwuq2ohjL81vTC8tQ0hyk7eRpyTd52W09P6/uBKXLmXuSlK7D3VM+tSAZugv7Lb3349otCOe3OxW3+oWb7gNXqwDAdhqHdX0I1BsNQ+8ZjWBXDOHQh88XY3EpoZml1ZjGdLP/ivX9cffcVtKcPDXdStHJ7bZtcjGS2Ntb7xwbDs2F2K4UX37rzMcOOQoN5RSpuNbnnjPYjlMkP6DaIm1AfpDZdQqlWSVVyMSYeTm5sJtZCHMOHd2q7O2T449+hXdPvd5wc7tpYX12OZslIEd6YWe4a7h+8PHT9D5/GVxhXEiTey2eC1aOnnINnUUuUx2vLtIGUqlKVq/FlgWf5ClstM1yF4Zk0F4zUIiGhkiLNgNxeLaDUfvzxXkAIgfmV7TJGcBJGSJUeFz36wllBlP/+6+suknQSlCGthGfyK7PpWKhcydckUYtRHBN5KZ/m4qHS+jK7OFNYmC6mNyRzlTIRSDlseT537uzApUvDk4HAX29s3C2olsUWk9K/r06jPBj94WmlJu68v4RuNpGEkzLCNJbbza98mL4qiowsj35vOLZVWL8VpnFcDwA6/AQt62FVwQSo7iVjj/WOP/fwzVs3PpicvVuAjcarJKhrawM5i8My+NoFqSxVtlKEApE1DQA4KKqd1nXrdb1Gw/jf/jL2/KPyO5+00bSVotCoorkexS9OkWPnB158eWxpbnYiEPgsrmyyh1rHGCOhztkF07SJOHrlrMnTVo3nFKaCdmgSRxs56kXU3a79lZ3NTz/JLORFXkG4yGwSVNFt7Y6nvzM2dubo7NTUxLVrEzH5Zgo+2PyGswJqarwUq0gV92ivf/wSbbFIGRayZVSP1WqM47pHbKH5TC3MCRW5TmBpt498e/TZN85RRHn6s4mF2flAVJ5Mavb6/K6K2pZvPuZ45ZK364jTfXzE2j5EQn95LsyvbJXWQ+VofDIci4vC00d9lMdlOuZ2DHndI242EgqjPJheiCdLE1vVqYSswC99wznVZ33hvOfKxQ5Ts6HJ3X0oD8xaHlQVoVCrJCq5OLMTSm5sJO4FObY6tVqcCnJrWfkrvaPpaXBxzP3sOd9zT3fYXSa9kab0lFhFVRPlAepAahUWJUEV5UE2XZ5azE6vl+YivCDDr/2WOdzfcmqkdWTINXDC4XXpzTqiWq7F42wwyKxuFO5sMneDxc0Ej/0/y38FGACBHjS0mkQ17AAAAABJRU5ErkJggg==";
var l=function(){function e(e){var n=this;this.P=e,this.tc=t.html.canvas({width:"32",height:"481",style:"width: 100%; height: 100%;"}),this.uc=t.html.canvas({width:"32",height:"40"}),this.container=t.html.div({style:"width: 32px; height: 100%; overflow:hidden; position: relative; flex-shrink: 0; touch-action: none;"},[this.tc,this.uc]),this.vc=this.tc.getContext("2d"),this.wc=this.uc.getContext("2d"),this.Sa=32,this.na=481,this.oa=0,this.pa=0,this.qa=!1,this.ra=!1,this.xc=-1,this.La=!1,this.yc=-1,this.Ta=function(t){n.ra||(n.ra=!0,n.cb())},this.Ua=function(t){n.ra&&(n.ra=!1,n.cb())},this.Va=function(t){t.preventDefault(),n.qa=!0;var e=n.tc.getBoundingClientRect();n.oa=(t.clientX||t.pageX)-e.left,n.pa=((t.clientY||t.pageY)-e.top)*n.na/(e.bottom-e.top),isNaN(n.pa)&&(n.pa=0),n.P.synth.pianoPressed=!0,n.cb()},this.Ya=function(t){var e=n.tc.getBoundingClientRect();n.oa=(t.clientX||t.pageX)-e.left,n.pa=((t.clientY||t.pageY)-e.top)*n.na/(e.bottom-e.top),isNaN(n.pa)&&(n.pa=0),n.zc(),n.P.synth.pianoPitch=n.Ac+12*n.P.song.channels[n.P.channel].octave,n.cb()},this.Nb=function(t){n.qa=!1,n.P.synth.pianoPressed=!1,n.cb()},this.Xa=function(t){t.preventDefault(),n.qa=!0;var e=n.tc.getBoundingClientRect();n.oa=t.touches[0].clientX-e.left,n.pa=(t.touches[0].clientY-e.top)*n.na/(e.bottom-e.top),isNaN(n.pa)&&(n.pa=0),n.zc(),n.P.synth.pianoPressed=!0,n.P.synth.pianoPitch=n.Ac+12*n.P.song.channels[n.P.channel].octave},this.$a=function(t){t.preventDefault();var e=n.tc.getBoundingClientRect();n.oa=t.touches[0].clientX-e.left,n.pa=(t.touches[0].clientY-e.top)*n.na/(e.bottom-e.top),isNaN(n.pa)&&(n.pa=0),n.zc(),n.P.synth.pianoPitch=n.Ac+12*n.P.song.channels[n.P.channel].octave},this._b=function(t){t.preventDefault(),n.P.synth.pianoPressed=!1},this.db=function(){var e=n.P.song.getChannelIsDrum(n.P.channel);n.fb=e?40:13,n.gb=e?t.Config.drumCount:t.Config.pitchCount,n.zc(),n.P.synth.pianoPitch=n.Ac+12*n.P.song.channels[n.P.channel].octave,n.P.synth.pianoChannel=n.P.channel,n.ac()},this.ac=function(){if(!i)return void window.requestAnimationFrame(n.ac);if(n.P.showLetters){var e=n.P.song.getChannelIsDrum(n.P.channel);if(n.xc!=n.P.song.scale||n.yc!=n.P.song.key||n.La!=e){n.xc=n.P.song.scale,n.yc=n.P.song.key,n.La=e,n.vc.clearRect(0,0,n.Sa,n.na);for(var l,c=0;c<n.gb;c++){var u=(c+t.Config.keyTransposes[n.P.song.key])%12;if(e){l=h;var p=1-c/n.gb*.35,d=.5*(1-p),g=l.width*d,b=l.height*d+n.fb*(n.gb-c-1),f=l.width*p,m=l.height*p;n.vc.drawImage(l,g,b,f,m);for(var v=1+(c-n.gb/2)/n.gb*.5,C=n.vc.getImageData(g,b,f,m),P=C.data,y=0;y<P.length;y+=4)P[y+0]*=v,P[y+1]*=v,P[y+2]*=v;n.vc.putImageData(C,g,b)}else if(t.Config.scaleFlags[n.P.song.scale][c%12]){var w=t.Config.pitchNames[u];if(null==w){var x=t.Config.blackKeyNameParents[c%12];w=t.Config.pitchNames[(u+12+x)%12],1==x?w+="♭":-1==x&&(w+="♯")}var A=t.Config.pianoScaleFlags[u]?"#000000":"#ffffff";l=t.Config.pianoScaleFlags[u]?r:s,n.vc.drawImage(l,0,n.fb*(n.gb-c-1)),n.vc.font="bold 11px sans-serif",n.vc.fillStyle=A,n.vc.fillText(w,15,n.fb*(n.gb-c)-3)}else l=t.Config.pianoScaleFlags[u]?o:a,n.vc.drawImage(l,0,n.fb*(n.gb-c-1))}n.cb()}}},this.P.notifier.watch(this.db),this.db(),this.container.addEventListener("mousedown",this.Va),document.addEventListener("mousemove",this.Ya),document.addEventListener("mouseup",this.Nb),this.container.addEventListener("mouseover",this.Ta),this.container.addEventListener("mouseout",this.Ua),this.container.addEventListener("touchstart",this.Xa),this.container.addEventListener("touchmove",this.$a),this.container.addEventListener("touchend",this._b),this.container.addEventListener("touchcancel",this._b)}return e.prototype.zc=function(){var e=t.Config.scaleFlags[this.P.song.scale],n=Math.max(0,Math.min(this.gb-1,this.gb-this.pa/this.fb));if(e[Math.floor(n)%12]||this.P.song.getChannelIsDrum(this.P.channel))this.Ac=Math.floor(n);else{for(var i=Math.floor(n)+1,s=Math.floor(n)-1;!e[i%12];)i++;for(;!e[s%12];)s--;var a=i,r=s+1;i%12!=0&&i%12!=7||(a-=.5),s%12!=0&&s%12!=7||(r+=.5),this.Ac=n-r>a-n?i:s}},e.prototype.cb=function(){this.uc.style.visibility=!this.ra||this.qa?"hidden":"visible",this.ra&&!this.qa&&(this.wc.clearRect(0,0,32,40),this.uc.style.left="0px",this.uc.style.top=this.fb*(this.gb-this.Ac-1)+"px",this.wc.lineWidth=2,this.wc.strokeStyle="#ffffff",this.wc.strokeRect(1,1,this.Sa-2,this.fb-2))},e}();t.Piano=l}(beepbox||(beepbox={}));var beepbox;!function(t){var e=t.html.button,n=t.html.div,i=t.html.span,s=t.html.input,a=t.html.br,r=t.html.text,o=function(){function o(h,l){var c=this;this.P=h,this.tb=l,this.Bc=s({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Cc=s({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Dc=s({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Ec=s({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Fc=s({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Gc=s({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.Hc=e({style:"width:45%;"},[r("Okay")]),this.Ic=e({style:"width:45%;"},[r("Cancel")]),this.container=n({className:"prompt",style:"width: 250px;"},[n({style:"font-size: 2em"},[r("Custom Song Size")]),n({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[n({style:"text-align: right;"},[r("Beats per bar:"),a(),i({style:"font-size: smaller; color: #888888;"},[r("(Multiples of 3 or 4 are recommended)")])]),this.Bc]),n({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[n({style:"display: inline-block; text-align: right;"},[r("Bars per song:"),a(),i({style:"font-size: smaller; color: #888888;"},[r("(Multiples of 2 or 4 are recommended)")])]),this.Cc]),n({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[r("Patterns per channel:"),this.Dc]),n({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[r("Instruments per channel:"),this.Ec]),n({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[r("Number of pitch channels:"),this.Fc]),n({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[r("Number of drum channels:"),this.Gc]),n({style:"display: flex; flex-direction: row; justify-content: space-between;"},[this.Hc,this.Ic])]),this.Jc=function(){c.P.undo()},this.cleanUp=function(){c.Hc.removeEventListener("click",c.Kc),c.Ic.removeEventListener("click",c.Jc),c.Bc.removeEventListener("keypress",o.Lc),c.Cc.removeEventListener("keypress",o.Lc),c.Dc.removeEventListener("keypress",o.Lc),c.Ec.removeEventListener("keypress",o.Lc),c.Fc.removeEventListener("keypress",o.Lc),c.Gc.removeEventListener("keypress",o.Lc),c.Bc.removeEventListener("blur",o.Mc),c.Cc.removeEventListener("blur",o.Mc),c.Dc.removeEventListener("blur",o.Mc),c.Ec.removeEventListener("blur",o.Mc),c.Fc.removeEventListener("blur",o.Mc),c.Gc.removeEventListener("blur",o.Mc)},this.Kc=function(){var e=new t.ChangeGroup;e.append(new t.ChangeBeatsPerBar(c.P,o.Nc(c.Bc))),e.append(new t.ChangeBarCount(c.P,o.Nc(c.Cc))),e.append(new t.ChangePatternsPerChannel(c.P,o.Nc(c.Dc))),e.append(new t.ChangeInstrumentsPerChannel(c.P,o.Nc(c.Ec))),e.append(new t.ChangeChannelCount(c.P,o.Nc(c.Fc),o.Nc(c.Gc))),c.P.prompt=null,c.P.history.record(e,!0)},this.Bc.value=this.P.song.beatsPerBar+"",this.Bc.min=t.Config.beatsPerBarMin+"",this.Bc.max=t.Config.beatsPerBarMax+"",this.Cc.value=this.P.song.barCount+"",this.Cc.min=t.Config.barCountMin+"",this.Cc.max=t.Config.barCountMax+"",this.Dc.value=this.P.song.patternsPerChannel+"",this.Dc.min=t.Config.patternsPerChannelMin+"",this.Dc.max=t.Config.patternsPerChannelMax+"",this.Ec.value=this.P.song.instrumentsPerChannel+"",this.Ec.min=t.Config.instrumentsPerChannelMin+"",this.Ec.max=t.Config.instrumentsPerChannelMax+"",this.Fc.value=this.P.song.pitchChannelCount+"",this.Fc.min=t.Config.pitchChannelCountMin+"",this.Fc.max=t.Config.pitchChannelCountMax+"",this.Gc.value=this.P.song.drumChannelCount+"",this.Gc.min=t.Config.drumChannelCountMin+"",this.Gc.max=t.Config.drumChannelCountMax+"",this.Hc.addEventListener("click",this.Kc),this.Ic.addEventListener("click",this.Jc),this.Bc.addEventListener("keypress",o.Lc),this.Cc.addEventListener("keypress",o.Lc),this.Dc.addEventListener("keypress",o.Lc),this.Ec.addEventListener("keypress",o.Lc),this.Fc.addEventListener("keypress",o.Lc),this.Gc.addEventListener("keypress",o.Lc),this.Bc.addEventListener("blur",o.Mc),this.Cc.addEventListener("blur",o.Mc),this.Dc.addEventListener("blur",o.Mc),this.Ec.addEventListener("blur",o.Mc),this.Fc.addEventListener("blur",o.Mc),this.Gc.addEventListener("blur",o.Mc)}return o.Lc=function(t){var e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(48>e||e>57)?(t.preventDefault(),!0):!1},o.Mc=function(t){var e=t.target;e.value=Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))+""},o.Nc=function(t){return Math.floor(Number(t.value))},o}();t.SongDurationPrompt=o}(beepbox||(beepbox={}));var beepbox;!function(t){function e(t,e,n){return t+n*(e-t)}function n(t,e){if(navigator.msSaveOrOpenBlob)return void navigator.msSaveOrOpenBlob(t,e);var n=document.createElement("a");if(void 0!=n.download){var i=URL.createObjectURL(t);setTimeout(function(){URL.revokeObjectURL(i)},6e4),n.href=i,n.download=e,setTimeout(function(){n.dispatchEvent(new MouseEvent("click"))},0)}else if(navigator.vendor.indexOf("Apple")>-1){var s=new FileReader;s.onloadend=function(){console.log(s.result);var t=s.result.replace(/^data:[^;]*;/,"data:attachment/file;");window.open(t,"_blank")||(window.location.href=t)},s.readAsDataURL(t)}else{var a=URL.createObjectURL(t);setTimeout(function(){URL.revokeObjectURL(a)},6e4),window.open(a,"_blank")||(window.location.href=a)}}var i=t.html.button,s=t.html.div,a=t.html.input,r=t.html.text;ArrayBuffer.transfer||(ArrayBuffer.transfer=function(t,e){function n(t,e,n,i,s){var a=Uint8Array;switch(t){case 8:a=Float64Array;break;case 4:a=Float32Array;break;case 2:a=Uint16Array;break;case 1:a=Uint8Array;break;default:a=Uint8Array}for(var r=new a(e,i,s/t|0),o=new a(n,i,s/t|0),h=0;h<o.length;h++)o[h]=r[h];return{nextOffset:r.byteOffset+r.byteLength,leftBytes:s-o.length*t}}var i=new ArrayBuffer(e);if(!(t instanceof ArrayBuffer&&i instanceof ArrayBuffer))throw new TypeError("Source and destination must be ArrayBuffer instances");for(var s=0,a=Math.min(t.byteLength,i.byteLength),r=[8,4,2,1],o=0,h=r;o<h.length;o++){var l=h[o];if(a>=l){var c=n(l,t,i,s,a);s=c.nextOffset,a=c.leftBytes}}return i});var o=function(){function o(h,l){var c=this;this.P=h,this.tb=l,this.Oc=a({type:"text",style:"width: 10em;",value:"BeepBox-Song",maxlength:250}),this.Pc=a({type:"checkbox"}),this.Qc=a({style:"width: 2em;",type:"number",min:"1",max:"4",step:"1"}),this.Rc=a({type:"checkbox"}),this.Sc=i({},[r("Export to .wav file")]),this.Tc=i({},[r("Export to .midi file")]),this.Uc=i({},[r("Export to .json file")]),this.Ic=i({},[r("Cancel")]),this.container=s({className:"prompt",style:"width: 200px;"},[s({style:"font-size: 2em"},[r("Export Options")]),s({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},[r("File name:"),this.Oc]),s({style:"display: table; width: 100%;"},[s({style:"display: table-row;"},[s({style:"display: table-cell;"},[r("Intro:")]),s({style:"display: table-cell;"},[r("Loop Count:")]),s({style:"display: table-cell;"},[r("Outro:")])]),s({style:"display: table-row;"},[s({style:"display: table-cell; vertical-align: middle;"},[this.Pc]),s({style:"display: table-cell; vertical-align: middle;"},[this.Qc]),s({style:"display: table-cell; vertical-align: middle;"},[this.Rc])])]),this.Sc,this.Tc,this.Uc,this.Ic]),this.Jc=function(){c.P.undo()},this.cleanUp=function(){c.Oc.removeEventListener("input",o.Vc),c.Qc.removeEventListener("blur",o.Mc),c.Sc.removeEventListener("click",c.Wc),c.Tc.removeEventListener("click",c.Xc),c.Uc.removeEventListener("click",c.Yc),c.Ic.removeEventListener("click",c.Jc)},this.Wc=function(){var e=new t.Synth(c.P.song);if(e.enableIntro=c.Pc.checked,e.enableOutro=c.Rc.checked,e.loopCount=Number(c.Qc.value),!e.enableIntro)for(var i=0;i<c.P.song.loopStart;i++)e.nextBar();var s=e.totalSamples,a=new Float32Array(s);e.synthesize(a,s);var r=1,o=1,h=44100,l=2,u=8*l,p=o*s,d=44+p*l,g=0,b=new ArrayBuffer(d),f=new DataView(b);f.setUint32(g,1380533830,!1),g+=4,f.setUint32(g,36+p*l,!0),g+=4,f.setUint32(g,1463899717,!1),g+=4,f.setUint32(g,1718449184,!1),g+=4,f.setUint32(g,16,!0),g+=4,f.setUint16(g,1,!0),g+=2,f.setUint16(g,o,!0),g+=2,f.setUint32(g,h,!0),g+=4,f.setUint32(g,h*l*o,!0),g+=4,f.setUint16(g,l,!0),g+=2,f.setUint16(g,u,!0),g+=2,f.setUint32(g,1684108385,!1),g+=4,f.setUint32(g,p*l,!0),g+=4;var m,v;r==o?(m=1,v=1):(m=r,v=o);var C;if(l>1)for(var P=0;s>P;P++){C=Math.floor(a[P*m]*((1<<u-1)-1));for(var y=0;v>y;y++)if(2==l)f.setInt16(g,C,!0),g+=2;else{if(4!=l)throw new Error("unsupported sample size");f.setInt32(g,C,!0),g+=4}}else for(var P=0;s>P;P++){C=Math.floor(127*a[P*m]+128);for(var y=0;v>y;y++)f.setUint8(g,C>255?255:0>C?0:C),g++}var w=new Blob([b],{type:"audio/wav"});n(w,c.Oc.value.trim()+".wav"),c.Jc()},this.Xc=function(){function i(t){d+=t,d>g.byteLength&&(g=ArrayBuffer.transfer(g,Math.max(2*g.byteLength,d)),b=new DataView(g))}function s(t){t>>>=0,i(4),b.setUint32(p,t,!1),p=d}function a(t){t>>>=0,i(3),b.setUint8(p,t>>16&255),b.setUint8(p+1,t>>8&255),b.setUint8(p+2,255&t),p=d}function r(t){t>>>=0,i(2),b.setUint16(p,t,!1),p=d}function o(t){t>>>=0,i(1),b.setUint8(p,t),p=d}function h(t,e){e=e>>>0&127|(1&t)<<7,i(1),b.setUint8(p,e),p=d}function l(t){if(t>>>=0,t>268435455)throw new Error("writeVariableLength value too big.");for(var e=!1,n=0;4>n;n++){var i=21-7*n,s=t>>>i&127;0==s&&3!=n||(e=!0),e&&h(3==n?0:1,s)}}function u(t){l(t.length);for(var e=0;e<t.length;e++){var n=t.charCodeAt(e);if(n>127)throw new Error("Trying to write unicode character as ascii.");o(n)}}var p=0,d=0,g=new ArrayBuffer(1024),b=new DataView(g),f=c.P.song,m=96,v=m/f.partsPerBeat,C=v/4,P=60,y=1e6*P,w=f.getBeatsPerMinute(),x=Math.round(y/w),A=P/(m*w),M=m*f.beatsPerBar,B=[];if(c.Pc.checked)for(var L=0;L<f.loopStart;L++)B.push(L);for(var N=0;N<Number(c.Qc.value);N++)for(var L=f.loopStart;L<f.loopStart+f.loopLength;L++)B.push(L);if(c.Rc.checked)for(var L=f.loopStart+f.loopLength;L<f.barCount;L++)B.push(L);for(var E=[{isMeta:!0,channel:-1,midiChannel:-1,isChorus:!1,isDrums:!1}],k=0,S=0;S<c.P.song.getChannelCount();S++)c.P.song.getChannelIsDrum(S)?(E.push({isMeta:!1,channel:S,midiChannel:k++,isChorus:!1,isDrums:!0}),9==k&&k++):(E.push({isMeta:!1,channel:S,midiChannel:k++,isChorus:!1,isDrums:!1}),9==k&&k++,E.push({isMeta:!1,channel:S,midiChannel:k++,isChorus:!0,isDrums:!1}),9==k&&k++);s(1297377380),s(6),r(1),r(E.length),r(m);for(var I=function(n){s(1297379947);var i=n.isMeta,g=n.channel,m=n.midiChannel,P=n.isChorus,y=n.isDrums,w=p;d+=4,p=d;var L=0,N=0,E=function(t){if(L>t)throw new Error("Midi event time cannot go backwards.");l(t-L),L=t};if(i){E(0),r(65281),u("http://www.beepbox.co/#"+f.toBase64String()),E(0),a(16732419),a(x),E(0),a(16734212),o(f.beatsPerBar),o(2),o(24),o(8);var k=f.scale<10&&1==(1&f.scale),S=11-f.key,I=S;for(1==(1&S)&&(I+=6),k&&(I+=9);I>6;)I-=12;E(0),a(16734466),o(I),o(k?1:0),c.Pc.checked&&(N+=M*f.loopStart),E(N),r(65286),u("Loop Start");for(var F=0;F<Number(c.Qc.value);F++)N+=M*f.loopLength,E(N),r(65286),u(F<Number(c.Qc.value)-1?"Loop Repeat":"Loop End");if(c.Rc.checked&&(N+=M*(f.barCount-f.loopStart-f.loopLength)),N!=M*B.length)throw new Error("Miscalculated number of bars.")}else{var D=f.getChannelIsDrum(g)?t.Config.midiDrumChannelNames[g-f.pitchChannelCount]:t.Config.midiPitchChannelNames[g];P&&(D+=" chorus"),E(0),r(65283),u(D),E(N),o(176|m),h(0,126),h(0,1),E(N),o(176|m),h(0,68),h(0,127);for(var R=-1,U=-1,T=-1,V=y?33:t.Config.keyTransposes[f.key],Y=y?t.Config.drumInterval:1,W=0,Z=B;W<Z.length;W++){var G=Z[W],z=f.getPattern(g,G);if(null!=z){var O=z.instrument;if(P&&0==f.channels[g].instruments[O].chorus){N+=M;continue}if(R!=O){if(R=O,E(N),r(65284),y){var j="noise: "+t.Config.drumNames[f.channels[g].instruments[O].wave];j+=", volume: "+t.Config.volumeNames[f.channels[g].instruments[O].volume],j+=", envelope: "+t.Config.envelopeNames[f.channels[g].instruments[O].envelope],u(j),E(N),o(192|m),h(0,126)}else{var j="wave: "+t.Config.waveNames[f.channels[g].instruments[O].wave];j+=", volume: "+t.Config.volumeNames[f.channels[g].instruments[O].volume],j+=", envelope: "+t.Config.envelopeNames[f.channels[g].instruments[O].envelope],j+=", filter: "+t.Config.filterNames[f.channels[g].instruments[O].filter],j+=", chorus: "+t.Config.chorusNames[f.channels[g].instruments[O].chorus],j+=", effect: "+t.Config.effectNames[f.channels[g].instruments[O].effect],u(j);var J=0==t.Config.filterDecays[f.channels[g].instruments[O].filter]?t.Config.midiSustainInstruments:t.Config.midiDecayInstruments;E(N),o(192|m),h(0,J[f.channels[g].instruments[O].wave])}var X=f.channels[g].instruments[O].volume,Q=(5-X)/5;E(N),o(176|m),h(0,7),h(0,Math.round(127*Q))}var H=f.channels[g].instruments[O].effect,q=t.Config.effectVibratos[H],_=t.Config.effectTremolos[H],K=.14,$=t.Config.chorusIntervals[f.channels[g].instruments[O].chorus];P||($*=-1),$+=t.Config.chorusOffsets[f.channels[g].instruments[O].chorus];for(var tt=0;tt<z.notes.length;tt++){for(var et=z.notes[tt],nt=N+et.start*v,it=nt,st=et.pins[0].volume,at=et.pins[0].interval,rt=V+et.pitches[0]*Y,ot=1;ot<et.pins.length;ot++){for(var ht=nt+et.pins[ot].time*v,lt=et.pins[ot].volume,ct=et.pins[ot].interval,ut=ht-it,pt=0;ut>pt;pt++){var dt=it+pt,gt=e(st,lt,pt/ut),bt=e(at,ct,pt/ut),ft=t.Config.chorusHarmonizes[f.channels[g].instruments[O].chorus],mt=Math.floor(pt/C)%4,vt=et.pitches[0];ft?P&&(2==et.pitches.length?vt=et.pitches[1]:3==et.pitches.length?vt=et.pitches[(mt>>1)+1]:4==et.pitches.length&&(vt=et.pitches[(3==mt?1:mt)+1])):2==et.pitches.length?vt=et.pitches[mt>>1]:3==et.pitches.length?vt=et.pitches[3==mt?1:mt]:4==et.pitches.length&&(vt=et.pitches[mt]);var Ct=V+vt*Y+bt+$;vt=Math.round(Ct);var Pt=Ct-vt,yt=Math.sin(2*Math.PI*(dt-N)*A/K);(2!=H||dt-nt>=3*v)&&(Pt+=q*yt);var wt=Math.max(0,Math.min(16383,Math.round(8192+4096*Pt))),xt=gt/3,At=1+_*(yt-1),Mt=Math.round(127*xt*At);wt!=U&&(E(dt),o(224|m),h(0,127&wt),h(0,wt>>7&127),U=wt),Mt!=T&&(E(dt),o(176|m),h(0,11),h(0,Mt),T=Mt),dt==nt?(E(dt),o(144|m),h(0,vt),h(0,64)):vt!=rt&&(E(dt),o(144|m),h(0,vt),h(0,64),E(dt),o(128|m),h(0,rt),h(0,64)),rt=vt}it=ht,st=lt,at=ct}E(N+et.end*v),o(128|m),h(0,rt),h(0,64)}}N+=M}}E(N),a(16723712),b.setUint32(w,p-w-4,!1)},F=0,D=E;F<D.length;F++){var R=D[F];I(R)}g=ArrayBuffer.transfer(g,d);var U=new Blob([g],{type:"audio/midi"});n(U,c.Oc.value.trim()+".midi"),c.Jc()},this.Yc=function(){var t=c.P.song.toJsonObject(c.Pc.checked,Number(c.Qc.value),c.Rc.checked),e=JSON.stringify(t,null,"	"),i=new Blob([e],{type:"application/json"});n(i,c.Oc.value.trim()+".json"),c.Jc()},this.Qc.value="1",0==this.P.song.loopStart?(this.Pc.checked=!1,this.Pc.disabled=!0):(this.Pc.checked=!0,this.Pc.disabled=!1),this.P.song.loopStart+this.P.song.loopLength==this.P.song.barCount?(this.Rc.checked=!1,this.Rc.disabled=!0):(this.Rc.checked=!0,this.Rc.disabled=!1),this.Oc.addEventListener("input",o.Vc),this.Qc.addEventListener("blur",o.Mc),this.Sc.addEventListener("click",this.Wc),this.Tc.addEventListener("click",this.Xc),this.Uc.addEventListener("click",this.Yc),this.Ic.addEventListener("click",this.Jc)}return o.Vc=function(t){var e=t.target,n=/[\+\*\$\?\|\{\}\\\/<>#%!`&'"=:@]/gi;if(n.test(e.value)){var i=e.selectionStart;e.value=e.value.replace(n,""),i--,e.setSelectionRange(i,i)}},o.Mc=function(t){var e=t.target;e.value=Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))+""},o}();t.ExportPrompt=o}(beepbox||(beepbox={}));var beepbox;!function(t){var e=t.html.button,n=t.html.div,i=t.html.input,s=t.html.text,a=function(){function a(a,r){var o=this;this.P=a,this.tb=r,this.Zc=i({type:"file",accept:".json,application/json"}),this.Ic=e({},[s("Cancel")]),this.container=n({className:"prompt",style:"width: 200px;"},[n({style:"font-size: 2em"},[s("Import")]),n(void 0,[s("BeepBox songs can be exported and re-imported as .json files. You could also use other means to make .json files for BeepBox as long as they follow the same structure.")]),this.Zc,this.Ic]),this.Jc=function(){o.P.undo()},this.cleanUp=function(){o.Zc.removeEventListener("change",o.$c),o.Ic.removeEventListener("click",o.Jc)},this.$c=function(){var e=o.Zc.files[0];if(e){var n=new FileReader;n.addEventListener("load",function(e){o.P.prompt=null,o.P.history.record(new t.ChangeSong(o.P,n.result),!0)}),n.readAsText(e)}},this.Zc.addEventListener("change",this.$c),this.Ic.addEventListener("click",this.Jc)}return a}();t.ImportPrompt=a}(beepbox||(beepbox={}));var beepbox;!function(t){function e(t,e){for(var n=0,i=e;n<i.length;n++){var s=i[n];t.appendChild(h(s,s,!1,!1))}return t}function n(t,e){t.selectedIndex!=e&&(t.selectedIndex=e)}function i(){document.hidden||(d.synth.play(),g.updatePlayButton(),window.removeEventListener("visibilitychange",i))}var s=t.html.button,a=t.html.div,r=t.html.span,o=t.html.select,h=t.html.option,l=t.html.input,c=t.html.text,u=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent),p=function(){function i(i){var p=this;this.P=i,this.prompt=null,this._c=new t.PatternEditor(this.P),this.ad=new t.TrackEditor(this.P,this),this.bd=new t.LoopEditor(this.P),this.cc=a({className:"trackContainer"},[this.ad.container,this.bd.container]),this.cd=new t.BarScrollBar(this.P,this.cc),this.dd=new t.OctaveScrollBar(this.P),this.ed=new t.Piano(this.P),this.fd=a({},[a({className:"editorBox",style:"height: 481px; display: flex; flex-direction: row; margin-bottom: 6px;"},[this.ed.container,this._c.container,this.dd.container]),this.cc,this.cd.container]),this.gd=s({style:"width: 80px;",type:"button"}),this.hd=s({className:"prevBarButton",style:"width: 40px;",type:"button",title:"Previous Bar (left bracket)"}),this.jd=s({className:"nextBarButton",style:"width: 40px;",type:"button",title:"Next Bar (right bracket)"}),this.kd=l({title:"main volume",style:"width: 5em; flex-grow: 1; margin: 0px;",type:"range",min:"0",max:"100",value:"50",step:"1"}),this.ld=o({style:"width:100%;"},[h("","Edit",!0,!0),h("undo","Undo (Z)",!1,!1),h("redo","Redo (Y)",!1,!1),h("copy","Copy Pattern (C)",!1,!1),h("paste","Paste Pattern (V)",!1,!1),h("transposeUp","Shift Notes Up (+)",!1,!1),h("transposeDown","Shift Notes Down (-)",!1,!1),h("duration","Custom song size...",!1,!1),h("import","Import JSON...",!1,!1)]),this.md=o({style:"width:100%;"},[h("","Preferences",!0,!0),h("autoPlay","Auto Play On Load",!1,!1),h("autoFollow","Auto Follow Track",!1,!1),h("showLetters","Show Piano",!1,!1),h("showFifth","Highlight 'Fifth' Notes",!1,!1),h("showChannels","Show All Channels",!1,!1),h("showScrollBar","Octave Scroll Bar",!1,!1)]),this.nd=s({type:"button"},[c("New"),r({className:"fullWidthOnly"},[c(" Song")]),t.svgElement("svg",{style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-5 -21 26 26"},[t.svgElement("path",{d:"M 2 0 L 2 -16 L 10 -16 L 14 -12 L 14 0 z M 3 -1 L 13 -1 L 13 -11 L 9 -11 L 9 -15 L 3 -15 z",fill:"currentColor"})])]),this.od=s({type:"button"},[c("Export"),t.svgElement("svg",{style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-13 -13 26 26"},[t.svgElement("path",{d:"M -8 3 L -8 8 L 8 8 L 8 3 L 6 3 L 6 6 L -6 6 L -6 3 z M 0 2 L -4 -2 L -1 -2 L -1 -8 L 1 -8 L 1 -2 L 4 -2 z",fill:"currentColor"})])]),this.pd=e(o({}),t.Config.scaleNames),this.qd=e(o({}),t.Config.keyNames),this.rd=l({style:"margin: 0px;",type:"range",min:"0",max:t.Config.tempoSteps-1,value:"7",step:"1"}),this.sd=l({style:"margin: 0px;",type:"range",min:"0",max:t.Config.reverbRange-1,value:"0",step:"1"}),this.td=e(o({}),t.Config.partNames),this.ud=o({}),this.vd=a({className:"selectRow",style:"display: none;"},[r({},[c("Instrument: ")]),a({className:"selectContainer"},[this.ud])]),this.wd=a({style:"margin: 3px 0; text-align: center; color: #999;"},[c("Instrument Settings")]),this.xd=l({style:"margin: 0px;",type:"range",min:"-5",max:"0",value:"0",step:"1"}),this.yd=e(o({}),t.Config.waveNames),this.zd=e(o({}),t.Config.drumNames),this.Ad=e(o({}),t.Config.envelopeNames),this.Bd=e(o({}),t.Config.filterNames),this.Cd=a({className:"selectRow"},[r({},[c("Filter: ")]),a({className:"selectContainer"},[this.Bd])]),this.Dd=e(o({}),t.Config.chorusNames),this.Ed=a({className:"selectRow"},[r({},[c("Chorus: ")]),a({className:"selectContainer"},[this.Dd])]),this.Fd=e(o({}),t.Config.effectNames),this.Gd=a({className:"selectRow"},[r({},[c("Effect: ")]),a({className:"selectContainer"},[this.Fd])]),this.Hd=a({},[this.vd,a({className:"selectRow"},[r({},[c("Volume: ")]),this.xd]),a({className:"selectRow"},[r({},[c("Wave: ")]),a({className:"selectContainer"},[this.yd,this.zd])]),a({className:"selectRow"},[r({},[c("Envelope: ")]),a({className:"selectContainer"},[this.Ad])]),this.Cd,this.Ed,this.Gd]),this.Id=a({className:"promptContainer",style:"display: none;"}),this.mainLayer=a({className:"beepboxEditor",tabIndex:"0"},[this.fd,a({className:"editor-widget-column"},[a({style:"text-align: center; color: #999;"},[c("BeepBox 2.2.2")]),a({className:"editor-widgets"},[a({className:"editor-controls"},[a({className:"playback-controls"},[a({className:"playback-bar-controls"},[this.gd,this.hd,this.jd]),a({className:"playback-volume-controls"},[t.svgElement("svg",{style:"flex-shrink: 0;",width:"2em",height:"2em",viewBox:"0 0 26 26"},[t.svgElement("path",{d:"M 4 17 L 4 9 L 8 9 L 12 5 L 12 21 L 8 17 z",fill:"#777"}),t.svgElement("path",{d:"M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z",fill:"#777"}),t.svgElement("path",{d:"M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z",fill:"#777"})]),this.kd])]),a({className:"editor-menus"},[this.nd,a({className:"selectContainer menu"},[this.ld,t.svgElement("svg",{style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-5 -21 26 26"},[t.svgElement("path",{d:"M 0 0 L 1 -4 L 4 -1 z M 2 -5 L 10 -13 L 13 -10 L 5 -2 zM 11 -14 L 13 -16 L 14 -16 L 16 -14 L 16 -13 L 14 -11 z",fill:"currentColor"})])]),a({className:"selectContainer menu"},[this.md,t.svgElement("svg",{style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-13 -13 26 26"},[t.svgElement("path",{d:"M 5.85 -1.34 L 7.85 -1.34 L 7.85 1.34 L 5.85 1.34 L 4.69 3.74 L 5.94 5.3 L 3.85 6.97 L 2.6 5.41 L 0 6 L -0.45 7.95 L -3.05 7.36 L -2.6 5.41 L -4.69 3.74 L -6.49 4.61 L -7.65 2.2 L -5.85 1.34 L -5.85 -1.34 L -7.65 -2.2 L -6.49 -4.61 L -4.69 -3.74 L -2.6 -5.41 L -3.05 -7.36 L -0.45 -7.95 L -0 -6 L 2.6 -5.41 L 3.85 -6.97 L 5.94 -5.3 L 4.69 -3.74 M 2.92 0.67 L 2.92 -0.67 L 2.35 -1.87 L 1.3 -2.7 L 0 -3 L -1.3 -2.7 L -2.35 -1.87 L -2.92 -0.67 L -2.92 0.67 L -2.35 1.87 L -1.3 2.7 L -0 3 L 1.3 2.7 L 2.35 1.87 z",fill:"currentColor"})])]),this.od])]),a({className:"fullWidthOnly",style:"flex: 0 1 10px;"}),a({className:"editor-settings"},[a({className:"editor-song-settings"},[a({style:"margin: 3px 0; text-align: center; color: #999;"},[c("Song Settings")]),a({className:"selectRow"},[r({},[c("Scale: ")]),a({className:"selectContainer"},[this.pd])]),a({className:"selectRow"},[r({},[c("Key: ")]),a({className:"selectContainer"},[this.qd])]),a({className:"selectRow"},[r({},[c("Tempo: ")]),this.rd]),a({className:"selectRow"},[r({},[c("Reverb: ")]),this.sd]),a({className:"selectRow"},[r({},[c("Rhythm: ")]),a({className:"selectContainer"},[this.td])])]),a({className:"editor-instrument-settings"},[this.wd,this.Hd])])])]),this.Id]),this.Jd=null,this.Kd=null,this.Ld=null,this.Md=null,this.Nd=function(t){p.mainLayer.focus()},this.whenUpdated=function(){var i=p.cc.getBoundingClientRect();p.P.trackVisibleBars=Math.floor((i.right-i.left)/32),p.cd.render(),p.ad.render();for(var s=[(p.P.autoPlay?"✓ ":"")+"Auto Play On Load",(p.P.autoFollow?"✓ ":"")+"Auto Follow Track",(p.P.showLetters?"✓ ":"")+"Show Piano",(p.P.showFifth?"✓ ":"")+"Highlight 'Fifth' Notes",(p.P.showChannels?"✓ ":"")+"Show All Channels",(p.P.showScrollBar?"✓ ":"")+"Octave Scroll Bar"],a=0;a<s.length;a++){var r=p.md.children[a+1];r.innerText!=s[a]&&(r.innerText=s[a])}n(p.pd,p.P.song.scale),n(p.qd,p.P.song.key),p.rd.value=""+p.P.song.tempo,p.rd.title=p.P.song.getBeatsPerMinute()+" beats per minute",p.sd.value=""+p.P.song.reverb,n(p.td,t.Config.partCounts.indexOf(p.P.song.partsPerBeat)),p.P.song.getChannelIsDrum(p.P.channel)?(p.Cd.style.visibility="hidden",p.Ed.style.visibility="hidden",p.Gd.style.visibility="hidden",p.yd.style.display="none",p.zd.style.display="block"):(p.Cd.style.visibility="visible",p.Ed.style.visibility="visible",p.Gd.style.visibility="visible",p.yd.style.display="block",p.zd.style.display="none");var o=p.P.getCurrentPattern();if(p.vd.style.display=p.P.song.instrumentsPerChannel>1?"flex":"none",p.vd.style.visibility=null!=o?"visible":"hidden",p.ud.children.length!=p.P.song.instrumentsPerChannel){for(;p.ud.firstChild;)p.ud.removeChild(p.ud.firstChild);for(var h=[],a=0;a<p.P.song.instrumentsPerChannel;a++)h.push(a+1);e(p.ud,h)}p.Hd.style.color=p.P.song.getNoteColorBright(p.P.channel);var l=p.P.getCurrentInstrument();n(p.yd,p.P.song.channels[p.P.channel].instruments[l].wave),n(p.zd,p.P.song.channels[p.P.channel].instruments[l].wave),n(p.Bd,p.P.song.channels[p.P.channel].instruments[l].filter),n(p.Ad,p.P.song.channels[p.P.channel].instruments[l].envelope),n(p.Fd,p.P.song.channels[p.P.channel].instruments[l].effect),n(p.Dd,p.P.song.channels[p.P.channel].instruments[l].chorus),p.xd.value=-p.P.song.channels[p.P.channel].instruments[l].volume+"",n(p.ud,l),p.ed.container.style.display=p.P.showLetters?"block":"none",p.dd.container.style.display=p.P.showScrollBar?"block":"none",p.cd.container.style.display=p.P.song.barCount>p.P.trackVisibleBars?"":"none";var c=512;p.P.showLetters&&(c-=32),p.P.showScrollBar&&(c-=20),p._c.container.style.width=String(c)+"px",p.kd.value=String(p.P.volume),p.Od(p.P.prompt),p.P.autoFollow&&!p.P.synth.playing&&p.P.synth.snapToBar(p.P.bar)},this.Pd=function(e){if(p.prompt)return void(27==e.keyCode&&window.history.back());switch(p.ad.onKeyPressed(e),e.keyCode){case 32:p.Qd(),e.preventDefault();break;case 90:e.shiftKey?p.P.redo():p.P.undo(),e.preventDefault();break;case 89:p.P.redo(),e.preventDefault();break;case 67:p.Rd(),e.preventDefault();break;case 86:p.Sd(),e.preventDefault();break;case 219:p.P.synth.prevBar(),p.P.autoFollow&&new t.ChangeChannelBar(p.P,p.P.channel,Math.floor(p.P.synth.playhead)),e.preventDefault();break;case 221:p.P.synth.nextBar(),p.P.autoFollow&&new t.ChangeChannelBar(p.P,p.P.channel,Math.floor(p.P.synth.playhead)),e.preventDefault();break;case 189:case 173:p.Td(!1),e.preventDefault();break;case 187:case 61:p.Td(!0),e.preventDefault()}},this.Ud=function(){p.P.synth.prevBar()},this.Vd=function(){p.P.synth.nextBar()},this.Qd=function(){p.P.synth.playing?p.Wd():p.Xd()},this.Yd=function(){p.P.setVolume(Number(p.kd.value))},this.Zd=function(){p.P.history.record(new t.ChangeSong(p.P,"")),p._c.resetCopiedPins()},this.$d=function(){p._d("export")},this.ae=function(){p.P.history.record(new t.ChangeScale(p.P,p.pd.selectedIndex))},this.be=function(){p.P.history.record(new t.ChangeKey(p.P,p.qd.selectedIndex))},this.ce=function(){var e=p.P.history.lastChangeWas(p.Kd),n=e?p.Kd.oldValue:p.P.song.tempo;p.Kd=new t.ChangeTempo(p.P,n,parseInt(p.rd.value)),p.P.history.record(p.Kd,e)},this.de=function(){var e=p.P.history.lastChangeWas(p.Ld),n=e?p.Ld.oldValue:p.P.song.reverb;p.Ld=new t.ChangeReverb(p.P,n,parseInt(p.sd.value)),p.P.history.record(p.Ld,e)},this.ee=function(){p.P.history.record(new t.ChangePartsPerBeat(p.P,t.Config.partCounts[p.td.selectedIndex]));
},this.fe=function(){p.P.history.record(new t.ChangeWave(p.P,p.yd.selectedIndex))},this.ge=function(){p.P.history.record(new t.ChangeWave(p.P,p.zd.selectedIndex))},this.he=function(){p.P.history.record(new t.ChangeFilter(p.P,p.Bd.selectedIndex))},this.ie=function(){p.P.history.record(new t.ChangeEnvelope(p.P,p.Ad.selectedIndex))},this.je=function(){p.P.history.record(new t.ChangeEffect(p.P,p.Fd.selectedIndex))},this.ke=function(){p.P.history.record(new t.ChangeChorus(p.P,p.Dd.selectedIndex))},this.le=function(){var e=p.P.history.lastChangeWas(p.Md),n=e?p.Md.oldValue:p.P.song.channels[p.P.channel].instruments[p.P.getCurrentInstrument()].volume;p.Md=new t.ChangeVolume(p.P,n,-parseInt(p.xd.value)),p.P.history.record(p.Md,e)},this.me=function(){var e=p.P.getCurrentPattern();null!=e&&p.P.history.record(new t.ChangePatternInstrument(p.P,p.ud.selectedIndex,e))},this.ne=function(t){switch(p.ld.value){case"undo":p.P.undo();break;case"redo":p.P.redo();break;case"copy":p.Rd();break;case"paste":p.Sd();break;case"transposeUp":p.Td(!0);break;case"transposeDown":p.Td(!1);break;case"import":p._d("import");break;case"duration":p._d("duration")}p.ld.selectedIndex=0},this.oe=function(t){switch(p.md.value){case"autoPlay":p.P.autoPlay=!p.P.autoPlay;break;case"autoFollow":p.P.autoFollow=!p.P.autoFollow;break;case"showLetters":p.P.showLetters=!p.P.showLetters;break;case"showFifth":p.P.showFifth=!p.P.showFifth;break;case"showChannels":p.P.showChannels=!p.P.showChannels;break;case"showScrollBar":p.P.showScrollBar=!p.P.showScrollBar}p.md.selectedIndex=0,p.P.notifier.changed(),p.P.savePreferences()},this.P.notifier.watch(this.whenUpdated),this.ld.addEventListener("change",this.ne),this.md.addEventListener("change",this.oe),this.pd.addEventListener("change",this.ae),this.qd.addEventListener("change",this.be),this.rd.addEventListener("input",this.ce),this.sd.addEventListener("input",this.de),this.td.addEventListener("change",this.ee),this.ud.addEventListener("change",this.me),this.xd.addEventListener("input",this.le),this.yd.addEventListener("change",this.fe),this.zd.addEventListener("change",this.ge),this.Ad.addEventListener("change",this.ie),this.Bd.addEventListener("change",this.he),this.Dd.addEventListener("change",this.ke),this.Fd.addEventListener("change",this.je),this.gd.addEventListener("click",this.Qd),this.hd.addEventListener("click",this.Ud),this.jd.addEventListener("click",this.Vd),this.nd.addEventListener("click",this.Zd),this.od.addEventListener("click",this.$d),this.kd.addEventListener("input",this.Yd),this.fd.addEventListener("mousedown",this.Nd),this.mainLayer.addEventListener("keydown",this.Pd),u&&(this.md.children[1].disabled=!0)}return i.prototype._d=function(t){this.P.openPrompt(t),this.Od(t)},i.prototype.Od=function(e){if(this.prompt&&(this.pe&&this.Xd(),this.pe=!1,this.Id.style.display="none",this.Id.removeChild(this.prompt.container),this.prompt.cleanUp(),this.prompt=null,this.mainLayer.focus()),e){switch(e){case"export":this.prompt=new t.ExportPrompt(this.P,this);break;case"import":this.prompt=new t.ImportPrompt(this.P,this);break;case"duration":this.prompt=new t.SongDurationPrompt(this.P,this)}this.prompt&&(this.pe=this.P.synth.playing,this.Wd(),this.Id.style.display=null,this.Id.appendChild(this.prompt.container))}},i.prototype.updatePlayButton=function(){this.P.synth.playing?(this.gd.classList.remove("playButton"),this.gd.classList.add("pauseButton"),this.gd.title="Pause (Space)",this.gd.innerText="Pause"):(this.gd.classList.remove("pauseButton"),this.gd.classList.add("playButton"),this.gd.title="Play (Space)",this.gd.innerText="Play")},i.prototype.Xd=function(){this.P.synth.play(),this.updatePlayButton()},i.prototype.Wd=function(){this.P.synth.pause(),this.P.autoFollow?this.P.synth.snapToBar(this.P.bar):this.P.synth.snapToBar(),this.updatePlayButton()},i.prototype.Rd=function(){var t=this.P.getCurrentPattern();if(null!=t){var e={notes:t.notes,beatsPerBar:this.P.song.beatsPerBar,partsPerBeat:this.P.song.partsPerBeat,drums:this.P.song.getChannelIsDrum(this.P.channel)};window.localStorage.setItem("patternCopy",JSON.stringify(e))}},i.prototype.Sd=function(){var e=this.P.getCurrentPattern();if(null!=e){var n=JSON.parse(String(window.localStorage.getItem("patternCopy")));null!=n&&n.drums==this.P.song.getChannelIsDrum(this.P.channel)&&this.P.history.record(new t.ChangePaste(this.P,e,n.notes,n.beatsPerBar,n.partsPerBeat))}},i.prototype.Td=function(e){var n=this.P.getCurrentPattern();if(null!=n){var i=this.P.history.lastChangeWas(this.Jd);this.Jd=new t.ChangeTranspose(this.P,n,e),this.P.history.record(this.Jd,i)}},i}();t.SongEditor=p;var d=new t.SongDocument(location.hash),g=new p(d),b=document.getElementById("beepboxEditorContainer");b.appendChild(g.mainLayer),g.whenUpdated(),g.mainLayer.focus(),!u&&d.autoPlay&&(document.hidden?window.addEventListener("visibilitychange",i):i()),g.updatePlayButton()}(beepbox||(beepbox={}));
	</script>
</body></html>
